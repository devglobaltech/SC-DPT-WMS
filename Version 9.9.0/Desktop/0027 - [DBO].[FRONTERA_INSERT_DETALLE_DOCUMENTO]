
ALTER PROCEDURE [DBO].[FRONTERA_INSERT_DETALLE_DOCUMENTO]
@pDOC_EXT		VARCHAR(100)	OUTPUT,
@pDOCUMENTO_ID	NUMERIC(20,0)	OUTPUT
AS
BEGIN
	/*	NOTAS 04/04/2016:
		ESTE PROCESO EN LA APLICACION ESTABA TARDANDO MUCHO PARA PEDIDOS GRANDES.
		SE PASA A LA BASE DE DATOS, SE CREA MASIVAMENTE EL PEDIDO PARA QUE NO
		HAYA DEMORAS POR PROCESAMIENTO Y POR TRAFICO YA QUE ESTO ESTA DENTRO DE LA
		TRANSACCION. UN ANALISIS PRELIMINAR ME DIO QUE ESTO TARDABA EN UN PEDIDO DE 
		700 PRODUCTOS, UN TIEMPO DE CASI 3 MINUTOS.
		LA CONSULTA ESTA ANALIZADA Y LA MISMA TIENE UNA BUENA PERFORMANCE.
	*/

	INSERT INTO DET_DOCUMENTO(	DOCUMENTO_ID, NRO_LINEA, CLIENTE_ID, PRODUCTO_ID, CANTIDAD, TIE_IN, UNIDAD_ID,
								DESCRIPCION, CANT_SOLICITADA, NRO_LOTE, NRO_PARTIDA, CAT_LOG_ID, EST_MERC_ID)						
	SELECT	@pDOCUMENTO_ID						DOCUMENTO_ID,
			ROW_NUMBER() 
			OVER(ORDER BY SDD.PRODUCTO_ID DESC)	NRO_LINEA,
			SDD.CLIENTE_ID						CLIENTE_ID,
			SDD.PRODUCTO_ID						PRODUCTO_ID,
			SUM(SDD.CANTIDAD_SOLICITADA)		CANTIDAD,
			'0'									TIE_IN,
			SDD.UNIDAD_ID						UNIDAD_ID,
			SDD.DESCRIPCION						DESCRIPCION,
			SUM(SDD.CANTIDAD_SOLICITADA)		CANTIDAD_SOLICITADA,
			SDD.NRO_LOTE						NRO_LOTE,
			SDD.NRO_PARTIDA						NRO_PARTIDA,
			CASE LTRIM(SDD.CAT_LOG_ID) WHEN '' THEN NULL ELSE LTRIM(SDD.CAT_LOG_ID) END CAT_LOG_ID,
			CASE LTRIM(SDD.EST_MERC_ID) WHEN '' THEN NULL ELSE LTRIM(SDD.EST_MERC_ID) END	EST_MERC_ID
	FROM	SYS_INT_DET_DOCUMENTO SDD
	WHERE	SDD.DOC_EXT=@pDOC_EXT
	GROUP BY
			SDD.CLIENTE_ID, SDD.PRODUCTO_ID, SDD.UNIDAD_ID,SDD.DESCRIPCION,SDD.NRO_LOTE,
			SDD.NRO_PARTIDA,SDD.CAT_LOG_ID, SDD.EST_MERC_ID
			
	IF @@ROWCOUNT > 0 BEGIN
		
		UPDATE DOCUMENTO SET STATUS='D10' WHERE DOCUMENTO_ID=@pDOCUMENTO_ID
					
	END		
END
GO