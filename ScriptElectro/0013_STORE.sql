USE [WMS_ELECTRO_906_MATCH]
GO

/*
Script created by Quest Change Director for SQL Server at 16/04/2013 04:17 p.m.
Please back up your database before running this script
*/

PRINT N'Synchronizing objects from DESARROLLO_906 to WMS_ELECTRO_906_MATCH'
GO

IF @@TRANCOUNT > 0 COMMIT TRANSACTION
GO

SET NUMERIC_ROUNDABORT OFF
SET ANSI_PADDING, ANSI_NULLS, ANSI_WARNINGS, CONCAT_NULL_YIELDS_NULL, ARITHABORT, QUOTED_IDENTIFIER ON
GO

IF EXISTS (SELECT * FROM tempdb..sysobjects WHERE id=OBJECT_ID('tempdb..#tmpErrors')) DROP TABLE #tmpErrors
GO

CREATE TABLE #tmpErrors (Error int)
GO

SET XACT_ABORT OFF
SET TRANSACTION ISOLATION LEVEL SERIALIZABLE
GO

BEGIN TRANSACTION
GO

SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE dbo.MOB_GET_CATLOG_XUBIC
@POS_COD varchar(100),
@CLIENTE_ID VARCHAR(100),
@PRODUCTO_ID VARCHAR(100)
AS

/*
set @POS_COD = 'BA-10-F-1-0'
SET @CLIENTE_ID = '1'
SET @PRODUCTO_ID = '100250'
*/
SELECT X.*
			FROM
				(
					SELECT RL.CAT_LOG_ID, SUM(RL.CANTIDAD) AS CANTIDAD_TOTAL
					FROM RL_DET_DOC_TRANS_POSICION RL INNER JOIN
				        POSICION P ON RL.POSICION_ACTUAL = P.POSICION_ID INNER JOIN
				        DET_DOCUMENTO_TRANSACCION DDT ON RL.DOC_TRANS_ID = DDT.DOC_TRANS_ID AND 
				        RL.NRO_LINEA_TRANS = DDT.NRO_LINEA_TRANS INNER JOIN
				        DOCUMENTO_TRANSACCION DT ON DDT.DOC_TRANS_ID = DT.DOC_TRANS_ID INNER JOIN
				        DET_DOCUMENTO DD ON DDT.DOCUMENTO_ID = DD.DOCUMENTO_ID AND DDT.NRO_LINEA_DOC = DD.NRO_LINEA
					WHERE     
						  P.POSICION_COD=UPPER(LTRIM(RTRIM(@POS_COD)))
						  AND DD.CLIENTE_ID = @CLIENTE_ID
						  AND DD.PRODUCTO_ID = @PRODUCTO_ID
					GROUP BY RL.CAT_LOG_ID
			
			
					UNION ALL
			
					SELECT 	RL.CAT_LOG_ID, SUM(RL.CANTIDAD) AS CANTIDAD_TOTAL
					FROM 	RL_DET_DOC_TRANS_POSICION RL 
							INNER JOIN NAVE N
							ON(RL.NAVE_ACTUAL=N.NAVE_ID)
							INNER JOIN DET_DOCUMENTO_TRANSACCION DDT
							ON(RL.DOC_TRANS_ID=DDT.DOC_TRANS_ID AND RL.NRO_LINEA_TRANS =DDT.NRO_LINEA_TRANS)
							INNER JOIN DET_DOCUMENTO DD 
							ON(DDT.DOCUMENTO_ID=DD.DOCUMENTO_ID AND DDT.NRO_LINEA_DOC = DD.NRO_LINEA)
					WHERE     
						  	N.NAVE_COD=UPPER(LTRIM(RTRIM(@POS_COD)))
						  	AND DD.CLIENTE_ID = @CLIENTE_ID
							AND DD.PRODUCTO_ID = @PRODUCTO_ID
					GROUP BY RL.CAT_LOG_ID
				)AS X
GO

IF @@ERROR <> 0
BEGIN
   IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION
   INSERT INTO #tmpErrors (Error) SELECT 1
   BEGIN TRANSACTION
END
GO

SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[Mob_Guardado_Ing_Detalle]
	@Cod_Producto	Varchar(30),
	@Cliente_Id		Varchar(15),
	@Documento_Id	Numeric(20,0),
	@Cantidad		Numeric(20,5)
AS
BEGIN
	SET NOCOUNT ON
	SET XACT_ABORT ON
	DECLARE @Descripcion Varchar(200)
	DECLARE @Unidad_Id Varchar(5)
	DECLARE @Cat_Logica_Id Varchar(50)
	DECLARE @COUNT AS INT
	DECLARE @NRO_LINEA NUMERIC(10,0)
	DECLARE @NROLINEADOC NUMERIC(10,0)
	DECLARE @CANTIDADDOC NUMERIC(20,5)
	DECLARE @VBEGINDELETE CHAR(1)
	DECLARE @CANTIDAD_TOTAL NUMERIC(20,5) 
	
	
	SET @NRO_LINEA = 1
		
		
	
	SELECT @Descripcion = P.DESCRIPCION, @Unidad_Id =UM.UNIDAD_ID,
			@Cat_Logica_Id =CL.CAT_LOG_ID 
		FROM RL_PRODUCTO_CATLOG RLC INNER JOIN CATEGORIA_LOGICA CL
			ON RLC.CAT_LOG_ID=CL.CAT_LOG_ID
		INNER JOIN PRODUCTO P ON RLC.PRODUCTO_ID = P.PRODUCTO_ID
		AND P.CLIENTE_ID = RLC.CLIENTE_ID
		INNER JOIN UNIDAD_MEDIDA UM ON P.UNIDAD_ID = UM.UNIDAD_ID
	    WHERE RLC.CLIENTE_ID = @Cliente_Id and RLC.PRODUCTO_ID = @Cod_Producto

	IF @Descripcion IS NULL 
	BEGIN
	SELECT @Descripcion = P.DESCRIPCION, @Unidad_Id= UM.UNIDAD_ID,@Cat_Logica_Id=C.CAT_LOG_ID
		FROM PRODUCTO P INNER JOIN UNIDAD_MEDIDA UM 
		ON P.UNIDAD_ID = UM.UNIDAD_ID
		INNER JOIN CATEGORIA_LOGICA C ON
		P.ING_CAT_LOG_ID = C.CAT_LOG_ID
		AND P.CLIENTE_ID = C.CLIENTE_ID
		WHERE P.PRODUCTO_ID=@Cod_Producto AND P.CLIENTE_ID=@Cliente_Id
	
	END
	
	SELECT @COUNT=COUNT(*)
	FROM DET_DOCUMENTO WHERE DOCUMENTO_ID=@Documento_Id
	
	IF @COUNT>0 
	BEGIN
		SELECT @NRO_LINEA = NRO_LINEA +1 
		FROM DET_DOCUMENTO WHERE DOCUMENTO_ID=@Documento_Id
		
		INSERT INTO DET_DOCUMENTO(DOCUMENTO_ID,NRO_LINEA,CLIENTE_ID,PRODUCTO_ID,CANTIDAD,NRO_SERIE,
				NRO_SERIE_PADRE,EST_MERC_ID,CAT_LOG_ID,NRO_BULTO,DESCRIPCION,NRO_LOTE,FECHA_VENCIMIENTO,
				NRO_DESPACHO,NRO_PARTIDA,UNIDAD_ID,PESO,UNIDAD_PESO,VOLUMEN,UNIDAD_VOLUMEN,BUSC_INDIVIDUAL,
				TIE_IN,NRO_TIE_IN_PADRE,NRO_TIE_IN,ITEM_OK,CAT_LOG_ID_FINAL,MONEDA_ID,COSTO,PROP1,PROP2,
				PROP3,LARGO,ALTO,ANCHO,VOLUMEN_UNITARIO,PESO_UNITARIO,CANT_SOLICITADA,TRACE_BACK_ORDER)
			VALUES(@Documento_Id,@NRO_LINEA,@Cliente_Id,@Cod_Producto,@Cantidad,NULL,
				NULL,NULL,NULL,NULL,@Descripcion,NULL,NULL,
				NULL,NULL,@Unidad_Id,NULL,NULL,NULL,NULL,'1',
				'0',NULL,NULL,'1',@Cat_Logica_Id,NULL,NULL,NULL,NULL,
				NULL,NULL,NULL,NULL,NULL,NULL,@Cantidad,NULL)
				
		SELECT @COUNT=COUNT(*),@CANTIDAD_TOTAL= SUM(CANTIDAD)
		FROM DET_DOCUMENTO WHERE DOCUMENTO_ID=@Documento_Id AND PRODUCTO_ID=@Cod_Producto
		
		IF 	@COUNT>1
		BEGIN
			SELECT @NROLINEADOC= MIN(NRO_LINEA)
				FROM DET_DOCUMENTO WHERE DOCUMENTO_ID= @Documento_Id AND PRODUCTO_ID=@Cod_Producto
			
			UPDATE DET_DOCUMENTO SET CANTIDAD=@CANTIDAD_TOTAL, CANT_SOLICITADA=@CANTIDAD_TOTAL
				WHERE DOCUMENTO_ID=@Documento_Id AND PRODUCTO_ID=@Cod_Producto AND NRO_LINEA=@NROLINEADOC	
				
			DELETE FROM DET_DOCUMENTO WHERE DOCUMENTO_ID=@Documento_Id AND PRODUCTO_ID=@Cod_Producto AND
				NRO_LINEA<>@NROLINEADOC
		
		END
	END	
	ELSE
	BEGIN
		INSERT INTO DET_DOCUMENTO(DOCUMENTO_ID,NRO_LINEA,CLIENTE_ID,PRODUCTO_ID,CANTIDAD,NRO_SERIE,
					NRO_SERIE_PADRE,EST_MERC_ID,CAT_LOG_ID,NRO_BULTO,DESCRIPCION,NRO_LOTE,FECHA_VENCIMIENTO,
					NRO_DESPACHO,NRO_PARTIDA,UNIDAD_ID,PESO,UNIDAD_PESO,VOLUMEN,UNIDAD_VOLUMEN,BUSC_INDIVIDUAL,
					TIE_IN,NRO_TIE_IN_PADRE,NRO_TIE_IN,ITEM_OK,CAT_LOG_ID_FINAL,MONEDA_ID,COSTO,PROP1,PROP2,
					PROP3,LARGO,ALTO,ANCHO,VOLUMEN_UNITARIO,PESO_UNITARIO,CANT_SOLICITADA,TRACE_BACK_ORDER)
				VALUES(@Documento_Id,@NRO_LINEA,@Cliente_Id,@Cod_Producto,@Cantidad,NULL,
					NULL,NULL,NULL,NULL,@Descripcion,NULL,NULL,
					NULL,NULL,@Unidad_Id,NULL,NULL,NULL,NULL,'1',
					'0',NULL,NULL,'1',@Cat_Logica_Id,NULL,NULL,NULL,NULL,
					NULL,NULL,NULL,NULL,NULL,NULL,@Cantidad,NULL)
					
					UPDATE DOCUMENTO SET STATUS='D10' WHERE DOCUMENTO_ID=@Documento_Id

	END
	
END
GO

IF @@ERROR <> 0
BEGIN
   IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION
   INSERT INTO #tmpErrors (Error) SELECT 1
   BEGIN TRANSACTION
END
GO

SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[Mob_Guardado_Items_Cont] 
@Documento_ID	numeric(20,0),
@Cantidad		numeric(20,5),
@Posicion_Cod	varchar(45),
@Producto_id	varchar(30)=null
AS
begin
	set xact_abort on
	set nocount on
	Declare @Qty		as numeric(20,5)
	Declare @QtyVar		as varchar(max)
	Declare @CurRl		as Cursor
	Declare @RlID		as Numeric(20,0)
	Declare @QtyRL		as numeric(20,5)
	Declare @NewPos		as Numeric(20,0)
	Declare @NewNave	as Numeric(20,0)
	Declare @NewRl		as Numeric(20,0)
	
	--1. Valido que la cantidad ingresada sea menor o igual a la cantidad disponible para guardar.
	IF NOT EXISTS(SELECT RL.NRO_LINEA_TRANS
	FROM	DET_DOCUMENTO DD INNER JOIN DET_DOCUMENTO_TRANSACCION DDT
			ON(DD.DOCUMENTO_ID=DDT.DOCUMENTO_ID AND DD.NRO_LINEA=DDT.NRO_LINEA_DOC)
			INNER JOIN RL_DET_DOC_TRANS_POSICION RL
			ON(DDT.DOC_TRANS_ID=RL.DOC_TRANS_ID AND DDT.NRO_LINEA_TRANS=RL.NRO_LINEA_TRANS)
	WHERE	DD.DOCUMENTO_ID=@Documento_ID AND DD.PRODUCTO_ID=@Producto_id AND RL.NRO_LINEA_TRANS= DD.NRO_LINEA
			AND DD.NRO_BULTO=@Cantidad AND RL.NAVE_ACTUAL='1')

	BEGIN
		Set @qtyvar=cast(@Cantidad as varchar)
		RAISERROR('La contenedora a ubicar no existe, verifique en Ver Pend. %s',16,1,'')
		return
	END
	--1.1 Obtengo los Id.
	SELECT @NEWPOS=CAST(DBO.GET_POS_ID_TR(@Posicion_Cod) AS INT)
	SELECT @NEWNAVE=CAST(DBO.GET_NAVE_ID_TR(@Posicion_Cod) AS INT)
	
	IF (@NEWNAVE IS NULL) AND (@NEWPOS IS NULL)
	BEGIN
		RAISERROR('LA UBICACON ESTABLECIDA ES INVALIDA %s',16,1,@Posicion_Cod)
		RETURN
	END
	--2. Ubico la mercaderia sin tener que hacer un split de la rl. :)
	
		update	rl_det_doc_trans_posicion 
				set nave_anterior=nave_actual,
					nave_actual=@NEWNAVE,
					posicion_actual=@NEWPOS
		FROM	DET_DOCUMENTO DD INNER JOIN DET_DOCUMENTO_TRANSACCION DDT
				ON(DD.DOCUMENTO_ID=DDT.DOCUMENTO_ID AND DD.NRO_LINEA=DDT.NRO_LINEA_DOC)
				INNER JOIN RL_DET_DOC_TRANS_POSICION RL
				ON(DDT.DOC_TRANS_ID=RL.DOC_TRANS_ID AND DDT.NRO_LINEA_TRANS=RL.NRO_LINEA_TRANS)
		WHERE	DD.DOCUMENTO_ID=@Documento_ID
				AND DD.NRO_BULTO=@Cantidad
				AND RL.NAVE_ACTUAL='1' AND DD.PRODUCTO_ID=@Producto_id
	
end
GO

IF @@ERROR <> 0
BEGIN
   IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION
   INSERT INTO #tmpErrors (Error) SELECT 1
   BEGIN TRANSACTION
END
GO

SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[Mob_Guardado_Loc_Cont]
@DOCUMENTO_ID	AS NUMERIC(20),
@POS_ID			AS NUMERIC(20,0)	OUTPUT,
@POS_COD		AS VARCHAR(45)		OUTPUT,
@NAV_COD		AS VARCHAR(45)		OUTPUT,
@NAV_ID			AS NUMERIC(20,0)	OUTPUT,
@PRODUCTO_ID	AS VARCHAR(30)
AS

DECLARE @CLIENTEID 	AS VARCHAR(15)
DECLARE @PRODUCTOID AS VARCHAR(30)
DECLARE @VCANT 		AS NUMERIC(20)

----VARIABLES PARA HACER INSERT
DECLARE @POSICION_ID 			AS NUMERIC(20,0)
DECLARE @POSICION_COD 		AS VARCHAR(45)
DECLARE @NAVE_ID				AS NUMERIC(20,0)
DECLARE @ORDEN_LOCATOR 		AS NUMERIC(6)
DECLARE @CASO				AS INT

BEGIN
	

	IF @DOCUMENTO_ID IS NULL
	BEGIN
			RAISERROR ('EL PARAMETRO @DOCUMENTO_ID NO PUEDE SER NULO. SQLSERVER', 16, 1)
	END
	
	DELETE FROM SYS_LOCATOR_ING WHERE POSICION_ID IS NULL AND NAVE_ID IS NULL


	SET TRANSACTION ISOLATION LEVEL REPEATABLE READ


	SELECT 	TOP 1 @CLIENTEID=DD.CLIENTE_ID,@PRODUCTOID=DD.PRODUCTO_ID
	FROM 	DET_DOCUMENTO DD INNER JOIN DOCUMENTO D
			ON (DD.DOCUMENTO_ID=D.DOCUMENTO_ID)
			INNER JOIN DET_DOCUMENTO_TRANSACCION DDT
			ON(DDT.DOCUMENTO_ID=DD.DOCUMENTO_ID AND DDT.NRO_LINEA_DOC=DD.NRO_LINEA)
			INNER JOIN RL_DET_DOC_TRANS_POSICION RL
			ON(RL.DOC_TRANS_ID=DDT.DOC_TRANS_ID AND RL.NRO_LINEA_TRANS=DDT.NRO_LINEA_TRANS)
			INNER JOIN NAVE N
			ON(RL.NAVE_ACTUAL=N.NAVE_ID)
	WHERE	DD.DOCUMENTO_ID=@DOCUMENTO_ID
			AND D.STATUS IN('D30','D35')
			AND (N.PRE_INGRESO='1' OR N.INTERMEDIA='1')
			AND DD.PRODUCTO_ID=@PRODUCTO_ID

	BEGIN
		SELECT 	@VCANT=COUNT(*)
		FROM 	RL_PRODUCTO_POSICION_PERMITIDA
		WHERE 	CLIENTE_ID=@CLIENTEID AND PRODUCTO_ID=@PRODUCTOID
				

		IF @VCANT > 0
			BEGIN
				SELECT TOP 1
						 @POSICION_ID=X.POSICION_ID
						,@POSICION_COD=ISNULL((SELECT DBO.MOB_BUSCAR_POSICION_GUARDADO(@CLIENTEID, @PRODUCTOID)),X.POSICION_COD)
						,@NAVE_ID=X.NAVE_ID
						,@ORDEN_LOCATOR=X.ORDENLOCATOR
						,@CASO=X1
				FROM(
					SELECT 	 
							 P.POSICION_ID  AS POSICION_ID
							,P.POSICION_COD AS POSICION_COD
							,NULL AS NAVE_ID
							,ISNULL(P.ORDEN_LOCATOR,99999) AS ORDENLOCATOR
							,1 AS X1
					FROM 	POSICION P INNER JOIN
							RL_PRODUCTO_POSICION_PERMITIDA RLPP
							ON(P.POSICION_ID=RLPP.POSICION_ID)
							LEFT JOIN RL_POSICION_PROHIBIDA_CLIENTE PROH --AGREGUE ESTO 30-07-2009
							ON (P.POSICION_ID = PROH.POSICION_ID) --AGREGUE ESTO 30-07-2009
					WHERE	1=1 AND P.POS_LOCKEADA='0'
							AND RLPP.PRODUCTO_ID=LTRIM(RTRIM(UPPER(@PRODUCTOID))) 
							AND RLPP.CLIENTE_ID=LTRIM(RTRIM(UPPER(@CLIENTEID)))
							AND PROH.POSICION_ID IS NULL --AGREGUE ESTO 30-07-2009
					UNION ALL
				
					SELECT 	 
							 NULL AS 	POSICION_ID
							,N.NAVE_COD AS POSICION_COD
							,N.NAVE_ID  AS NAVE_ID
							,ISNULL(N.ORDEN_LOCATOR,99999) AS ORDENLOCATOR
							,0 AS X1
					FROM 	NAVE N INNER JOIN
							RL_PRODUCTO_POSICION_PERMITIDA RLPP
							ON(N.NAVE_ID=RLPP.NAVE_ID)
					WHERE	N.DISP_INGRESO='1' AND N.PRE_INGRESO='0' 
							AND PRE_EGRESO='0'
							AND RLPP.PRODUCTO_ID=LTRIM(RTRIM(UPPER(@PRODUCTOID)))
							AND RLPP.CLIENTE_ID=LTRIM(RTRIM(UPPER(@CLIENTEID)))
				
				)AS X
				ORDER BY X.ORDENLOCATOR ASC
				BEGIN TRANSACTION
				IF @CASO=1
				BEGIN
					
					DELETE FROM SYS_LOCATOR_ING 
						 WHERE DOCUMENTO_ID=@DOCUMENTO_ID AND NOT NRO_LINEA IN  (SELECT DD.NRO_LINEA
							FROM DET_DOCUMENTO DD INNER JOIN SYS_LOCATOR_ING SIL ON
							 DD.DOCUMENTO_ID = SIL.DOCUMENTO_ID AND DD.NRO_LINEA= SIL.NRO_LINEA
								AND DD.PRODUCTO_ID<>@PRODUCTOID AND DD.DOCUMENTO_ID=@DOCUMENTO_ID)
										
					
					
					IF @POSICION_ID IS NULL AND @NAVE_ID IS NULL
					BEGIN
						RAISERROR('-1021 SQL - NO QUEDAN UBICACIONES DISPONIBLES PARA UBICAR EL PRODUCTO.',16,1)
					END
					ELSE
					BEGIN
						SET @POS_ID=@POSICION_ID
						SET @POS_COD=@POSICION_COD
						SET @NAV_COD=NULL
						SET @NAV_ID=@NAVE_ID
					END
				END
				ELSE
				BEGIN
					DELETE FROM SYS_LOCATOR_ING 
						 WHERE DOCUMENTO_ID=@DOCUMENTO_ID AND NOT NRO_LINEA IN  (SELECT DD.NRO_LINEA
							FROM DET_DOCUMENTO DD INNER JOIN SYS_LOCATOR_ING SIL ON
							 DD.DOCUMENTO_ID = SIL.DOCUMENTO_ID AND DD.NRO_LINEA= SIL.NRO_LINEA
								AND DD.PRODUCTO_ID<>@PRODUCTOID AND DD.DOCUMENTO_ID=@DOCUMENTO_ID)

					IF @POSICION_ID IS NULL AND @NAVE_ID IS NULL
					BEGIN
						RAISERROR('-1021 SQL - NO QUEDAN UBICACIONES DISPONIBLES PARA UBICAR EL PRODUCTO.',16,1)
					END
					ELSE
					BEGIN
						SET @POS_ID=@POSICION_ID
						SET @POS_COD=@POSICION_COD
						SET @NAV_COD=@POSICION_COD
						SET @NAV_ID=@NAVE_ID
					END

				END

				COMMIT TRANSACTION

			END		
		ELSE
			BEGIN

					SELECT TOP 1
							 @POSICION_ID=X.POSICION_ID
							,@POSICION_COD=X.POSICION_COD
							,@NAVE_ID=X.NAVE_ID
							,@ORDEN_LOCATOR=X.ORDENLOCATOR
							,@CASO=X1
					FROM(
						SELECT 	 P.POSICION_ID  AS POSICION_ID
								,POSICION_COD AS POSICION_COD
								,NULL AS NAVE_ID
								,ISNULL(ORDEN_LOCATOR,99999) AS ORDENLOCATOR
								,1 AS X1
						FROM 	POSICION P 
								LEFT JOIN RL_POSICION_PROHIBIDA_CLIENTE PROH --AGREGUE ESTO 30-07-2009
								ON (P.POSICION_ID = PROH.POSICION_ID) --AGREGUE ESTO 30-07-2009
								LEFT JOIN RL_DET_DOC_TRANS_POSICION TP --AGREGUE ESTO 31-07-2009
								ON (P.POSICION_ID = TP.POSICION_ACTUAL) --AGREGUE ESTO 31-07-2009
						WHERE	P.POS_LOCKEADA='0'
								AND PROH.POSICION_ID IS NULL --AGREGUE ESTO 30-07-2009
								AND TP.POSICION_ACTUAL IS NULL --AGREGUE ESTO 31-07-2009
						UNION ALL
						SELECT 	 
								 NULL AS POSICION_ID
								,NAVE_COD AS POSICION_COD
								,NAVE_ID  AS NAVE_ID
								,ISNULL(ORDEN_LOCATOR,99999) AS ORDENLOCATOR
								,0 AS X1
						FROM 	NAVE N
						WHERE	N.DISP_INGRESO='1' AND N.PRE_INGRESO='0' 
								AND PRE_EGRESO='0'
								AND NAVE_TIENE_LAYOUT='0'

					)AS X
					ORDER BY X.ORDENLOCATOR
				BEGIN TRANSACTION
				IF @CASO=1
				BEGIN
					DELETE FROM SYS_LOCATOR_ING 
						 WHERE DOCUMENTO_ID=@DOCUMENTO_ID AND NOT NRO_LINEA IN  (SELECT DD.NRO_LINEA
							FROM DET_DOCUMENTO DD INNER JOIN SYS_LOCATOR_ING SIL ON
							 DD.DOCUMENTO_ID = SIL.DOCUMENTO_ID AND DD.NRO_LINEA= SIL.NRO_LINEA
								AND DD.PRODUCTO_ID<>@PRODUCTOID AND DD.DOCUMENTO_ID=@DOCUMENTO_ID)

					IF @POSICION_ID IS NULL AND @NAVE_ID IS NULL
					BEGIN
						RAISERROR('-1021 SQL - NO QUEDAN UBICACIONES DISPONIBLES PARA UBICAR EL PRODUCTO.',16,1)
					END
					ELSE
					BEGIN
						SET @POS_ID=@POSICION_ID
						SET @POS_COD=@POSICION_COD
						SET @NAV_COD=@POSICION_COD
						SET @NAV_ID=@NAVE_ID
					END
				END
				ELSE
				BEGIN
					IF @POSICION_ID IS NULL AND @NAVE_ID IS NULL
					BEGIN
						RAISERROR('-1021 SQL - NO QUEDAN UBICACIONES DISPONIBLES PARA UBICAR EL PRODUCTO.',16,1)
					END
					ELSE
					BEGIN
						SET @POS_ID=@POSICION_ID
						SET @POS_COD=@POSICION_COD
						SET @NAV_COD=@POSICION_COD
						SET @NAV_ID=@NAVE_ID
					END
				END
				COMMIT TRANSACTION
		END
	END

END
GO

IF @@ERROR <> 0
BEGIN
   IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION
   INSERT INTO #tmpErrors (Error) SELECT 1
   BEGIN TRANSACTION
END
GO

SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[Mob_Guardado_Prod_Cont]
	@DOCUMENTO_ID	NUMERIC(20,0),
	@CLIENTE		VARCHAR(30),
	@PRODUCTO		VARCHAR(30) OUTPUT,		--OK
	@DESCRIPCION	VARCHAR(50) OUTPUT,		--OK
	@COUNT_LINEAS	SMALLINT		OUTPUT,		
	@FRACC			CHAR(1)		OUTPUT		--OK
AS
BEGIN
	SET NOCOUNT ON
	SET XACT_ABORT ON
	--DECLARACION DE VARIABLES.
	DECLARE @COUNT	SMALLINT
		
	--PRIMERO TENGO QUE SABER SI ES EL PRODUCTO O UN EAN/DUN.
	SELECT	@COUNT=COUNT(*)
	FROM	PRODUCTO
	WHERE	CLIENTE_ID=@CLIENTE
			AND PRODUCTO_ID=@PRODUCTO
	
	IF @COUNT=0
	BEGIN
		--NO ES UN PRODUCTO, TENGO QUE SACAR EL EAN/DUN.
		SET @COUNT=NULL
		SELECT	@COUNT=COUNT(*)
		FROM	RL_PRODUCTO_CODIGOS
		WHERE	CLIENTE_ID=@CLIENTE
				AND CODIGO=@PRODUCTO
			 
		
		IF @COUNT=0
		BEGIN
			--NO EXISTE EL PRODUCTO Y EL CODIGO ES INVALIDO.
			RAISERROR('El producto ingresado es inexistente.',16,1)
			RETURN
		END
		ELSE
		BEGIN
			--ENCONTRE EL PRODUCTO A PARTIR DEL CODIGO Y RECUPERO EL PRODUCTO_ID.
			SELECT	@PRODUCTO=PRODUCTO_ID 
			FROM	RL_PRODUCTO_CODIGOS
			WHERE	CLIENTE_ID=@CLIENTE
					AND CODIGO=@PRODUCTO
		END
	END
	--SACO LA DESCRIPCION DEL PRODUCTO Y SI ES O NO FRACCIONABLE.
	SELECT	@DESCRIPCION=DESCRIPCION, @FRACC=ISNULL(FRACCIONABLE,'0')
	FROM	PRODUCTO
	WHERE	CLIENTE_ID=@CLIENTE
			AND PRODUCTO_ID=@PRODUCTO

		--OBTENGO LA CANTIDAD DE CONTENEDORAS A UBICAR DEL PRODUCTO.
	SELECT	@COUNT_LINEAS=COUNT(RL.NRO_LINEA_TRANS)
	FROM	DET_DOCUMENTO DD INNER JOIN DET_DOCUMENTO_TRANSACCION DDT
			ON(DD.DOCUMENTO_ID=DDT.DOCUMENTO_ID AND DD.NRO_LINEA=DDT.NRO_LINEA_DOC)
			INNER JOIN RL_DET_DOC_TRANS_POSICION RL
			ON(DDT.DOC_TRANS_ID=RL.DOC_TRANS_ID AND DDT.NRO_LINEA_TRANS=RL.NRO_LINEA_TRANS)
	WHERE	DD.DOCUMENTO_ID=@DOCUMENTO_ID
			AND DD.PRODUCTO_ID=@PRODUCTO
			AND RL.NAVE_ACTUAL='1'
			AND RL.CAT_LOG_ID='TRAN_ING'
		
	IF (@COUNT_LINEAS IS NULL) OR (@COUNT_LINEAS=0)
	BEGIN
		RAISERROR('No hay pendientes de ubicacion para el producto seleccionado.',16,1)
		return
	END

END--FIN PROCEDURE.
GO

IF @@ERROR <> 0
BEGIN
   IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION
   INSERT INTO #tmpErrors (Error) SELECT 1
   BEGIN TRANSACTION
END
GO

SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[Mob_Guardado_ValDocIng]
	@Documento_ID	Numeric(20,0),
	@Cpte_Prefijo	Varchar(6) output,
	@Cpte_Numero	Varchar(20) output,
	@Cod_Origen		Varchar(20) output,
	@Nombre_Origen	Varchar(50) output,
	@Cliente_Id		Varchar(15) output
AS
BEGIN
	SET NOCOUNT ON
	SET XACT_ABORT ON
	DECLARE @CONT SMALLINT
	
	SELECT	@CONT= COUNT(*)
	FROM	DOCUMENTO
	WHERE	DOCUMENTO_ID=@DOCUMENTO_ID
	
	IF @CONT=0
	BEGIN
		RAISERROR('El Nro. de Documento ingresado no existe',16,1)
		RETURN
	END
	SET @CONT=NULL

	SELECT	@CONT= COUNT(*)
	FROM	DOCUMENTO
	WHERE	DOCUMENTO_ID=@DOCUMENTO_ID
			AND TIPO_OPERACION_ID='ING'
			
	IF @CONT=0
	BEGIN
		RAISERROR('El Nro. de Documento ingresado no es un documento de Ingreso.',16,1)
		RETURN
	END
	
	SET @CONT=NULL
	SELECT	@CONT= COUNT(*)
	FROM	DOCUMENTO
	WHERE	DOCUMENTO_ID=@DOCUMENTO_ID
			AND TIPO_OPERACION_ID='ING'
			AND STATUS<'D30'
	
	IF @CONT =0
	BEGIN
		RAISERROR('El documento se encuentra en estado mayor o igual D30',16,1)
	END 
	 SELECT @Cpte_Prefijo=ISNULL(D.CPTE_PREFIJO,''),@Cpte_Numero=ISNULL(D.CPTE_NUMERO,''),
		@Cod_Origen=ISNULL(D.SUCURSAL_ORIGEN,''),@Nombre_Origen=ISNULL(S.NOMBRE,''),@Cliente_Id=D.CLIENTE_ID
		 FROM DOCUMENTO D LEFT JOIN
		 SUCURSAL S ON D.SUCURSAL_ORIGEN=S.SUCURSAL_ID
		 AND D.CLIENTE_ID = S.CLIENTE_ID
		 WHERE D.DOCUMENTO_ID=@Documento_ID
	
END
GO

IF @@ERROR <> 0
BEGIN
   IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION
   INSERT INTO #tmpErrors (Error) SELECT 1
   BEGIN TRANSACTION
END
GO

SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[Mob_Guardado_ValProducto]
	@Cod_Producto	Varchar(50)output,
	@Cliente_Id		Varchar(15) output,
	@Descripcion	Varchar(200) output,
	@Unidad			Varchar(50) output,
	@Cat_Logica		Varchar(50) output,
	@Producto_Id	Varchar(30) output,
	@EsFraccionable	Char(1) output
AS
BEGIN
	SET NOCOUNT ON
	SET XACT_ABORT ON
	DECLARE @CONT SMALLINT

	
	SELECT	@CONT= COUNT(*)
	FROM	PRODUCTO
	WHERE	CLIENTE_ID = @CLIENTE_ID AND PRODUCTO_ID=@Cod_Producto
			
	
	IF @CONT=0
	BEGIN
		SELECT	@CONT= COUNT(*)
		FROM	RL_PRODUCTO_CODIGOS
		WHERE	CLIENTE_ID = @CLIENTE_ID AND CODIGO=@Cod_Producto AND CLIENTE_ID= @Cliente_Id
		
		IF  @CONT=0
		BEGIN
			RAISERROR('El Producto ingresado no existe',16,1)
			RETURN
		END
		
		IF  @CONT>1
		BEGIN
			RAISERROR('Para el Codigo del Producto ingresado existe más de un registro',16,1)
			RETURN		
		END
		
		IF  @CONT=1
		BEGIN
			SELECT @Cod_Producto=PRODUCTO_ID
			FROM RL_PRODUCTO_CODIGOS
			WHERE	CLIENTE_ID = @CLIENTE_ID AND CODIGO=@Cod_Producto AND CLIENTE_ID= @Cliente_Id
		END
	
	END		
	
		
SELECT	@Descripcion = P.DESCRIPCION
		,@Unidad =UM.DESCRIPCION
		,@Cat_Logica =CL.DESCRIPCION
		,@Producto_Id =P.PRODUCTO_ID
		,@EsFraccionable=ISNULL(P.FRACCIONABLE,'0')
FROM RL_PRODUCTO_CATLOG RLC
INNER JOIN CATEGORIA_LOGICA CL ON RLC.CAT_LOG_ID=CL.CAT_LOG_ID AND RLC.CLIENTE_ID=CL.CLIENTE_ID
INNER JOIN PRODUCTO P ON RLC.PRODUCTO_ID = P.PRODUCTO_ID AND P.CLIENTE_ID = RLC.CLIENTE_ID
INNER JOIN UNIDAD_MEDIDA UM ON P.UNIDAD_ID = UM.UNIDAD_ID
WHERE	RLC.CLIENTE_ID = @Cliente_Id
		and RLC.PRODUCTO_ID = @Cod_Producto

	IF @Descripcion IS NULL 
	BEGIN
		SELECT	@Descripcion = P.DESCRIPCION
				,@Unidad= UM.DESCRIPCION
				,@Cat_Logica=C.DESCRIPCION
				,@Producto_Id =P.PRODUCTO_ID
				,@EsFraccionable=ISNULL(P.FRACCIONABLE,'0')
			FROM PRODUCTO P
			INNER JOIN UNIDAD_MEDIDA UM ON P.UNIDAD_ID = UM.UNIDAD_ID
			INNER JOIN CATEGORIA_LOGICA C ON P.ING_CAT_LOG_ID = C.CAT_LOG_ID AND P.CLIENTE_ID = C.CLIENTE_ID
			WHERE	P.CLIENTE_ID = @CLIENTE_ID
					AND P.PRODUCTO_ID=@Cod_Producto

	END
  END
GO

IF @@ERROR <> 0
BEGIN
   IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION
   INSERT INTO #tmpErrors (Error) SELECT 1
   BEGIN TRANSACTION
END
GO

SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[Mob_IngresarPedidos]
@Codigo as nvarchar(50)

AS	
	DECLARE @CONTROLADO AS INT
	DECLARE @FINALIZADO AS INT
	DECLARE @CONTROL 	AS INT
	DECLARE @RC			AS INT
	DECLARE @EXISTE_V	AS NUMERIC(20,0)
	DECLARE @QTY		AS INT
	DECLARE @ENV		AS INT
	DECLARE @Controla	AS CHAR(1)
	DECLARE @DOCUMENTO  AS NUMERIC (20,0)
	DECLARE @VIAJE AS VARCHAR(100)

	SELECT 	@EXISTE_V=ISNULL(PICKING_ID,0),@DOCUMENTO=DOCUMENTO_ID,@VIAJE=VIAJE_ID
	FROM	PICKING
	WHERE	DOCUMENTO_ID=LTRIM(RTRIM(UPPER((	
						SELECT TOP 1 DDOC.DOCUMENTO_ID 
						FROM dbo.SYS_INT_DOCUMENTO DOC 
						INNER JOIN SYS_INT_DET_DOCUMENTO DDOC ON DDOC.CLIENTE_ID = DOC.CLIENTE_ID AND DDOC.DOC_EXT = DOC.DOC_EXT
						INNER JOIN CLIENTE_PARAMETROS CP ON CP.CLIENTE_ID = DOC.CLIENTE_ID
						WHERE DOC.TIPO_DOCUMENTO_ID IN (SELECT TP.TIPO_COMPROBANTE_ID 
							  FROM TIPO_COMPROBANTE TP
							  WHERE TP.TIPO_OPERACION_ID = 'EGR'
						 	 )
						AND DOC.DOC_EXT = @Codigo)))) AND ST_CONTROL_EXP='0'


	
	
	Select	@Controla=isnull(c.flg_control_exp,'0')
	from	picking p inner join cliente_parametros c
			on(p.cliente_id=c.cliente_id)
	where	DOCUMENTO_ID=@DOCUMENTO
	
	IF @EXISTE_V > 0
		BEGIN
			SELECT @FINALIZADO=DBO.STATUS_PICKING_PEDIDO(@EXISTE_V)
		END
	ELSE
		BEGIN
			RAISERROR('El pedido no existe',16,1)
			RETURN
		END
	
	IF @FINALIZADO =2 
		BEGIN
			-- Agregado para control de Carga.
			SELECT 	@QTY=COUNT(DD.DOC_EXT)
			FROM 	SYS_INT_DET_DOCUMENTO DD
					INNER JOIN SYS_INT_DOCUMENTO D ON (DD.CLIENTE_ID=D.CLIENTE_ID AND DD.DOC_EXT=D.DOC_EXT)
					INNER JOIN PRODUCTO PROD ON (DD.CLIENTE_ID=PROD.CLIENTE_ID AND DD.PRODUCTO_ID=PROD.PRODUCTO_ID)
			WHERE 	DD.ESTADO_GT IS NULL AND D.DOC_EXT=LTRIM(RTRIM(UPPER(@Codigo)))

			IF (@QTY>0) BEGIN
				RAISERROR('EL PEDIDO AUN TIENE PRODUCTOS PENDIENTES POR PROCESAR!',16,1)
				RETURN
			END 
			
			--Aca hago un Update para que no levante los pallet
			--que, sumado el total, den igual a 0
			update picking set st_control_exp=1 
			where  VIAJE_ID=@VIAJE
					and pallet_picking in(	select 	pallet_picking
											from	picking
											where	VIAJE_ID=@VIAJE
											group by
													pallet_picking
											having 	sum(cant_confirmada)=0
										)


			SELECT  DISTINCT   
					PALLET_PICKING as NRO_PALLET, DOCUMENTO_ID as DOCUMENTO,
					ST_CONTROL_EXP AS ST_CONTROL_EXP
			FROM    PICKING
			WHERE 	DOCUMENTO_ID =@DOCUMENTO
					AND FECHA_INICIO IS NOT NULL
					AND FECHA_FIN IS NOT NULL
					AND USUARIO IS NOT NULL
					AND CANT_CONFIRMADA IS NOT NULL
					AND PALLET_PICKING IS NOT NULL
					AND ISNULL(ST_CONTROL_EXP,'0')='0'
					AND ((@Controla='0') OR (FACTURADO=0))

			IF @@ROWCOUNT =0 
			BEGIN
				SELECT @ENV=COUNT(*) FROM RL_ENV_DOCUMENTO_VIAJE WHERE DOCUMENTO_ID=@DOCUMENTO
				IF @ENV=1
				BEGIN
					RAISERROR('El pedido ya fue controlado',16,1)				
				END
				ELSE
				BEGIN

					SELECT 1 AS EXISTE
				END

			END
		END
		ELSE
		BEGIN
			RAISERROR('El pedido se encuentra en proceso de Picking',16,1)
			RETURN
		END
GO

IF @@ERROR <> 0
BEGIN
   IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION
   INSERT INTO #tmpErrors (Error) SELECT 1
   BEGIN TRANSACTION
END
GO

SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
GO

CREATE Procedure [dbo].[Mob_IngresarPedidos_Controlado]
	@PedidoId As Varchar(100)
As
Begin

	Select 	Distinct
			ISNULL(cast(Pallet_Picking as varchar),'') AS NRO_PALLET
	From	Picking (nolock)
	Where	DOCUMENTO_ID=LTRIM(RTRIM(UPPER((	
						SELECT TOP 1 DDOC.DOCUMENTO_ID 
						FROM dbo.SYS_INT_DOCUMENTO DOC 
						INNER JOIN SYS_INT_DET_DOCUMENTO DDOC ON DDOC.CLIENTE_ID = DOC.CLIENTE_ID AND DDOC.DOC_EXT = DOC.DOC_EXT
						INNER JOIN CLIENTE_PARAMETROS CP ON CP.CLIENTE_ID = DOC.CLIENTE_ID
						WHERE DOC.TIPO_DOCUMENTO_ID IN (SELECT TP.TIPO_COMPROBANTE_ID 
							  FROM TIPO_COMPROBANTE TP
							  WHERE TP.TIPO_OPERACION_ID = 'EGR'
						 	 )
						AND DOC.DOC_EXT = @PedidoId))))
			And St_Control_Exp='1'
	Group By
			Pallet_Picking
	having	sum(cant_confirmada)>0

End
GO

IF @@ERROR <> 0
BEGIN
   IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION
   INSERT INTO #tmpErrors (Error) SELECT 1
   BEGIN TRANSACTION
END
GO

SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
GO

CREATE Procedure [dbo].[Mob_IngresarPedidos_Pallet]
	@PedidoId as Varchar(100),
	@Pallet  as numeric(38)
As
Begin
	
	Declare @Total 		as Int
	Declare @Total_Fin 	as Int
	Declare @Control 	as Int
	Declare @Usr		as varchar(15)
	Declare @Terminal	as varchar(100)
	Declare @FacturaAT	as varchar(10)
	Declare @PalletCerrado	as char(1)
	Declare @Controla	as char(1)
    DECLARE @VIAJE AS VARCHAR(100)
	DECLARE @DOCUMENTO  AS NUMERIC (20,0)
	
	Set @Terminal	=Host_Name()
	Select @Usr=Usuario_id from #Temp_Usuario_loggin
	Select @VIAJE = (LTRIM(RTRIM(UPPER((	
						SELECT TOP 1 DOC.CODIGO_VIAJE 
						FROM dbo.SYS_INT_DOCUMENTO DOC 
						INNER JOIN SYS_INT_DET_DOCUMENTO DDOC ON DDOC.CLIENTE_ID = DOC.CLIENTE_ID AND DDOC.DOC_EXT = DOC.DOC_EXT
						INNER JOIN CLIENTE_PARAMETROS CP ON CP.CLIENTE_ID = DOC.CLIENTE_ID
						WHERE DOC.TIPO_DOCUMENTO_ID IN (SELECT TP.TIPO_COMPROBANTE_ID 
							  FROM TIPO_COMPROBANTE TP
							  WHERE TP.TIPO_OPERACION_ID = 'EGR'
						 	 )
						AND DOC.DOC_EXT = @PedidoId)))))
	Select	distinct @PalletCerrado=isnull(pallet_cerrado,'0'), @DOCUMENTO = DOCUMENTO_ID
	from	picking	
	where	VIAJE_ID = @VIAJE
			And Pallet_Picking=Ltrim(Rtrim(Upper(@Pallet)))

	set @Controla=null
	select	@Controla=isnull(flg_control_apf,'0')
	from	cliente_parametros
	where	cliente_id=(select distinct cliente_id from picking(nolock) where pallet_picking=@Pallet)

	if (@PalletCerrado='0') and (@Controla='1')
	begin
		raiserror('Debe terminar el Armado de pallet final antes de realizar la subida al camion.', 16,1)
		return
	end	
	Set @controla=null
	
	select	@Controla=isnull(flg_control_picking,'0')
	from	cliente_parametros 
	where	cliente_id=(select distinct cliente_id from picking(nolock) where pallet_picking=@Pallet)

	if (@Controla='1')
	begin
		set @controla=null
		SELECT	@controla=isnull(pallet_controlado,0)
		From	picking p (nolock)
		Where 	P.PALLET_PICKING=@Pallet
				and pallet_picking is not null
		if @controla='0'
		begin
			raiserror('Debe realizar el control del pallet de picking antes de realizar la expedicion.', 16,1)
			return
		end
	end	

	Update	Picking	
	Set 	St_Control_Exp='1', 
			Fecha_Control_Exp=Getdate(),
			Usuario_Control_Exp=ltrim(rtrim(upper(@Usr))),
			Terminal_Control_Exp=@Terminal		
	Where	DOCUMENTO_ID=@DOCUMENTO
			And Pallet_Picking=Ltrim(Rtrim(Upper(@Pallet)))

	update picking set st_control_exp=1 
	where  DOCUMENTO_ID=@DOCUMENTO
			and pallet_picking in(	select 	pallet_picking
									from	picking
									where	DOCUMENTO_ID=@DOCUMENTO
									group by
											pallet_picking
									having 	sum(cant_confirmada)=0
								)

	SELECT 	@TOTAL=ISNULL(COUNT(PICKING_ID),0)
	FROM 	PICKING
	WHERE 	DOCUMENTO_ID=LTRIM(RTRIM(UPPER(@DOCUMENTO)))

	SELECT 	@TOTAL_FIN=ISNULL(COUNT(PICKING_ID),0)
	FROM 	PICKING
	WHERE	DOCUMENTO_ID=LTRIM(RTRIM(UPPER(@DOCUMENTO)))
			AND FECHA_INICIO IS NOT NULL
			AND FECHA_FIN IS NOT NULL
			AND USUARIO IS NOT NULL
			AND CANT_CONFIRMADA IS NOT NULL
			AND PALLET_PICKING IS NOT NULL
			AND St_Control_Exp='1'

	If @Total= @Total_Fin
		Begin
			Update	Picking Set St_Camion = '2' 
			Where	DOCUMENTO_ID=Ltrim(Rtrim(Upper(@DOCUMENTO)))
			
			--proceso por el cual se pretende q al momento de estar todo sobre el camion
			--salga de la frontera.
			Select	@FacturaAT=VALOR
			from	sys_parametro_proceso
			where	proceso_id='WARP'AND SUBPROCESO_ID='FACTURACION_AT' AND PARAMETRO_ID='FACTURACION'

			If @FacturaAt='1'
			Begin
				Update	Picking Set Facturado = '1' 
				Where	DOCUMENTO_ID=Ltrim(Rtrim(Upper(@DOCUMENTO)))				
			End
		End

End
GO

IF @@ERROR <> 0
BEGIN
   IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION
   INSERT INTO #tmpErrors (Error) SELECT 1
   BEGIN TRANSACTION
END
GO

SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
GO

CREATE         Procedure [dbo].[Mob_IngresarPedidos_Pendiente]
	@PedidoId As Varchar(100)
As
Begin

	Select 	
			ISNULL(cast(Pallet_Picking as varchar),'') As NRO_PALLET
	From	Picking (nolock)
	Where	DOCUMENTO_ID=LTRIM(RTRIM(UPPER((	
						SELECT TOP 1 DDOC.DOCUMENTO_ID 
						FROM dbo.SYS_INT_DOCUMENTO DOC 
						INNER JOIN SYS_INT_DET_DOCUMENTO DDOC ON DDOC.CLIENTE_ID = DOC.CLIENTE_ID AND DDOC.DOC_EXT = DOC.DOC_EXT
						INNER JOIN CLIENTE_PARAMETROS CP ON CP.CLIENTE_ID = DOC.CLIENTE_ID
						WHERE DOC.TIPO_DOCUMENTO_ID IN (SELECT TP.TIPO_COMPROBANTE_ID 
							  FROM TIPO_COMPROBANTE TP
							  WHERE TP.TIPO_OPERACION_ID = 'EGR'
						 	 )
						AND DOC.DOC_EXT = @PedidoId))))
			And isnull(St_Control_Exp,'0')='0'
	Group by pallet_picking
	Having 	 sum(cant_confirmada)>0

End
GO

IF @@ERROR <> 0
BEGIN
   IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION
   INSERT INTO #tmpErrors (Error) SELECT 1
   BEGIN TRANSACTION
END
GO

SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[Mob_Validacion_Cont_Ubic] 
@Documento_ID		numeric(20,0),
@Nro_Contenedora	varchar(50),
@Producto_id		varchar(30)=null
AS
begin
	set xact_abort on
	set nocount on
		
	--1. Valido el número de la contenedora que ingreso no haya sido ubicada
	IF EXISTS(SELECT  RL.NAVE_ACTUAL
		FROM	DET_DOCUMENTO DD INNER JOIN DET_DOCUMENTO_TRANSACCION DDT
				ON(DD.DOCUMENTO_ID=DDT.DOCUMENTO_ID AND DD.NRO_LINEA=DDT.NRO_LINEA_DOC)
				INNER JOIN RL_DET_DOC_TRANS_POSICION RL
				ON(DDT.DOC_TRANS_ID=RL.DOC_TRANS_ID AND DDT.NRO_LINEA_TRANS=RL.NRO_LINEA_TRANS)
		WHERE	DD.DOCUMENTO_ID=@Documento_ID
				AND DD.NRO_BULTO=@Nro_Contenedora
				AND DD.PRODUCTO_ID=@Producto_id
				AND (RL.NAVE_ACTUAL<>'1' OR RL.POSICION_ACTUAL IS NOT NULL))
		BEGIN
			RAISERROR('La contenedora ya se encuentra ubicada, verifique en Ver Pendientes las contenedoras por ubicar ',16,1)
			return
		END

	--2 CONTROLO QUE SI EXISTE ALGUN PRODUCTO EN LA CONTENEDORA QUE REQUIERA SERIE AL INGRESO, SI NO SE LE CARGO ALGUNA QUE NO DEJE UBICARLA.
	IF EXISTS (SELECT 1
				FROM DET_DOCUMENTO DD
				INNER JOIN PRODUCTO P ON (DD.CLIENTE_ID = P.CLIENTE_ID AND DD.PRODUCTO_ID = P.PRODUCTO_ID)
				WHERE	DD.NRO_BULTO = @NRO_CONTENEDORA
						AND ISNULL(P.SERIE_ING,'0') = '1'
						AND DD.NRO_SERIE IS NULL)
	BEGIN
		RAISERROR('Algunos productos de la contenedora requieren serie al ingreso obligatoria. Por favor verifica la carga de las series.',16,1)
		return
	END
end
GO

IF @@ERROR <> 0
BEGIN
   IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION
   INSERT INTO #tmpErrors (Error) SELECT 1
   BEGIN TRANSACTION
END
GO

SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[PERMITE_PICK_DE_SERIE]
(@CLIENTE_ID VARCHAR(15), @PRODUCTO_ID VARCHAR(30), @NRO_SERIE_ANT VARCHAR(50), @NRO_SERIE VARCHAR(50),@CODIGO_VIAJE VARCHAR(100), @USUARIO_ID VARCHAR(30),@OUT VARCHAR(1) OUTPUT)
AS
BEGIN

DECLARE @STATUSDOC AS VARCHAR(20)
DECLARE @NRO_LOTE_ANT AS VARCHAR(100)
DECLARE @NRO_PARTIDA_ANT AS VARCHAR(100)
DECLARE @NRO_LOTE_NEW AS VARCHAR(100)
DECLARE @NRO_PARTIDA_NEW AS VARCHAR(100)

SET @OUT='5'

--ESTA ES SI O SI. ES LA SERIE QUE INGRESÉ, VALIDO QUE EXISTA AL MENOS INGRESADA
	SELECT @STATUSDOC = D.STATUS
	FROM RL_DET_DOC_TRANS_POSICION RL
	INNER JOIN DET_DOCUMENTO_TRANSACCION DDT ON (RL.DOC_TRANS_ID = DDT.DOC_TRANS_ID AND RL.NRO_LINEA_TRANS = DDT.NRO_LINEA_TRANS)
	INNER JOIN DET_DOCUMENTO DD ON (DDT.DOCUMENTO_ID = DD.DOCUMENTO_ID AND DDT.NRO_LINEA_DOC = DD.NRO_LINEA)
	INNER JOIN DOCUMENTO D ON (DD.DOCUMENTO_ID = D.DOCUMENTO_ID)
	WHERE DD.NRO_SERIE = @NRO_SERIE AND DD.PRODUCTO_ID = @PRODUCTO_ID AND D.CLIENTE_ID = @CLIENTE_ID

IF ISNULL(@STATUSDOC,'')=''
BEGIN
	SET @OUT='1'--LA SERIE NO EXISTE
	RETURN
END

IF @STATUSDOC <> 'D40'
BEGIN
	SET @OUT = '2'-- LA SERIE NO FUE UBICADA. (NO SE ENCUENTRA DISPONIBLE PARA EGRESO.)
	RETURN
END

--VALIDO SI LA SERIE CORRESPONDE AL VIAJE Y QUE NO ESTÉ PICKEADA
IF EXISTS (SELECT 1 FROM PICKING WHERE CLIENTE_ID = @CLIENTE_ID AND VIAJE_ID = @CODIGO_VIAJE AND NRO_SERIE = @NRO_SERIE AND FECHA_FIN IS NULL AND PRODUCTO_ID = @PRODUCTO_ID AND (USUARIO IS NULL OR USUARIO = @USUARIO_ID))
BEGIN
	SET @OUT='0'--OK, LA SERIE ES VALIDA
	RETURN
END

IF EXISTS (SELECT 1 FROM PICKING WHERE CLIENTE_ID = @CLIENTE_ID AND VIAJE_ID = @CODIGO_VIAJE AND NRO_SERIE = @NRO_SERIE AND FECHA_FIN IS NOT NULL AND PRODUCTO_ID = @PRODUCTO_ID)
BEGIN
	SET @OUT='3'--LA SERIE YA FUE PICKEADA
	RETURN
END

--VALIDO SI
--SI PERTENECE A OTRO VIAJE ME FIJO QUE NO ESTÉ EXPLICITADA EN EL DOCUMENTO DE EGRESO DE ESE VIAJE
IF EXISTS
	(SELECT 1
	FROM PICKING P
	INNER JOIN DET_DOCUMENTO DDEGR ON (P.DOCUMENTO_ID = DDEGR.DOCUMENTO_ID AND P.NRO_LINEA = DDEGR.NRO_LINEA AND P.NRO_SERIE = DDEGR.NRO_SERIE)
	WHERE P.VIAJE_ID <> @CODIGO_VIAJE AND P.NRO_SERIE = @NRO_SERIE AND P.FECHA_FIN IS NULL AND P.PRODUCTO_ID = @PRODUCTO_ID AND P.CLIENTE_ID = @CLIENTE_ID)
BEGIN
	SET @OUT='4'--LA SERIE PERTENECE A OTRO EGRESO Y NO PUEDE CAMBIARSE
	RETURN
END

--VALIDO SI LA SERIE TIENE EL MISMO LOTE Y PARTIDA
--SELECT @NRO_LOTE_ANT = NRO_LOTE, @NRO_PARTIDA_ANT = NRO_PARTIDA
--FROM PICKING
--WHERE	CLIENTE_ID = @CLIENTE_ID AND PRODUCTO_ID = @PRODUCTO_ID AND VIAJE_ID = @CODIGO_VIAJE
--		AND NRO_SERIE = @NRO_SERIE_ANT
--
--SELECT @NRO_LOTE_NEW = DD.NRO_LOTE
--		,@NRO_PARTIDA_NEW = DD.NRO_PARTIDA
--FROM RL_DET_DOC_TRANS_POSICION RL
--INNER JOIN DET_DOCUMENTO_TRANSACCION DDT ON (RL.DOC_TRANS_ID = DDT.DOC_TRANS_ID AND RL.NRO_LINEA_TRANS = DDT.NRO_LINEA_TRANS)
--INNER JOIN DET_DOCUMENTO DD ON (DDT.DOCUMENTO_ID = DD.DOCUMENTO_ID AND DDT.NRO_LINEA_DOC = DD.NRO_LINEA)
--INNER JOIN DOCUMENTO D ON (DD.DOCUMENTO_ID = D.DOCUMENTO_ID)
--WHERE DD.NRO_SERIE = @NRO_SERIE AND DD.PRODUCTO_ID = @PRODUCTO_ID AND D.CLIENTE_ID = @CLIENTE_ID
--
--IF (ISNULL(@NRO_LOTE_ANT,'') <> ISNULL(@NRO_LOTE_NEW,'')) OR (ISNULL(@NRO_PARTIDA_ANT,'') <> ISNULL(@NRO_PARTIDA_NEW,''))
--	SET @OUT = '6'

--VALIDO QUE LA SERIE NO ESTÉ EXPLICITADA EN NINGUN DOCUMENTO DE EGRESO PENDIENTE.
IF EXISTS
	(
		SELECT 1 FROM PICKING P
		INNER JOIN DET_DOCUMENTO DE ON (P.DOCUMENTO_ID = DE.DOCUMENTO_ID AND P.NRO_LINEA = DE.NRO_LINEA)
		WHERE	FECHA_FIN IS NULL
				AND DE.NRO_SERIE = @NRO_SERIE
				AND DE.PRODUCTO_ID = @PRODUCTO_ID
				--AND P.VIAJE_ID <> @CODIGO_VIAJE
	)
BEGIN
	SET @OUT = '5'
END
--SI NO VALIDÓ NINGUNA DE LAS ANTERIORES BUSCO QUE LA SERIE ESTE DISPONIBLE PARA EGRESO
IF EXISTS
(SELECT 1 FROM
	(
		SELECT RL.*
		FROM RL_DET_DOC_TRANS_POSICION RL
		INNER JOIN DET_DOCUMENTO_TRANSACCION DDT ON (RL.DOC_TRANS_ID = DDT.DOC_TRANS_ID AND RL.NRO_LINEA_TRANS = DDT.NRO_LINEA_TRANS)
		INNER JOIN DET_DOCUMENTO DD ON (DDT.DOCUMENTO_ID = DD.DOCUMENTO_ID AND DDT.NRO_LINEA_DOC = DD.NRO_LINEA)
		INNER JOIN DOCUMENTO D ON (DD.DOCUMENTO_ID = D.DOCUMENTO_ID)
		INNER JOIN CATEGORIA_LOGICA CL ON (RL.CLIENTE_ID = CL.CLIENTE_ID AND RL.CAT_LOG_ID = CL.CAT_LOG_ID)
		LEFT JOIN ESTADO_MERCADERIA_RL E ON (RL.CLIENTE_ID = E.CLIENTE_ID AND RL.EST_MERC_ID = E.EST_MERC_ID)	
		INNER JOIN NAVE N ON (RL.NAVE_ACTUAL = N.NAVE_ID)
		WHERE D.STATUS = 'D40'
				AND RL.DISPONIBLE = '1'
				AND N.DISP_EGRESO='1'
				AND N.PICKING='1'
				AND CL.DISP_EGRESO='1'
				AND CL.PICKING='1'
				AND ((E.DISP_EGRESO='1' AND E.PICKING='1') OR (RL.EST_MERC_ID IS NULL))
				AND DD.NRO_SERIE = @NRO_SERIE
				AND RL.DOC_TRANS_ID_EGR IS NULL
				AND RL.NRO_LINEA_TRANS_EGR IS NULL
				AND DD.PRODUCTO_ID = @PRODUCTO_ID
				AND D.CLIENTE_ID = @CLIENTE_ID
		UNION
		SELECT RL.*
		FROM RL_DET_DOC_TRANS_POSICION RL
		INNER JOIN DET_DOCUMENTO_TRANSACCION DDT ON (RL.DOC_TRANS_ID = DDT.DOC_TRANS_ID AND RL.NRO_LINEA_TRANS = DDT.NRO_LINEA_TRANS)
		INNER JOIN DET_DOCUMENTO DD ON (DDT.DOCUMENTO_ID = DD.DOCUMENTO_ID AND DDT.NRO_LINEA_DOC = DD.NRO_LINEA)
		INNER JOIN DOCUMENTO D ON (DD.DOCUMENTO_ID = D.DOCUMENTO_ID)
		INNER JOIN CATEGORIA_LOGICA CL ON (RL.CLIENTE_ID = CL.CLIENTE_ID AND RL.CAT_LOG_ID = CL.CAT_LOG_ID)
		LEFT JOIN ESTADO_MERCADERIA_RL E ON (RL.CLIENTE_ID = E.CLIENTE_ID AND RL.EST_MERC_ID = E.EST_MERC_ID)	
		INNER JOIN POSICION P ON (RL.POSICION_ACTUAL = P.POSICION_ID)
		WHERE D.STATUS = 'D40'
				AND RL.DISPONIBLE = '1'
				AND P.PICKING='1'
				AND CL.DISP_EGRESO='1'
				AND CL.PICKING='1'
				AND ((E.DISP_EGRESO='1' AND E.PICKING='1') OR (RL.EST_MERC_ID IS NULL))
				AND DD.NRO_SERIE = @NRO_SERIE
				AND RL.DOC_TRANS_ID_EGR IS NULL
				AND RL.NRO_LINEA_TRANS_EGR IS NULL
				AND DD.PRODUCTO_ID = @PRODUCTO_ID
				AND D.CLIENTE_ID = @CLIENTE_ID
	) X
)
SET @OUT='0'--TODO OK, ESTÁ DISPONIBLE PARA EGRESO
ELSE
SET @OUT='5'--NO ESTÁ DISPONIBLE PARA EGRESO

END
GO

IF @@ERROR <> 0
BEGIN
   IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION
   INSERT INTO #tmpErrors (Error) SELECT 1
   BEGIN TRANSACTION
END
GO

SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[PR_EXISTE_PEDIDO](
 @P_CLIENTE AS VARCHAR(15) OUTPUT
,@P_PEDIDO AS VARCHAR(15)  OUTPUT 
,@P_RETURN AS VARCHAR(3)   OUTPUT 
) 
AS
BEGIN
	SELECT @P_RETURN = COUNT(9) 
	FROM dbo.SYS_INT_DOCUMENTO I
	WHERE I.CLIENTE_ID = @P_CLIENTE
	AND I.DOC_EXT = @P_PEDIDO
END
GO

IF @@ERROR <> 0
BEGIN
   IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION
   INSERT INTO #tmpErrors (Error) SELECT 1
   BEGIN TRANSACTION
END
GO

SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[PR_INVENTARIO_CERRADO]
(@P_DocTransID AS varchar(15) OUTPUT
,@P_Return AS VARCHAR(1) OUTPUT)
AS
BEGIN
	-- INVENTARIO CERRADO
	SELECT @P_Return =  COUNT(9) 
	FROM INVENTARIO I
	WHERE DOC_TRANS_ID = @P_DocTransID
	AND CERRADO = '1'
END
GO

IF @@ERROR <> 0
BEGIN
   IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION
   INSERT INTO #tmpErrors (Error) SELECT 1
   BEGIN TRANSACTION
END
GO

SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
GO

CREATE Procedure [dbo].[PrintEtiPalletPickingGroup]  
@CLIENTE_ID		varchar(100)	output, 
@EtiquetaId		varchar(20)		output, 
@UsuarioImp		varchar(20)		output -- LRojas TrackerID 3806 05/03/2012: Impresora por Usuario
as  
Begin  
 Select @EtiquetaId=ISNULL(etiqueta_id,0) from etiqueta_producto   
 where cliente_id=@CLIENTE_ID  
   and Producto_id='ETI_PALLET_EGR' and tipo_operacion_id='EGR'  
 If @EtiquetaId is null  
 Begin  
  Set @EtiquetaId=0  
 End   
 --Obtengo el grupo de datos.  
 --SELECT  row_number() over (order by )  as numerador     
  
  
-- SELECT  row_number() over (order by [PICKING.VIAJE_ID])  as numerador ,* FROM   
-- (SELECT  P.VIAJE_ID        [PICKING.VIAJE_ID]  
--   ,P.PALLET_PICKING       [PICKING.PALLET_PICKING]  
--   --,SUM(CANT_CONFIRMADA)     [PICKING.CANT_CONFIRMADA]  
--   ,sum(CANT_CONFIRMADA)     [PICKING.CANT_CONFIRMADA]  
--   ,D.NRO_REMITO       [DOCUMENTO_EGR.NRO_REMITO]  
-- FROM PICKING P(NOLOCK) INNER JOIN DOCUMENTO D  
--   ON(D.DOCUMENTO_ID=P.DOCUMENTO_ID)  
--   inner join   
--     (SELECT distinct pp.VIAJE_ID, i.pallet FROM IMPRESION_APF I  
--     INNER JOIN    
--       (SELECT VIAJE_ID, CLIENTE_ID, PALLET_PICKING FROM PICKING   
--       WHERE FECHA_INICIO IS NOT NULL AND FECHA_FIN IS NOT NULL AND USUARIO IS NOT NULL AND CANT_CONFIRMADA IS NOT NULL and cliente_id = @CLIENTE_ID  
--       GROUP BY VIAJE_ID, CLIENTE_ID, PALLET_PICKING) PP  
--         ON (PP.PALLET_PICKING = I.PALLET )  
--     WHERE ((I.IMPRESO IS NULL) OR(I.IMPRESO='0')) AND I.TIPO_ETI = 2  
--     --ORDER BY P.CLIENTE_ID, I.PALLET  
--     ) x   
--    on (x.viaje_id = p.viaje_id and x.pallet = p.pallet_picking)  
-- WHERE p.cliente_id =@CLIENTE_ID  
-- GROUP BY  
--   P.VIAJE_ID,P.PALLET_PICKING, D.NRO_REMITO  
-- ) XX  
-- ORDER BY XX.[PICKING.VIAJE_ID],XX.[PICKING.PALLET_PICKING]  
  
 SELECT  row_number() over (order by [PICKING.VIAJE_ID])  as numerador ,* FROM   
 (SELECT  P.VIAJE_ID        [PICKING.VIAJE_ID]  
   ,P.PALLET_PICKING       [PICKING.PALLET_PICKING]  
   --,SUM(CANT_CONFIRMADA)     [PICKING.CANT_CONFIRMADA]  
   ,sum(CANT_CONFIRMADA)     [PICKING.CANT_CONFIRMADA]  
   ,' '           [DOCUMENTO_EGR.NRO_REMITO]  
 FROM PICKING P(NOLOCK)   
   inner join   
     (SELECT distinct pp.VIAJE_ID, i.pallet FROM IMPRESION_APF I  
     INNER JOIN    
       (SELECT VIAJE_ID, CLIENTE_ID, PALLET_PICKING FROM PICKING   
       WHERE FECHA_INICIO IS NOT NULL AND FECHA_FIN IS NOT NULL AND USUARIO IS NOT NULL AND CANT_CONFIRMADA IS NOT NULL and cliente_id = @CLIENTE_ID  
       GROUP BY VIAJE_ID, CLIENTE_ID, PALLET_PICKING) PP  
         ON (PP.PALLET_PICKING = I.PALLET )  
     WHERE ((I.IMPRESO IS NULL) OR(I.IMPRESO='0')) AND I.TIPO_ETI = 2  
       AND I.USUARIO_IMP = @UsuarioImp -- LRojas TrackerID 3806 05/03/2012: Impresora por Usuario
     --ORDER BY P.CLIENTE_ID, I.PALLET  
     ) x   
    on (x.viaje_id = p.viaje_id and x.pallet = p.pallet_picking)  
 WHERE p.cliente_id =@CLIENTE_ID  
 GROUP BY  
   P.VIAJE_ID,P.PALLET_PICKING  
 ) XX  
 ORDER BY XX.[PICKING.VIAJE_ID],XX.[PICKING.PALLET_PICKING]  
  
  
   
-------------------------------------------------------------------  
End--Fin procedure.
GO

IF @@ERROR <> 0
BEGIN
   IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION
   INSERT INTO #tmpErrors (Error) SELECT 1
   BEGIN TRANSACTION
END
GO

SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[ProductoTienePropiedades]
(@CLIENTE_ID		VARCHAR(15) OUTPUT
,@VIAJE_ID			VARCHAR(100) OUTPUT
,@PRODUCTO_ID		VARCHAR(30) OUTPUT
,@RESULTADO			int OUTPUT
,@NRO_LOTE			VARCHAR(100) OUTPUT
,@NRO_PARTIDA		VARCHAR(100) OUTPUT
,@NRO_SERIE			VARCHAR(50) OUTPUT)
AS
BEGIN
	DECLARE @CANT NUMERIC(20,0)

	SET @CANT=0

	SELECT @CANT = COUNT(*) FROM
		(SELECT	DISTINCT P.PRODUCTO_ID, P.NRO_LOTE, P.NRO_PARTIDA, P.NRO_SERIE
		FROM	PICKING P
		INNER JOIN DET_DOCUMENTO DD ON (P.DOCUMENTO_ID = DD.DOCUMENTO_ID AND P.NRO_LINEA = DD.NRO_LINEA)
		INNER JOIN DOCUMENTO D ON (DD.DOCUMENTO_ID = D.DOCUMENTO_ID)
		WHERE	P.CLIENTE_ID = @CLIENTE_ID
				AND D.NRO_REMITO = @VIAJE_ID
				AND P.PRODUCTO_ID = @PRODUCTO_ID
				AND (P.NRO_LOTE = @NRO_LOTE or @NRO_LOTE='' or @NRO_LOTE IS NULL)
				AND (P.NRO_PARTIDA = @NRO_PARTIDA or @NRO_PARTIDA='' OR @NRO_PARTIDA IS NULL)
				AND (P.NRO_SERIE = @NRO_SERIE or @NRO_SERIE ='' OR @NRO_SERIE IS NULL)
				) X

	SET @RESULTADO=@CANT
END
GO

IF @@ERROR <> 0
BEGIN
   IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION
   INSERT INTO #tmpErrors (Error) SELECT 1
   BEGIN TRANSACTION
END
GO

SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		LRojas
-- Create date: 19/04/2012
-- Description:	Procedimiento para quitar unidades empaquetadas
-- =============================================
CREATE PROCEDURE [dbo].[quitar_producto_empaque]
	@CLIENTE_ID         as varchar(15) OUTPUT,
	@PEDIDO_ID          as varchar(30) OUTPUT,
	@NRO_LOTE			AS VARCHAR(100) OUTPUT,
	@NRO_PARTIDA		AS VARCHAR(100) OUTPUT,
	@NRO_SERIE			AS VARCHAR(50) OUTPUT,
	@PRODUCTO_ID        as varchar(30) OUTPUT,
    @NRO_CONTENEDORA    as numeric(20) OUTPUT,
    @CANT_CONTROLADA    as numeric(20,5) OUTPUT
AS
BEGIN
	SET NOCOUNT ON;
    
    DECLARE @NRO_LINEA as numeric(10),
            @CANT_CONFIRMADA as numeric(20,5),
            @CANTIDAD_EMPAQUE as numeric(20,5),
            @CANTIDAD as numeric(20,5)
    
    DELETE TMP_EMPAQUE_CONTENEDORA WHERE CLIENTE_ID = @CLIENTE_ID AND NRO_REMITO = @PEDIDO_ID AND PRODUCTO_ID = @PRODUCTO_ID AND ISNULL(NRO_LOTE,'') = ISNULL(@NRO_LOTE,'') AND ISNULL(NRO_PARTIDA,'') = ISNULL(@NRO_PARTIDA,'') AND ISNULL(NRO_SERIE,'') = ISNULL(@NRO_SERIE,'')
    
    INSERT INTO TMP_EMPAQUE_CONTENEDORA
    SELECT D.NRO_REMITO, P.*
    FROM DOCUMENTO D INNER JOIN PICKING P ON(D.DOCUMENTO_ID = P.DOCUMENTO_ID) 
    WHERE D.CLIENTE_ID = @CLIENTE_ID AND D.NRO_REMITO = @PEDIDO_ID AND P.PRODUCTO_ID = @PRODUCTO_ID
    AND P.PALLET_PICKING = @NRO_CONTENEDORA AND ISNULL(NRO_LOTE,'') = ISNULL(@NRO_LOTE,'') AND ISNULL(NRO_PARTIDA,'') = ISNULL(@NRO_PARTIDA,'') AND ISNULL(NRO_SERIE,'') = ISNULL(@NRO_SERIE,'')
	UNION
    SELECT D.NRO_REMITO, P.*
    FROM DOCUMENTO D INNER JOIN PICKING P ON(D.DOCUMENTO_ID = P.DOCUMENTO_ID) 
    WHERE D.CLIENTE_ID = @CLIENTE_ID AND D.NRO_REMITO = @PEDIDO_ID AND P.PRODUCTO_ID = @PRODUCTO_ID
    AND P.PALLET_CONTROLADO = '0' AND ISNULL(NRO_LOTE,'') = ISNULL(@NRO_LOTE,'') AND ISNULL(NRO_PARTIDA,'') = ISNULL(@NRO_PARTIDA,'') AND ISNULL(NRO_SERIE,'') = ISNULL(@NRO_SERIE,'')
	
    DECLARE cur_linea CURSOR FOR
    SELECT DISTINCT NRO_LINEA, CANT_CONFIRMADA
    FROM TMP_EMPAQUE_CONTENEDORA
    WHERE CLIENTE_ID = @CLIENTE_ID AND NRO_REMITO = @PEDIDO_ID AND PRODUCTO_ID = @PRODUCTO_ID
    AND PALLET_CONTROLADO <> '0' AND ISNULL(NRO_LOTE,'') = ISNULL(@NRO_LOTE,'') AND ISNULL(NRO_PARTIDA,'') = ISNULL(@NRO_PARTIDA,'') AND ISNULL(NRO_SERIE,'') = ISNULL(@NRO_SERIE,'')
    
    OPEN cur_linea 
    FETCH cur_linea
    INTO @NRO_LINEA, @CANT_CONFIRMADA
    
    WHILE (@@FETCH_STATUS = 0 AND @CANT_CONTROLADA > 0)
        BEGIN
            
            IF @CANT_CONTROLADA > @CANT_CONFIRMADA
                BEGIN
                    SET @CANTIDAD_EMPAQUE = @CANT_CONFIRMADA
                    SET @CANT_CONTROLADA = @CANT_CONTROLADA - @CANT_CONFIRMADA
                END
            ELSE
                BEGIN
                    SET @CANTIDAD_EMPAQUE = @CANT_CONTROLADA
                    SET @CANT_CONTROLADA = @CANT_CONTROLADA - @CANT_CONFIRMADA
                END
            
            UPDATE TMP_EMPAQUE_CONTENEDORA
            SET CANTIDAD = CANT_CONFIRMADA - @CANTIDAD_EMPAQUE,
                CANT_CONFIRMADA = CANT_CONFIRMADA - @CANTIDAD_EMPAQUE
            WHERE NRO_LINEA = @NRO_LINEA AND CLIENTE_ID = @CLIENTE_ID AND NRO_REMITO = @PEDIDO_ID 
            AND PRODUCTO_ID = @PRODUCTO_ID AND PALLET_PICKING = @NRO_CONTENEDORA AND PALLET_CONTROLADO <> '0'
            
            SELECT @CANTIDAD = CANTIDAD
            FROM TMP_EMPAQUE_CONTENEDORA
            WHERE NRO_LINEA = @NRO_LINEA AND CLIENTE_ID = @CLIENTE_ID AND NRO_REMITO = @PEDIDO_ID 
            AND PRODUCTO_ID = @PRODUCTO_ID AND PALLET_PICKING = @NRO_CONTENEDORA AND PALLET_CONTROLADO <> '0'
            AND CANT_CONFIRMADA = 0
            
            IF @CANTIDAD IS NULL
				SET @CANTIDAD = 0
            
            IF EXISTS(
                    SELECT 1 FROM TMP_EMPAQUE_CONTENEDORA 
                    WHERE NRO_LINEA = @NRO_LINEA AND CLIENTE_ID = @CLIENTE_ID 
                    AND NRO_REMITO = @PEDIDO_ID AND PRODUCTO_ID = @PRODUCTO_ID  
                    AND PALLET_CONTROLADO = '0'
                )
                BEGIN
                    UPDATE TMP_EMPAQUE_CONTENEDORA
                    SET CANTIDAD = CANTIDAD + @CANTIDAD_EMPAQUE + @CANTIDAD,
                        CANT_CONFIRMADA = CANT_CONFIRMADA + @CANTIDAD_EMPAQUE
                    WHERE NRO_LINEA = @NRO_LINEA AND CLIENTE_ID = @CLIENTE_ID 
                    AND NRO_REMITO = @PEDIDO_ID AND PRODUCTO_ID = @PRODUCTO_ID 
                    AND PALLET_CONTROLADO = '0'
                END
            ELSE
                INSERT INTO TMP_EMPAQUE_CONTENEDORA
                SELECT D.NRO_REMITO, P.PICKING_ID, P.DOCUMENTO_ID, P.NRO_LINEA, P.CLIENTE_ID, P.PRODUCTO_ID, P.VIAJE_ID, P.TIPO_CAJA, P.DESCRIPCION, 
                       P.CANTIDAD - (P.CANT_CONFIRMADA - @CANTIDAD_EMPAQUE) [CANTIDAD], 
                       P.NAVE_COD, P.POSICION_COD, P.RUTA, P.PROP1, P.FECHA_INICIO, P.FECHA_FIN, P.USUARIO, 
                       @CANTIDAD_EMPAQUE [CANT_CONFIRMADA], -- Cantidad Controlada
                       @NRO_CONTENEDORA [PALLET_PICKING], -- Nro Contenedora
                       P.SALTO_PICKING, 
                       '0' [PALLET_CONTROLADO], -- No esta en Contenedora
                       P.USUARIO_CONTROL_PICK, P.ST_ETIQUETAS, P.ST_CAMION, P.FACTURADO, P.FIN_PICKING, P.ST_CONTROL_EXP, P.FECHA_CONTROL_PALLET, 
                       P.TERMINAL_CONTROL_PALLET, P.FECHA_CONTROL_EXP, P.USUARIO_CONTROL_EXP, P.TERMINAL_CONTROL_EXP, P.FECHA_CONTROL_FAC, 
                       P.USUARIO_CONTROL_FAC, P.TERMINAL_CONTROL_FAC, P.VEHICULO_ID, P.PALLET_COMPLETO, P.HIJO, P.QTY_CONTROLADO, P.PALLET_FINAL, 
                       P.PALLET_CERRADO, P.USUARIO_PF, P.TERMINAL_PF, P.REMITO_IMPRESO, P.NRO_REMITO_PF, P.PICKING_ID_REF, P.BULTOS_CONTROLADOS, 
                       P.BULTOS_NO_CONTROLADOS, P.FLG_PALLET_HOMBRE, P.TRANSF_TERMINADA,P.NRO_LOTE,P.NRO_PARTIDA,P.NRO_SERIE
                FROM DOCUMENTO D INNER JOIN PICKING P ON(D.DOCUMENTO_ID = P.DOCUMENTO_ID) 
                WHERE P.NRO_LINEA = @NRO_LINEA AND D.CLIENTE_ID = @CLIENTE_ID AND D.NRO_REMITO = @PEDIDO_ID AND P.PRODUCTO_ID = @PRODUCTO_ID 
                AND PALLET_PICKING = @NRO_CONTENEDORA AND P.PALLET_CONTROLADO <> '0'
            
            DELETE PICKING
            WHERE CLIENTE_ID = @CLIENTE_ID AND PRODUCTO_ID = @PRODUCTO_ID 
            AND PALLET_PICKING = @NRO_CONTENEDORA AND PALLET_CONTROLADO <> '0'
            AND PICKING_ID IN(SELECT PICKING_ID FROM TMP_EMPAQUE_CONTENEDORA 
                            WHERE NRO_LINEA = @NRO_LINEA AND CLIENTE_ID = @CLIENTE_ID 
                            AND NRO_REMITO = @PEDIDO_ID AND PRODUCTO_ID = @PRODUCTO_ID 
                            AND PALLET_PICKING = @NRO_CONTENEDORA AND PALLET_CONTROLADO <> '0' 
                            AND CANT_CONFIRMADA = 0)
            
            UPDATE PICKING
            SET CANTIDAD = TMP.CANTIDAD,
                CANT_CONFIRMADA = TMP.CANT_CONFIRMADA
            FROM TMP_EMPAQUE_CONTENEDORA TMP 
            WHERE TMP.NRO_LINEA = @NRO_LINEA AND TMP.CLIENTE_ID = @CLIENTE_ID AND TMP.NRO_REMITO = @PEDIDO_ID
            AND TMP.PRODUCTO_ID = @PRODUCTO_ID AND TMP.PALLET_CONTROLADO <> '0'
            AND PICKING.PICKING_ID = TMP.PICKING_ID
            
            IF NOT EXISTS(SELECT 1 
                            FROM DOCUMENTO D INNER JOIN PICKING P ON(D.DOCUMENTO_ID = P.DOCUMENTO_ID) 
                            WHERE P.NRO_LINEA = @NRO_LINEA AND D.CLIENTE_ID = @CLIENTE_ID 
                            AND D.NRO_REMITO = @PEDIDO_ID AND PRODUCTO_ID = @PRODUCTO_ID 
                            AND P.PALLET_CONTROLADO = '0')
                INSERT INTO PICKING(DOCUMENTO_ID, NRO_LINEA, CLIENTE_ID, PRODUCTO_ID, VIAJE_ID, TIPO_CAJA, DESCRIPCION, CANTIDAD, NAVE_COD, 
                POSICION_COD, RUTA, PROP1, FECHA_INICIO, FECHA_FIN, USUARIO, CANT_CONFIRMADA, PALLET_PICKING, SALTO_PICKING, PALLET_CONTROLADO, 
                USUARIO_CONTROL_PICK, ST_ETIQUETAS, ST_CAMION, FACTURADO, FIN_PICKING, ST_CONTROL_EXP, FECHA_CONTROL_PALLET, 
                TERMINAL_CONTROL_PALLET, FECHA_CONTROL_EXP, USUARIO_CONTROL_EXP, TERMINAL_CONTROL_EXP, FECHA_CONTROL_FAC, USUARIO_CONTROL_FAC, 
                TERMINAL_CONTROL_FAC, VEHICULO_ID, PALLET_COMPLETO, HIJO, QTY_CONTROLADO, PALLET_FINAL, PALLET_CERRADO, USUARIO_PF, TERMINAL_PF, 
                REMITO_IMPRESO, NRO_REMITO_PF, PICKING_ID_REF, BULTOS_CONTROLADOS, BULTOS_NO_CONTROLADOS, FLG_PALLET_HOMBRE, TRANSF_TERMINADA,NRO_LOTE,NRO_PARTIDA,NRO_SERIE)
                SELECT DOCUMENTO_ID, NRO_LINEA, CLIENTE_ID, PRODUCTO_ID, VIAJE_ID, TIPO_CAJA, DESCRIPCION, CANTIDAD, NAVE_COD, POSICION_COD, 
                RUTA, PROP1, FECHA_INICIO, FECHA_FIN, USUARIO, CANT_CONFIRMADA, PALLET_PICKING, SALTO_PICKING, PALLET_CONTROLADO, USUARIO_CONTROL_PICK, 
                ST_ETIQUETAS, ST_CAMION, FACTURADO, FIN_PICKING, ST_CONTROL_EXP, FECHA_CONTROL_PALLET, TERMINAL_CONTROL_PALLET, FECHA_CONTROL_EXP, 
                USUARIO_CONTROL_EXP, TERMINAL_CONTROL_EXP, FECHA_CONTROL_FAC, USUARIO_CONTROL_FAC, TERMINAL_CONTROL_FAC, VEHICULO_ID, PALLET_COMPLETO, 
                HIJO, QTY_CONTROLADO, PALLET_FINAL, PALLET_CERRADO, USUARIO_PF, TERMINAL_PF, REMITO_IMPRESO, NRO_REMITO_PF, PICKING_ID_REF, 
                BULTOS_CONTROLADOS, BULTOS_NO_CONTROLADOS, FLG_PALLET_HOMBRE, TRANSF_TERMINADA,NRO_LOTE,NRO_PARTIDA,NRO_SERIE
                FROM TMP_EMPAQUE_CONTENEDORA
                WHERE NRO_LINEA = @NRO_LINEA AND CLIENTE_ID = @CLIENTE_ID 
                AND NRO_REMITO = @PEDIDO_ID AND PRODUCTO_ID = @PRODUCTO_ID 
                AND PALLET_PICKING = @NRO_CONTENEDORA AND PALLET_CONTROLADO = '0'
            ELSE
                UPDATE PICKING
                SET CANTIDAD = TMP.CANTIDAD,
                    CANT_CONFIRMADA = TMP.CANT_CONFIRMADA
                FROM TMP_EMPAQUE_CONTENEDORA TMP 
                WHERE TMP.NRO_LINEA = @NRO_LINEA AND TMP.CLIENTE_ID = @CLIENTE_ID 
                AND TMP.NRO_REMITO = @PEDIDO_ID AND TMP.PRODUCTO_ID = @PRODUCTO_ID 
                AND PICKING.PICKING_ID = TMP.PICKING_ID AND PICKING.PALLET_PICKING = TMP.PALLET_PICKING
                AND PICKING.PALLET_CONTROLADO = '0'
        
            FETCH cur_linea
            INTO @NRO_LINEA, @CANT_CONFIRMADA
        END
    
    CLOSE cur_linea 
    DEALLOCATE cur_linea
    
    DELETE TMP_EMPAQUE_CONTENEDORA WHERE CLIENTE_ID = @CLIENTE_ID AND NRO_REMITO = @PEDIDO_ID AND PRODUCTO_ID = @PRODUCTO_ID AND ISNULL(NRO_LOTE,'') = ISNULL(@NRO_LOTE,'') AND ISNULL(NRO_PARTIDA,'') = ISNULL(@NRO_PARTIDA,'') AND ISNULL(NRO_SERIE,'') = ISNULL(@NRO_SERIE,'')

END
GO

IF @@ERROR <> 0
BEGIN
   IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION
   INSERT INTO #tmpErrors (Error) SELECT 1
   BEGIN TRANSACTION
END
GO

SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[RealizarCargaDeSeries]
(@IDPROCESO NUMERIC(20,0) OUTPUT)
AS
BEGIN

DECLARE @err VARCHAR(100)
	
SET NOCOUNT ON

SET XACT_ABORT ON
  
IF OBJECT_ID('tempdb..#BULTOS') IS NOT NULL
    DROP TABLE #BULTOS

IF OBJECT_ID('tempdb..#PRODUCTOS') IS NOT NULL
    DROP TABLE #PRODUCTOS
    
IF OBJECT_ID('tempdb..#SERIES') IS NOT NULL
    DROP TABLE #SERIES
    
DECLARE @CLIENTE_ID AS VARCHAR(15)
DECLARE @NRO_BULTO AS VARCHAR(100)
DECLARE @PRODUCTO_ID AS VARCHAR(30)
DECLARE @SERIE AS VARCHAR(100)
DECLARE @CANTIDAD AS NUMERIC(20,5)
DECLARE @CURRL AS CURSOR
DECLARE @CURDATOS AS CURSOR
DECLARE @CURCANT AS CURSOR
DECLARE @CURSERIES AS CURSOR
DECLARE @DOCUMENTO_ID NUMERIC(20,0)
DECLARE @NRO_LINEA NUMERIC(20,0)
DECLARE @NUMSERIE AS VARCHAR(100)
DECLARE @NRO_LINEA_NEW AS NUMERIC(20,0)
DECLARE @NRO_LINEA_NEW_TRANS AS NUMERIC(20,0)
DECLARE @RL_ID AS NUMERIC(20,0)
DECLARE @CANTIDADRL AS NUMERIC(20,5)
DECLARE @CANTSTOCK AS NUMERIC(20,5)
DECLARE @SALGOCURRL AS VARCHAR(1)

  UPDATE CargaSeriesLog SET VALIDA = '1' WHERE IDPROCESO = @IDPROCESO
  DELETE FROM ResultadosCargaSeriesLog WHERE IDPROCESO = @IDPROCESO

  --VALIDO QUE NO HAYAN SERIES DUPLICADAS.
  IF EXISTS (SELECT IDPROCESO,CLIENTE_ID, NRO_BULTO, PRODUCTO_ID, SERIE FROM CargaSeriesLog WHERE IDPROCESO = @IDPROCESO GROUP BY IDPROCESO,CLIENTE_ID, NRO_BULTO, PRODUCTO_ID, SERIE HAVING COUNT(*)>1)
    INSERT INTO ResultadosCargaSeriesLog values (@IDPROCESO,'Existen series duplicadas en el archivo cargado.',0)
    
  --controlo si surgió algun error, si es así salgo
  IF EXISTS (SELECT 1 FROM ResultadosCargaSeriesLog WHERE IDPROCESO = @IDPROCESO)
  BEGIN
    UPDATE CargaSeriesLog SET VALIDA='0' WHERE IDPROCESO = @IDPROCESO
    RETURN
  END
    
  --VALIDO EL CLIENTE_ID
  INSERT INTO ResultadosCargaSeriesLog
  SELECT DISTINCT CS.IDPROCESO, 'El Cliente ' + CS.CLIENTE_ID + ' no existe.',1
  FROM CargaSeriesLog CS
  WHERE CS.IDPROCESO = @IDPROCESO
        and not exists (SELECT 1 FROM CLIENTE WHERE CLIENTE_ID = CS.CLIENTE_ID)

  UPDATE CargaSeriesLog SET VALIDA = '0' WHERE IDPROCESO = @IDPROCESO AND CLIENTE_ID NOT IN (SELECT CLIENTE_ID FROM CLIENTE)
  
  --VALIDO QUE EXISTA LA CONETENEDORA EN STOCK
  SELECT DISTINCT CS.NRO_BULTO INTO #BULTOS
  FROM CargaSeriesLog CS
  WHERE   CS.IDPROCESO = @IDPROCESO
          AND NOT EXISTS 
            (SELECT 1
            FROM DOCUMENTO D
            INNER JOIN DET_DOCUMENTO DD ON (D.DOCUMENTO_ID = DD.DOCUMENTO_ID)
            INNER JOIN DET_DOCUMENTO_TRANSACCION DDT ON (DD.DOCUMENTO_ID = DDT.DOCUMENTO_ID AND DD.NRO_LINEA = DDT.NRO_LINEA_DOC)
            INNER JOIN RL_DET_DOC_TRANS_POSICION RL ON (DDT.DOC_TRANS_ID = RL.DOC_TRANS_ID AND DDT.NRO_LINEA_TRANS = RL.NRO_LINEA_TRANS)
            WHERE D.STATUS = 'D30' AND DD.NRO_BULTO IS NOT NULL AND DD.NRO_BULTO = CS.NRO_BULTO)
  
  INSERT INTO ResultadosCargaSeriesLog
  SELECT @IDPROCESO, 'La contenedora ' + NRO_BULTO + ' no existe en stock.',2
  FROM #BULTOS
  
  UPDATE CargaSeriesLog SET VALIDA = '0' WHERE IDPROCESO = @IDPROCESO
          AND NRO_BULTO IN (SELECT NRO_BULTO FROM #BULTOS)
  
  --VALIDO QUE LOS PRODUCTOS TENGAN SERIE AL INGRESO
  SELECT DISTINCT CS.CLIENTE_ID, CS.PRODUCTO_ID INTO #PRODUCTOSFLAG
  FROM CargaSeriesLog CS
  WHERE   CS.IDPROCESO = @IDPROCESO
          AND EXISTS 
            (SELECT 1
            FROM PRODUCTO P
            WHERE CLIENTE_ID = CS.CLIENTE_ID AND PRODUCTO_ID = CS.PRODUCTO_ID AND ISNULL(SERIE_ING,'0')='0')
  
  INSERT INTO ResultadosCargaSeriesLog
  SELECT @IDPROCESO, 'El producto ' + PRODUCTO_ID + ' no tiene habilitada la carga de Series.',3
  FROM #PRODUCTOSFLAG
  
  UPDATE CargaSeriesLog
  SET VALIDA = '0'
  FROM CargaSeriesLog a
  JOIN #PRODUCTOSFLAG b ON a.CLIENTE_ID = b.CLIENTE_ID AND a.PRODUCTO_ID = b.PRODUCTO_ID
  WHERE a.IDPROCESO = @IDPROCESO
  
  --VALIDO QUE EXISTA PRODUCTO/CONETENEDORA EN STOCK
  SELECT DISTINCT CS.CLIENTE_ID, CS.NRO_BULTO, CS.PRODUCTO_ID INTO #PRODUCTOS
  FROM CargaSeriesLog CS
  WHERE   CS.IDPROCESO = @IDPROCESO
          AND NOT EXISTS 
            (SELECT 1
            FROM DOCUMENTO D
            INNER JOIN DET_DOCUMENTO DD ON (D.DOCUMENTO_ID = DD.DOCUMENTO_ID)
            INNER JOIN DET_DOCUMENTO_TRANSACCION DDT ON (DD.DOCUMENTO_ID = DDT.DOCUMENTO_ID AND DD.NRO_LINEA = DDT.NRO_LINEA_DOC)
            INNER JOIN RL_DET_DOC_TRANS_POSICION RL ON (DDT.DOC_TRANS_ID = RL.DOC_TRANS_ID AND DDT.NRO_LINEA_TRANS = RL.NRO_LINEA_TRANS)
            WHERE D.STATUS = 'D30' AND DD.NRO_BULTO IS NOT NULL AND DD.CLIENTE_ID = CS.CLIENTE_ID AND DD.NRO_BULTO = CS.NRO_BULTO AND DD.PRODUCTO_ID = CS.PRODUCTO_ID)
  
  INSERT INTO ResultadosCargaSeriesLog
  SELECT @IDPROCESO, 'El producto ' + PRODUCTO_ID + ' no existe dentro de la contenedora ' + NRO_BULTO + '.',4
  FROM #PRODUCTOS
  
  UPDATE CargaSeriesLog
  SET VALIDA = '0'
  FROM CargaSeriesLog a
  JOIN #PRODUCTOS b ON a.CLIENTE_ID = b.CLIENTE_ID AND a.NRO_BULTO = b.NRO_BULTO AND a.PRODUCTO_ID = b.PRODUCTO_ID
  WHERE a.IDPROCESO = @IDPROCESO
  
  --CONTROLO QUE LA SERIE NO EXISTA
  SELECT CS.CLIENTE_ID, CS.PRODUCTO_ID, CS.SERIE INTO #SERIES FROM CargaSeriesLog CS
  WHERE   CS.IDPROCESO = @IDPROCESO
          AND EXISTS 
            (SELECT 1
            FROM DOCUMENTO D
            INNER JOIN DET_DOCUMENTO DD ON (D.DOCUMENTO_ID = DD.DOCUMENTO_ID)
            INNER JOIN DET_DOCUMENTO_TRANSACCION DDT ON (DD.DOCUMENTO_ID = DDT.DOCUMENTO_ID AND DD.NRO_LINEA = DDT.NRO_LINEA_DOC)
            INNER JOIN RL_DET_DOC_TRANS_POSICION RL ON (DDT.DOC_TRANS_ID = RL.DOC_TRANS_ID AND DDT.NRO_LINEA_TRANS = RL.NRO_LINEA_TRANS)
            WHERE DD.CLIENTE_ID = CS.CLIENTE_ID AND DD.PRODUCTO_ID = CS.PRODUCTO_ID AND DD.NRO_SERIE = CS.SERIE)
  
  INSERT INTO ResultadosCargaSeriesLog
  SELECT @IDPROCESO, 'El número de Serie ' + SERIE + ' ya existe.',5
  FROM #SERIES
  
  UPDATE CargaSeriesLog SET VALIDA = '0' WHERE IDPROCESO = @IDPROCESO AND SERIE IN
    (SELECT SERIE FROM #SERIES)

--CONTROLO CANTIDADES DE PRODUCTOS EN LA CONTENEDORA VERSUS LO QUE HAY EN STOCK
--ESTE CONTROL ES CON LOS VALIDADOS = '1'

SET @CURCANT = CURSOR FOR
SELECT DISTINCT CLIENTE_ID, NRO_BULTO, PRODUCTO_ID, COUNT(*)
FROM CargaSeriesLog
WHERE IDPROCESO = @IDPROCESO AND VALIDA = '1'
GROUP BY CLIENTE_ID, NRO_BULTO, PRODUCTO_ID

OPEN @CURCANT
FETCH NEXT FROM @CURCANT INTO @CLIENTE_ID, @NRO_BULTO, @PRODUCTO_ID, @CANTIDAD

WHILE @@FETCH_STATUS = 0
BEGIN
  
  SELECT @CANTSTOCK = SUM(RL.CANTIDAD)
  FROM DOCUMENTO D
  INNER JOIN DET_DOCUMENTO DD ON (D.DOCUMENTO_ID = DD.DOCUMENTO_ID)
  INNER JOIN DET_DOCUMENTO_TRANSACCION DDT ON (DD.DOCUMENTO_ID = DDT.DOCUMENTO_ID AND DD.NRO_LINEA = DDT.NRO_LINEA_DOC)
  INNER JOIN RL_DET_DOC_TRANS_POSICION RL ON (DDT.DOC_TRANS_ID = RL.DOC_TRANS_ID AND DDT.NRO_LINEA_TRANS = RL.NRO_LINEA_TRANS)
  WHERE D.STATUS = 'D30' AND D.CLIENTE_ID = @CLIENTE_ID
        AND DD.NRO_BULTO IS NOT NULL 
        AND DD.NRO_BULTO = @NRO_BULTO
        AND DD.PRODUCTO_ID = @PRODUCTO_ID
        
  IF NOT (@CANTSTOCK=@CANTIDAD)
  BEGIN
    INSERT INTO ResultadosCargaSeriesLog
    VALUES (@IDPROCESO, 'La cantidad de series del producto ' + @PRODUCTO_ID + ' en la contenedora ' + @NRO_BULTO + ' ingresadas es distinta a la cantidad del producto en stock.',6)
    UPDATE CargaSeriesLog SET VALIDA = '0' WHERE CLIENTE_ID = @CLIENTE_ID AND NRO_BULTO = @NRO_BULTO AND PRODUCTO_ID = @PRODUCTO_ID
  END

  FETCH NEXT FROM @CURCANT INTO @CLIENTE_ID, @NRO_BULTO, @PRODUCTO_ID, @CANTIDAD
END

CLOSE @CURCANT
DEALLOCATE @CURCANT

--controlo si surgió algun error, si es así salgo
IF EXISTS (SELECT 1 FROM ResultadosCargaSeriesLog WHERE IDPROCESO = @IDPROCESO)
BEGIN
  UPDATE CargaSeriesLog SET VALIDA='0' WHERE IDPROCESO = @IDPROCESO
  RETURN
END

--AHORA TENGO QUE INSERTAR LAS SERIES.
  BEGIN TRY
			BEGIN TRANSACTION

      --PRIMERO CONSIGO DATOS GRALES, CLIENTE_ID, NRO_BULTO, PRODUCTO_ID, SERIE
      --LUEGO BUSCO LAS RL CON ESOS DATOS.
      --POR CADA RL BUSCO TODAS LAS SERIES VALIDADAS Y NO CARGADAS
      --POR CADA UNA HAGO EL INSERT/UPDATE
      
      SET @CURDATOS = CURSOR FOR
      SELECT CLIENTE_ID, NRO_BULTO, PRODUCTO_ID, SERIE
      FROM CargaSeriesLog
      WHERE ISNULL(VALIDA,'0')='1'
            AND ISNULL(CARGADA,'0')='0'
            AND IDPROCESO = @IDPROCESO
            
      OPEN @CURDATOS
      FETCH NEXT FROM @CURDATOS INTO @CLIENTE_ID, @NRO_BULTO, @PRODUCTO_ID, @SERIE
      
      WHILE @@FETCH_STATUS = 0
      BEGIN
        --POR CADA DATO GRAL BUSCO LAS RL
        SET @CURRL = CURSOR FOR
        SELECT RL.RL_ID, RL.CANTIDAD, DD.DOCUMENTO_ID, DD.NRO_LINEA
        FROM RL_DET_DOC_TRANS_POSICION RL
        INNER JOIN DET_DOCUMENTO_TRANSACCION DDT ON (RL.DOC_TRANS_ID = DDT.DOC_TRANS_ID AND RL.NRO_LINEA_TRANS = DDT.NRO_LINEA_TRANS)
        INNER JOIN DET_DOCUMENTO DD ON (DDT.DOCUMENTO_ID = DD.DOCUMENTO_ID AND DDT.NRO_LINEA_DOC = DD.NRO_LINEA)
        WHERE DD.CLIENTE_ID = @CLIENTE_ID
              AND DD.NRO_BULTO IS NOT NULL
              AND DD.NRO_BULTO = @NRO_BULTO
              AND DD.PRODUCTO_ID = @PRODUCTO_ID
        ORDER BY RL.CANTIDAD
        
        OPEN @CURRL
        FETCH NEXT FROM @CURRL INTO @RL_ID, @CANTIDADRL, @DOCUMENTO_ID, @NRO_LINEA
        
        WHILE @@FETCH_STATUS=0
        BEGIN
        
          SET @CURSERIES = CURSOR FOR
          SELECT SERIE
          FROM CargaSeriesLog
          WHERE ISNULL(VALIDA,'0')='1'
                AND ISNULL(CARGADA,'0')='0'
                AND IDPROCESO = @IDPROCESO
                AND CLIENTE_ID = @CLIENTE_ID
                AND NRO_BULTO = @NRO_BULTO
                AND PRODUCTO_ID = @PRODUCTO_ID
          
          OPEN @CURSERIES
          FETCH NEXT FROM @CURSERIES INTO @SERIE
          
          SET @SALGOCURRL='0'
          WHILE @@FETCH_STATUS=0 AND @SALGOCURRL='0'
          BEGIN
            
            IF (@CANTIDADRL=1)
            BEGIN
              UPDATE DET_DOCUMENTO SET NRO_SERIE = @SERIE WHERE DOCUMENTO_ID = @DOCUMENTO_ID AND NRO_LINEA = @NRO_LINEA
              UPDATE CargaSeriesLog SET CARGADA = '1' WHERE IDPROCESO = @IDPROCESO AND NRO_BULTO = @NRO_BULTO AND PRODUCTO_ID = @PRODUCTO_ID AND SERIE = @SERIE
              SET @SALGOCURRL='1'
            END
            ELSE
            BEGIN
              --LA CANTIDAD EN RL ES MAYOR A 1
              SELECT @NRO_LINEA_NEW = MAX(NRO_LINEA)+1 FROM DET_DOCUMENTO WHERE DOCUMENTO_ID = @DOCUMENTO_ID
              
              INSERT INTO DET_DOCUMENTO
              SELECT  
              DOCUMENTO_ID
              ,@NRO_LINEA_NEW
              ,CLIENTE_ID
              ,PRODUCTO_ID
              ,1
              ,@SERIE
              ,NRO_SERIE_PADRE
              ,EST_MERC_ID
              ,CAT_LOG_ID
              ,NRO_BULTO
              ,DESCRIPCION
              ,NRO_LOTE
              ,FECHA_VENCIMIENTO
              ,NRO_DESPACHO
              ,NRO_PARTIDA
              ,UNIDAD_ID
              ,PESO
              ,UNIDAD_PESO
              ,VOLUMEN
              ,UNIDAD_VOLUMEN
              ,BUSC_INDIVIDUAL
              ,TIE_IN
              ,NRO_TIE_IN_PADRE
              ,NRO_TIE_IN
              ,ITEM_OK
              ,CAT_LOG_ID_FINAL
              ,MONEDA_ID
              ,COSTO
              ,PROP1
              ,PROP2
              ,PROP3
              ,LARGO
              ,ALTO
              ,ANCHO
              ,VOLUMEN_UNITARIO
              ,PESO_UNITARIO
              ,CANT_SOLICITADA
              ,TRACE_BACK_ORDER
              FROM DET_DOCUMENTO
              WHERE DOCUMENTO_ID = @DOCUMENTO_ID
                    AND NRO_LINEA = @NRO_LINEA
                    
              SELECT @NRO_LINEA_NEW_TRANS = MAX(NRO_LINEA_TRANS)+1 FROM DET_DOCUMENTO_TRANSACCION WHERE DOCUMENTO_ID = @DOCUMENTO_ID
              INSERT INTO DET_DOCUMENTO_TRANSACCION
              SELECT
              DOC_TRANS_ID
              ,@NRO_LINEA_NEW_TRANS
              ,DOCUMENTO_ID
              ,@NRO_LINEA_NEW
              ,MOTIVO_ID
              ,EST_MERC_ID
              ,CLIENTE_ID
              ,CAT_LOG_ID
              ,ITEM_OK
              ,MOVIMIENTO_PENDIENTE
              ,DOC_TRANS_ID_REF
              ,NRO_LINEA_TRANS_REF
              FROM DET_DOCUMENTO_TRANSACCION
              WHERE DOCUMENTO_ID = @DOCUMENTO_ID AND NRO_LINEA_DOC=@NRO_LINEA
       
              INSERT INTO RL_DET_DOC_TRANS_POSICION
              SELECT
              RL.DOC_TRANS_ID
              ,@NRO_LINEA_NEW_TRANS
              ,RL.POSICION_ANTERIOR
              ,RL.POSICION_ACTUAL
              ,1
              ,RL.TIPO_MOVIMIENTO_ID
              ,RL.ULTIMA_ESTACION
              ,RL.ULTIMA_SECUENCIA
              ,RL.NAVE_ANTERIOR
              ,RL.NAVE_ACTUAL
              ,RL.DOCUMENTO_ID
              ,RL.NRO_LINEA
              ,RL.DISPONIBLE
              ,RL.DOC_TRANS_ID_EGR
              ,RL.NRO_LINEA_TRANS_EGR
              ,RL.DOC_TRANS_ID_TR
              ,RL.NRO_LINEA_TRANS_TR
              ,RL.CLIENTE_ID
              ,RL.CAT_LOG_ID
              ,RL.CAT_LOG_ID_FINAL
              ,RL.EST_MERC_ID
              FROM RL_DET_DOC_TRANS_POSICION RL
              WHERE RL.RL_ID = @RL_ID
              
              UPDATE DET_DOCUMENTO SET CANTIDAD = CANTIDAD - 1 WHERE DOCUMENTO_ID = @DOCUMENTO_ID AND NRO_LINEA = @NRO_LINEA
              UPDATE RL_DET_DOC_TRANS_POSICION SET CANTIDAD = CANTIDAD - 1 WHERE RL_ID = @RL_ID
              
              SET @CANTIDADRL = @CANTIDADRL-1
              
              UPDATE CargaSeriesLog
              SET CARGADA='1'
              WHERE IDPROCESO = @IDPROCESO
                    AND CLIENTE_ID = @CLIENTE_ID
                    AND NRO_BULTO = @NRO_BULTO
                    AND PRODUCTO_ID = @PRODUCTO_ID
                    AND SERIE = @SERIE
            END         
          
            FETCH NEXT FROM @CURSERIES INTO @SERIE
          END
          CLOSE @CURSERIES
          DEALLOCATE @CURSERIES
        
          FETCH NEXT FROM @CURRL INTO @RL_ID, @CANTIDADRL, @DOCUMENTO_ID, @NRO_LINEA
        END
        CLOSE @CURRL
        DEALLOCATE @CURRL

        FETCH NEXT FROM @CURDATOS INTO @CLIENTE_ID, @NRO_BULTO, @PRODUCTO_ID, @SERIE
      END
      
      CLOSE @CURDATOS
      DEALLOCATE @CURDATOS

			SELECT @err = @@error IF @err <> 0 BEGIN ROLLBACK TRANSACTION RETURN @err END
			
			COMMIT TRANSACTION
			SELECT @err = @@error
			
			IF @@TRANCOUNT>0
				ROLLBACK TRANSACTION
				
			IF @err <> 0 RETURN @err
		END TRY
		
		BEGIN CATCH
			IF @@TRANCOUNT>0
				ROLLBACK TRANSACTION

			RETURN @@ERROR
		END CATCH
END
GO

IF @@ERROR <> 0
BEGIN
   IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION
   INSERT INTO #tmpErrors (Error) SELECT 1
   BEGIN TRANSACTION
END
GO

SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		LRojas
-- Create date: 18/04/2012
-- Description:	Procedimiento para buscar pedidos para empaquetar
-- =============================================
CREATE PROCEDURE [dbo].[registra_tmp_producto_empaque]
	@CLIENTE_ID         as varchar(15) OUTPUT,
	@PEDIDO_ID          as varchar(30) OUTPUT,
	@PRODUCTO_ID        as varchar(30) OUTPUT,
    @NRO_CONTENEDORA    as numeric(20) OUTPUT,
    @CANT_CONTROLADA    as numeric(20,5) OUTPUT,
	@NRO_LOTE			AS VARCHAR(100) OUTPUT,
	@NRO_PARTIDA		AS VARCHAR(100) OUTPUT,
	@NRO_SERIE			AS VARCHAR(50) OUTPUT
AS
BEGIN
SET NOCOUNT ON;
    
	if not exists (	select	1
					FROM	PICKING P
					INNER JOIN DET_DOCUMENTO DD ON (P.DOCUMENTO_ID = DD.DOCUMENTO_ID AND P.NRO_LINEA = DD.NRO_LINEA)
					INNER JOIN DOCUMENTO D ON (DD.DOCUMENTO_ID = D.DOCUMENTO_ID)
					where	P.cliente_id = @CLIENTE_ID
							and D.NRO_REMITO = @pedido_id
							and P.producto_id = @producto_id
							and ((P.nro_lote = @nro_lote) or (@nro_lote IS NULL OR @NRO_LOTE = ''))
							and ((P.nro_partida = @nro_partida) or (@nro_partida IS NULL OR @NRO_PARTIDA = ''))
							and ((P.nro_serie = @nro_serie) or (@nro_serie IS NULL OR @NRO_SERIE = '')))
		raiserror('No hay pendientes de empaquetado para el producto ingresado.',16,1) 

    DECLARE @CantPickeada as numeric(20,5),
            @CantControlada as numeric(20,5),
            @CantPendiente as numeric(20,5),
            @NRO_LINEA as numeric(10),
            @CANT_CONFIRMADA as numeric(20,5),
            @CANTIDAD_EMPAQUE as numeric(20,5),
			@PICKING_ID AS NUMERIC(20,0)
    
    DECLARE cur_linea CURSOR FOR
    SELECT P.PICKING_ID, 
    P.CANT_CONFIRMADA - ISNULL((SELECT TMP.CANT_CONFIRMADA FROM TMP_EMPAQUE_CONTENEDORA TMP 
                                WHERE PICKING_ID = P.PICKING_ID AND TMP.PALLET_CONTROLADO = '1'), 0) CANT_CONFIRMADA
    FROM DOCUMENTO D INNER JOIN PICKING P ON (D.DOCUMENTO_ID = P.DOCUMENTO_ID AND D.CLIENTE_ID = P.CLIENTE_ID) 
    WHERE D.CLIENTE_ID = @CLIENTE_ID AND D.NRO_REMITO = @PEDIDO_ID AND P.PRODUCTO_ID = @PRODUCTO_ID 
    AND P.CANT_CONFIRMADA - ISNULL((SELECT TMP.CANT_CONFIRMADA FROM TMP_EMPAQUE_CONTENEDORA TMP 
                                    WHERE PICKING_ID = P.PICKING_ID AND TMP.PALLET_CONTROLADO = '1'), 0) > 0
    AND P.PALLET_CONTROLADO = '0'
	AND
		(
			(P.NRO_LOTE=@NRO_LOTE AND P.NRO_PARTIDA=@NRO_PARTIDA AND P.NRO_SERIE=@NRO_SERIE)
		OR
		(
			(@NRO_LOTE IS NOT NULL OR @NRO_PARTIDA IS NOT NULL OR @NRO_SERIE IS NOT NULL)
			AND ((P.NRO_LOTE=@NRO_LOTE) OR (ISNULL(@NRO_LOTE,'')=''))
			AND ((P.NRO_PARTIDA=@NRO_PARTIDA) OR (ISNULL(@NRO_PARTIDA,'')=''))
			AND ((P.NRO_SERIE=@NRO_SERIE) OR (ISNULL(@NRO_SERIE,'')='')))
		)
    ORDER BY P.PICKING_ID
    
    OPEN cur_linea
    FETCH cur_linea
    INTO @PICKING_ID, @CANT_CONFIRMADA
    
    WHILE (@@FETCH_STATUS = 0 AND @CANT_CONTROLADA > 0)
        BEGIN
            IF NOT EXISTS(SELECT 1 FROM TMP_EMPAQUE_CONTENEDORA WHERE PICKING_ID = @PICKING_ID)
                BEGIN
                    INSERT INTO TMP_EMPAQUE_CONTENEDORA
                    SELECT D.NRO_REMITO, P.*
                    FROM DOCUMENTO D INNER JOIN PICKING P ON(D.DOCUMENTO_ID = P.DOCUMENTO_ID AND D.CLIENTE_ID = P.CLIENTE_ID) 
                    WHERE D.CLIENTE_ID = @CLIENTE_ID AND D.NRO_REMITO = @PEDIDO_ID AND P.PRODUCTO_ID = @PRODUCTO_ID
                END
            
            IF @CANT_CONTROLADA > @CANT_CONFIRMADA
                BEGIN
                    SET @CANTIDAD_EMPAQUE = @CANT_CONFIRMADA
                    SET @CANT_CONTROLADA = @CANT_CONTROLADA - @CANT_CONFIRMADA
                END
            ELSE
                BEGIN
                    SET @CANTIDAD_EMPAQUE = @CANT_CONTROLADA
                    SET @CANT_CONTROLADA = @CANT_CONTROLADA - @CANT_CONFIRMADA
                END
            
            UPDATE TMP_EMPAQUE_CONTENEDORA
            SET CANTIDAD = CANTIDAD - @CANTIDAD_EMPAQUE,
                CANT_CONFIRMADA = CANT_CONFIRMADA - @CANTIDAD_EMPAQUE
            WHERE PICKING_ID = @PICKING_ID AND PALLET_CONTROLADO = '0'
            
            IF EXISTS(
                    SELECT 1 FROM TMP_EMPAQUE_CONTENEDORA 
                    WHERE PICKING_ID = @PICKING_ID AND PALLET_PICKING = @NRO_CONTENEDORA AND PALLET_CONTROLADO <> '0'
                )
                UPDATE TMP_EMPAQUE_CONTENEDORA
                SET CANTIDAD = CANTIDAD + @CANTIDAD_EMPAQUE,
                    CANT_CONFIRMADA = CANT_CONFIRMADA + @CANTIDAD_EMPAQUE
                WHERE PICKING_ID = @PICKING_ID AND PALLET_PICKING = @NRO_CONTENEDORA AND PALLET_CONTROLADO <> '0'
            ELSE
                INSERT INTO TMP_EMPAQUE_CONTENEDORA
                SELECT D.NRO_REMITO, P.PICKING_ID, P.DOCUMENTO_ID, P.NRO_LINEA, P.CLIENTE_ID, P.PRODUCTO_ID, P.VIAJE_ID, P.TIPO_CAJA, P.DESCRIPCION, 
                       @CANTIDAD_EMPAQUE [CANTIDAD], -- Cantidad 
                       P.NAVE_COD, P.POSICION_COD, P.RUTA, P.PROP1, P.FECHA_INICIO, P.FECHA_FIN, P.USUARIO, 
                       @CANTIDAD_EMPAQUE [CANT_CONFIRMADA], -- Cantidad Controlada
                       @NRO_CONTENEDORA [PALLET_PICKING], -- Nro Contenedora
                       P.SALTO_PICKING, 
                       '1' [PALLET_CONTROLADO], -- Esta en Contenedora
                       P.USUARIO_CONTROL_PICK, P.ST_ETIQUETAS, P.ST_CAMION, P.FACTURADO, P.FIN_PICKING, P.ST_CONTROL_EXP, 
                       P.FECHA_CONTROL_PALLET, P.TERMINAL_CONTROL_PALLET, P.FECHA_CONTROL_EXP, P.USUARIO_CONTROL_EXP, P.TERMINAL_CONTROL_EXP, 
                       P.FECHA_CONTROL_FAC, P.USUARIO_CONTROL_FAC, P.TERMINAL_CONTROL_FAC, P.VEHICULO_ID, P.PALLET_COMPLETO, P.HIJO, 
                       P.QTY_CONTROLADO, P.PALLET_FINAL, P.PALLET_CERRADO, P.USUARIO_PF, P.TERMINAL_PF, P.REMITO_IMPRESO, P.NRO_REMITO_PF, 
                       P.PICKING_ID_REF, P.BULTOS_CONTROLADOS, P.BULTOS_NO_CONTROLADOS, P.FLG_PALLET_HOMBRE, P.TRANSF_TERMINADA,P.NRO_LOTE,P.NRO_PARTIDA,P.NRO_SERIE
                FROM DOCUMENTO D INNER JOIN PICKING P ON(D.DOCUMENTO_ID = P.DOCUMENTO_ID) 
                WHERE P.PICKING_ID = @PICKING_ID AND P.PALLET_CONTROLADO = '0'
            
            DELETE TMP_EMPAQUE_CONTENEDORA 
            WHERE PICKING_ID = @PICKING_ID AND CANTIDAD = 0 AND CANT_CONFIRMADA = 0 AND PALLET_CONTROLADO = '0'
            
            -- Si aun existe CANT_CONFIRMADA = 0, es porque hay residuo en CANTIDAD
            IF EXISTS(SELECT 1 FROM TMP_EMPAQUE_CONTENEDORA 
                      WHERE PICKING_ID = @PICKING_ID AND CANT_CONFIRMADA = 0 AND PALLET_CONTROLADO = '0')
                BEGIN
                    -- Para que no se pierda, guaro el residuo
                     UPDATE TMP_EMPAQUE_CONTENEDORA
                     SET CANTIDAD = CANTIDAD + ( 
                                                 SELECT TMP.CANTIDAD
                                                 FROM TMP_EMPAQUE_CONTENEDORA TMP
                                                 WHERE TMP.PICKING_ID = @PICKING_ID AND TMP.CANT_CONFIRMADA = 0 AND TMP.PALLET_CONTROLADO = '0'
                                                 )
                     WHERE PICKING_ID = @PICKING_ID AND PALLET_PICKING = @NRO_CONTENEDORA AND PALLET_CONTROLADO <> '0'
                    
                    -- Ahora si... A borrar!
                    DELETE TMP_EMPAQUE_CONTENEDORA 
                    WHERE PICKING_ID = @PICKING_ID AND CANT_CONFIRMADA = 0 AND PALLET_CONTROLADO = '0'
                END
            
            FETCH cur_linea
            INTO @PICKING_ID, @CANT_CONFIRMADA
        END
    CLOSE cur_linea
    DEALLOCATE cur_linea
	
	
    SELECT @CantPickeada = SUM(CANT_CONFIRMADA) 
    FROM TMP_EMPAQUE_CONTENEDORA 
    WHERE CLIENTE_ID = @CLIENTE_ID AND NRO_REMITO = @PEDIDO_ID AND PRODUCTO_ID = @PRODUCTO_ID AND ISNULL(NRO_LOTE,'') = ISNULL(@NRO_LOTE,'') AND ISNULL(NRO_PARTIDA,'') = ISNULL(@NRO_PARTIDA,'') AND ISNULL(NRO_SERIE,'') = ISNULL(@NRO_SERIE,'')
    
    SELECT @CantControlada = SUM(CANT_CONFIRMADA) 
    FROM TMP_EMPAQUE_CONTENEDORA 
    WHERE	CLIENTE_ID = @CLIENTE_ID AND NRO_REMITO = @PEDIDO_ID AND PRODUCTO_ID = @PRODUCTO_ID AND PALLET_CONTROLADO <> '0'
			AND ISNULL(NRO_LOTE,'') = ISNULL(@NRO_LOTE,'') AND ISNULL(NRO_PARTIDA,'') = ISNULL(@NRO_PARTIDA,'') AND ISNULL(NRO_SERIE,'') = ISNULL(@NRO_SERIE,'')
    
    SELECT @CantPendiente = @CantPickeada - @CantControlada
    
    SELECT @CantPickeada CantPickeada, @CantControlada CantControlada, @CantPendiente CantPendiente
END
GO

IF @@ERROR <> 0
BEGIN
   IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION
   INSERT INTO #tmpErrors (Error) SELECT 1
   BEGIN TRANSACTION
END
GO

SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		LRojas
-- Create date: 25/04/2012
-- Description:	Procedimiento para Reporte Packing List
-- =============================================
CREATE PROCEDURE [dbo].[reporte_packing_list] 
	@CLIENTE_ID as varchar(15) OUTPUT,
    @PEDIDO_ID as varchar(30) OUTPUT
AS
BEGIN
	SET NOCOUNT ON;
	
	SELECT	C.RAZON_SOCIAL [EMPRESA], 
			LTRIM(RTRIM(ISNULL(D.CPTE_PREFIJO, '') + ' ' + ISNULL(D.CPTE_NUMERO, ''))) AS [REMITO], 
			D.NRO_REMITO AS [PEDIDO], 
			S.NOMBRE AS [DESTINATARIO], 
			DIR.DIRECCION,
			CASE WHEN P.PALLET_CONTROLADO = '0' THEN 0 ELSE P.PALLET_PICKING END [NRO_DE_BULTO],
			P.PRODUCTO_ID,
			PRO.DESCRIPCION,
			SUM(P.CANT_CONFIRMADA) [UNIDADES_POR_CAJA],
			CP.TOTAL_BULTOS [TOTAL_DE_BULTOS]
	  FROM	DOCUMENTO D INNER JOIN DET_DOCUMENTO DD ON(D.DOCUMENTO_ID = DD.DOCUMENTO_ID AND D.CLIENTE_ID = DD.CLIENTE_ID) 
			INNER JOIN PICKING P ON(P.DOCUMENTO_ID = DD.DOCUMENTO_ID AND P.NRO_LINEA = DD.NRO_LINEA AND P.CLIENTE_ID = DD.CLIENTE_ID) 
			INNER JOIN SUCURSAL S ON(S.SUCURSAL_ID = D.SUCURSAL_DESTINO AND S.CLIENTE_ID = P.CLIENTE_ID) 
			INNER JOIN SYS_INT_DOCUMENTO ID ON (ID.CLIENTE_ID = P.CLIENTE_ID AND ID.DOC_EXT = D.NRO_REMITO) -- 
			INNER JOIN CLIENTE C ON (C.CLIENTE_ID = P.CLIENTE_ID)
			INNER JOIN PRODUCTO PRO ON (PRO.CLIENTE_ID = P.CLIENTE_ID AND PRO.PRODUCTO_ID = P.PRODUCTO_ID)
			INNER JOIN (Select  S.SUCURSAL_ID,
								S.CLIENTE_ID,
								S.CALLE + 
								CASE WHEN S.NUMERO IS NOT NULL THEN ' ' + S.NUMERO ELSE '' END +
								CASE WHEN S.LOCALIDAD IS NOT NULL THEN ', ' + S.LOCALIDAD ELSE '' END +
								CASE WHEN S.PROVINCIA_ID IS NOT NULL THEN ', ' + PR.DESCRIPCION ELSE '' END +
								CASE WHEN S.PAIS_ID IS NOT NULL THEN ', ' + P.DESCRIPCION ELSE '' END 
								[DIRECCION]
						From	SUCURSAL S 
								LEFT JOIN PROVINCIA PR ON (PR.PAIS_ID = S.PAIS_ID AND PR.PROVINCIA_ID = S.PROVINCIA_ID) 
								LEFT JOIN PAIS P ON (P.PAIS_ID = S.PAIS_ID AND PR.PAIS_ID = S.PAIS_ID)
			) DIR ON(DIR.SUCURSAL_ID = S.SUCURSAL_ID AND DIR.CLIENTE_ID = S.CLIENTE_ID) 
			INNER JOIN (SELECT	DOCUMENTO_ID, COUNT(DISTINCT PALLET_PICKING) AS TOTAL_BULTOS 
						FROM	PICKING 
						WHERE	PALLET_CONTROLADO = '1' GROUP BY DOCUMENTO_ID) CP ON (CP.DOCUMENTO_ID = P.DOCUMENTO_ID)
	 WHERE	D.TIPO_OPERACION_ID = 'EGR' 
			AND D.STATUS = 'D30' 
			AND D.NRO_REMITO IS NOT NULL 
			AND P.FACTURADO = '0' 
			AND P.ST_CAMION = '0' 
		    AND P.CLIENTE_ID = @CLIENTE_ID
		    AND D.NRO_REMITO = @PEDIDO_ID 
	 GROUP BY 
			C.RAZON_SOCIAL, 
			LTRIM(RTRIM(ISNULL(D.CPTE_PREFIJO, '') + ' ' + ISNULL(D.CPTE_NUMERO, ''))), 
			D.NRO_REMITO, 
			S.NOMBRE, 
			DIR.DIRECCION,
			CASE WHEN P.PALLET_CONTROLADO = '0' THEN 0 ELSE P.PALLET_PICKING END,
			P.PRODUCTO_ID,
			PRO.DESCRIPCION, CP.TOTAL_BULTOS
	having	SUM(P.CANT_CONFIRMADA)>0  --se agrega para que no salgan en el reporte
	
END
GO

IF @@ERROR <> 0
BEGIN
   IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION
   INSERT INTO #tmpErrors (Error) SELECT 1
   BEGIN TRANSACTION
END
GO

SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[requierePartidaLote]
	-- Add the parameters for the stored procedure here
	@cliente_id		varchar(15)
	,@producto_id	varchar(30)
	,@out			varchar(1)
AS
BEGIN

	SET NOCOUNT ON;

	IF EXISTS (SELECT 1 FROM PRODUCTO WHERE CLIENTE_ID = @cliente_id AND PRODUCTO_ID = @producto_id AND (ingLoteProveedor='1' OR ingPartida='1'))
		SET @out='1'
	ELSE
		SET @out='0'
			
END
GO

IF @@ERROR <> 0
BEGIN
   IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION
   INSERT INTO #tmpErrors (Error) SELECT 1
   BEGIN TRANSACTION
END
GO

SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
GO

CREATE  PROCEDURE [dbo].[RPT_PREPICKING_MULTIPLE]
@TIPO_Q	CHAR(1) 		OUTPUT  --SI ES TODO O SOLO LAS DIFERENCIAS (1 = TODO, 0=DIFERENCIAS)
AS
BEGIN
	DECLARE @USUARIO 	VARCHAR(50)
	DECLARE @TERMINAL	VARCHAR(100)
	DECLARE @FECHA	VARCHAR(100)
	DECLARE @CODIGO_VIAJE VARCHAR(100)
	DECLARE @PEDIDO VARCHAR(100)
	DECLARE @CUR_VIAJES CURSOR
	DECLARE @CLIENTE_ID	VARCHAR(15)
	DECLARE @CURDETALLE	CURSOR
	DECLARE @DOC_EXT	VARCHAR(100)
	DECLARE @NRO_LINEA	NUMERIC(20,0)
	DECLARE @PESO		NUMERIC(20,5)
	DECLARE @NRO_LOTE	VARCHAR(100)
	DECLARE @NRO_PARTIDA	VARCHAR(100)
	DECLARE @NRO_SERIE		VARCHAR(50)
	DECLARE @PRODUCTO_ID	VARCHAR(30)
	DECLARE @STOCK_DISP		NUMERIC(20,5)
	DECLARE @PREING			NUMERIC(20,5)
	DECLARE @TRANSITO		NUMERIC(20,5)
	DECLARE @NOPICK			NUMERIC(20,5)
	DECLARE @TOTAL_DEP		NUMERIC(20,5)
	DECLARE @RESTA			NUMERIC(20,5)

	--SELECT @USUARIO=USUARIO_ID FROM #TEMP_USUARIO_LOGGIN
	SET @USUARIO='ADMIN'
	SET @TERMINAL=HOST_NAME()
	--SET @FECHA=CONVERT(VARCHAR,GETDATE(),103)
	SET @FECHA = CONVERT(VARCHAR(20),GETDATE(),103) + ' ' + RIGHT(CONVERT(VARCHAR(20),GETDATE(),120),8)
	
	set nocount on 
	
	BEGIN TRY	
		
		CREATE TABLE #RPT_FINAL 
			(CODIGO_VIAJE VARCHAR(100) COLLATE SQL_Latin1_General_CP1_CI_AS
			,PEDIDO VARCHAR(100) COLLATE SQL_Latin1_General_CP1_CI_AS
			,CLIENTE_ID VARCHAR(100) COLLATE SQL_Latin1_General_CP1_CI_AS
			,PRODUCTO_ID VARCHAR(100) COLLATE SQL_Latin1_General_CP1_CI_AS
			,DESCRIPCION VARCHAR(1000)  COLLATE SQL_Latin1_General_CP1_CI_AS
			,QTY_SOL NUMERIC(30,6)
			,STOCK_DISP NUMERIC(30,6)
			,DIF NUMERIC(30,6)
			,PREING NUMERIC(30,6)
			,TRANSITO NUMERIC(30,6)
			,UBIC_NOPICK NUMERIC(30,6)
			,TOTAL_DEP NUMERIC(30,6)
			,USUARIO VARCHAR(100) COLLATE SQL_Latin1_General_CP1_CI_AS 
			,TERMINAL VARCHAR(100)  COLLATE SQL_Latin1_General_CP1_CI_AS
			,FECHA VARCHAR(100) COLLATE SQL_Latin1_General_CP1_CI_AS
			,NRO_LOTE VARCHAR(100) COLLATE SQL_Latin1_General_CP1_CI_AS
			,NRO_PARTIDA VARCHAR(100) COLLATE SQL_Latin1_General_CP1_CI_AS
			,NRO_SERIE VARCHAR(50) COLLATE SQL_Latin1_General_CP1_CI_AS)
			
		CREATE TABLE #AUX 
			(CODIGO_VIAJE VARCHAR(100) COLLATE SQL_Latin1_General_CP1_CI_AS
			,PEDIDO VARCHAR(100) COLLATE SQL_Latin1_General_CP1_CI_AS
			,CLIENTE_ID VARCHAR(100) COLLATE SQL_Latin1_General_CP1_CI_AS
			,PRODUCTO_ID VARCHAR(100) COLLATE SQL_Latin1_General_CP1_CI_AS
			,DESCRIPCION VARCHAR(1000) COLLATE SQL_Latin1_General_CP1_CI_AS
			,QTY_SOL NUMERIC(30,6)
			,STOCK_DISP NUMERIC(30,6)
			,DIF NUMERIC(30,6)
			,PREING NUMERIC(30,6)
			,TRANSITO NUMERIC(30,6)
			,UBIC_NOPICK NUMERIC(30,6)
			,TOTAL_DEP NUMERIC(30,6)
			,USUARIO VARCHAR(100) COLLATE SQL_Latin1_General_CP1_CI_AS
			,TERMINAL VARCHAR(100) COLLATE SQL_Latin1_General_CP1_CI_AS
			,FECHA VARCHAR(100) COLLATE SQL_Latin1_General_CP1_CI_AS
			,NRO_LOTE VARCHAR(100) COLLATE SQL_Latin1_General_CP1_CI_AS
			,NRO_PARTIDA VARCHAR(100) COLLATE SQL_Latin1_General_CP1_CI_AS
			,NRO_SERIE VARCHAR(50) COLLATE SQL_Latin1_General_CP1_CI_AS)
			
		CREATE TABLE #CONSUMO
			(CLIENTE_ID VARCHAR(100) COLLATE SQL_Latin1_General_CP1_CI_AS
			,PRODUCTO_ID VARCHAR(100) COLLATE SQL_Latin1_General_CP1_CI_AS
			,NRO_LOTE VARCHAR(100) COLLATE SQL_Latin1_General_CP1_CI_AS
			,NRO_PARTIDA VARCHAR(100) COLLATE SQL_Latin1_General_CP1_CI_AS
			,NRO_SERIE VARCHAR(50) COLLATE SQL_Latin1_General_CP1_CI_AS
			,CANTIDAD NUMERIC(30,6))
			
		--#SDDPESO ASIGNA A CADA CLIENTE_ID | DOC_EXT | NRO LINEA UN PESO LOGICO DE ACUERDO A LAS PROPIEDADES NRO_LOTE, NRO_PARTIDA Y NRO_SERIE
		CREATE TABLE #SDDPESO
			(CLIENTE_ID VARCHAR(15) COLLATE SQL_Latin1_General_CP1_CI_AS
			,CODIGO_VIAJE VARCHAR(100) COLLATE SQL_Latin1_General_CP1_CI_AS
			,DOC_EXT VARCHAR(100) COLLATE SQL_Latin1_General_CP1_CI_AS
			,NRO_LINEA NUMERIC(20,0), PESO INT)
		

		INSERT INTO #SDDPESO
		SELECT	DD.CLIENTE_ID, D.CODIGO_VIAJE, DD.DOC_EXT, DD.NRO_LINEA,
				CAST((CASE
					WHEN ISNULL(NRO_LOTE,'')='' AND ISNULL(NRO_PARTIDA,'')='' AND ISNULL(PROP3,'')='' THEN 0
					WHEN ISNULL(NRO_LOTE,'')='' AND ISNULL(NRO_PARTIDA,'')='' AND ISNULL(PROP3,'')<>'' THEN 1
					WHEN ISNULL(NRO_LOTE,'')='' AND ISNULL(NRO_PARTIDA,'')<>'' AND ISNULL(PROP3,'')='' THEN 1
					WHEN ISNULL(NRO_LOTE,'')='' AND ISNULL(NRO_PARTIDA,'')<>'' AND ISNULL(PROP3,'')<>'' THEN 2
					WHEN ISNULL(NRO_LOTE,'')<>'' AND ISNULL(NRO_PARTIDA,'')='' AND ISNULL(PROP3,'')='' THEN 1
					WHEN ISNULL(NRO_LOTE,'')<>'' AND ISNULL(NRO_PARTIDA,'')='' AND ISNULL(PROP3,'')<>'' THEN 2
					WHEN ISNULL(NRO_LOTE,'')<>'' AND ISNULL(NRO_PARTIDA,'')<>'' AND ISNULL(PROP3,'')='' THEN 2
					WHEN ISNULL(NRO_LOTE,'')<>'' AND ISNULL(NRO_PARTIDA,'')<>'' AND ISNULL(PROP3,'')<>'' THEN 3
					ELSE 0
				END) AS INT) AS PESO
		FROM SYS_INT_DET_DOCUMENTO DD
		INNER JOIN SYS_INT_DOCUMENTO D ON (DD.CLIENTE_ID = D.CLIENTE_ID AND DD.DOC_EXT = D.DOC_EXT)
		INNER JOIN #TMP_VIAJES T ON										
									(D.CLIENTE_ID =  T.CLIENTE_ID 
									AND D.CODIGO_VIAJE = T.CODIGO_VIAJE 
									AND D.DOC_EXT = T.PEDIDO)
		
		SET @CUR_VIAJES = CURSOR FOR 
			SELECT DISTINCT T.CLIENTE_ID, T.CODIGO_VIAJE
			FROM #TMP_VIAJES T 
			INNER JOIN SYS_INT_DOCUMENTO D ON (D.CLIENTE_ID =  T.CLIENTE_ID  
											  AND D.CODIGO_VIAJE = T.CODIGO_VIAJE  
											  AND D.DOC_EXT = T.PEDIDO )
			order by T.CLIENTE_ID, T.CODIGO_VIAJE
		
		
		OPEN @CUR_VIAJES 
		FETCH NEXT FROM @CUR_VIAJES INTO @CLIENTE_ID, @CODIGO_VIAJE
		While @@Fetch_Status=0  
		BEGIN
		
			TRUNCATE TABLE #AUX
			--Por cada viaje evaluo la reserva en stock para cada item ordenado segun el peso
			SET @CURDETALLE = CURSOR FOR
			SELECT PS.DOC_EXT, PS.NRO_LINEA
			FROM #SDDPESO PS
			WHERE PS.CLIENTE_ID = @CLIENTE_ID AND PS.CODIGO_VIAJE = @CODIGO_VIAJE
			order by PS.PESO DESC

			OPEN @CURDETALLE
			FETCH NEXT FROM @CURDETALLE INTO @DOC_EXT, @NRO_LINEA

			WHILE @@FETCH_STATUS = 0
			BEGIN

				SELECT @NRO_LOTE = DD.NRO_LOTE, @NRO_PARTIDA = DD.NRO_PARTIDA, @NRO_SERIE = DD.PROP3, @PRODUCTO_ID = DD.PRODUCTO_ID
				FROM SYS_INT_DOCUMENTO D
				INNER JOIN SYS_INT_DET_DOCUMENTO DD ON (D.CLIENTE_ID = DD.CLIENTE_ID AND D.DOC_EXT = DD.DOC_EXT)
				WHERE D.CLIENTE_ID = @CLIENTE_ID AND D.DOC_EXT = @DOC_EXT AND DD.NRO_LINEA = @NRO_LINEA


				--STOCK_DISPONIBLE
				SELECT  @STOCK_DISP = ISNULL(SUM(RL.CANTIDAD),0)
				FROM 	RL_DET_DOC_TRANS_POSICION RL
						INNER JOIN DET_DOCUMENTO_TRANSACCION DDT ON(RL.DOC_TRANS_ID=DDT.DOC_TRANS_ID AND RL.NRO_LINEA_TRANS=DDT.NRO_LINEA_TRANS)
						INNER JOIN DET_DOCUMENTO DD ON (DDT.DOCUMENTO_ID=DD.DOCUMENTO_ID AND DDT.NRO_LINEA_DOC=DD.NRO_LINEA)
						INNER JOIN CATEGORIA_LOGICA CL ON (RL.CLIENTE_ID=CL.CLIENTE_ID AND RL.CAT_LOG_ID=CL.CAT_LOG_ID AND CL.DISP_EGRESO='1' AND CL.PICKING='1')
						INNER JOIN POSICION P ON (RL.POSICION_ACTUAL=P.POSICION_ID AND P.POS_LOCKEADA='0' AND P.PICKING='1')
						LEFT JOIN ESTADO_MERCADERIA_RL EM ON (RL.CLIENTE_ID=EM.CLIENTE_ID AND RL.EST_MERC_ID=EM.EST_MERC_ID) 	
				WHERE	DD.CLIENTE_ID = @CLIENTE_ID AND RL.DOC_TRANS_ID_EGR IS NULL AND RL.NRO_LINEA_TRANS_EGR IS NULL AND RL.DISPONIBLE='1'	AND ISNULL(EM.DISP_EGRESO,'1')='1'
						AND ISNULL(EM.PICKING,'1')='1'	AND RL.CAT_LOG_ID<>'TRAN_EGR' AND DD.PRODUCTO_ID = @PRODUCTO_ID
						and ((isnull(@NRO_LOTE,'')='') or (DD.nro_lote = @NRO_LOTE))
						and ((isnull(@NRO_PARTIDA,'')='') or (DD.nro_partida = @NRO_PARTIDA))
						and ((isnull(@NRO_SERIE,'')='') or (DD.nro_serie = @NRO_SERIE))

				SELECT @STOCK_DISP = @STOCK_DISP + ISNULL(SUM(RL.CANTIDAD),0)
				FROM	RL_DET_DOC_TRANS_POSICION RL
						INNER JOIN DET_DOCUMENTO_TRANSACCION DDT ON(RL.DOC_TRANS_ID=DDT.DOC_TRANS_ID AND RL.NRO_LINEA_TRANS=DDT.NRO_LINEA_TRANS)
						INNER JOIN DET_DOCUMENTO DD ON (DDT.DOCUMENTO_ID=DD.DOCUMENTO_ID AND DDT.NRO_LINEA_DOC=DD.NRO_LINEA)
						INNER JOIN CATEGORIA_LOGICA CL ON (RL.CLIENTE_ID=CL.CLIENTE_ID AND RL.CAT_LOG_ID=CL.CAT_LOG_ID AND CL.DISP_EGRESO='1' AND CL.PICKING='1')
						INNER JOIN NAVE N ON (RL.NAVE_ACTUAL=N.NAVE_ID AND N.DISP_EGRESO='1' AND N.PRE_EGRESO='0' AND N.PRE_INGRESO='0' AND N.PICKING='1')
						LEFT JOIN ESTADO_MERCADERIA_RL EM ON (RL.CLIENTE_ID=EM.CLIENTE_ID AND RL.EST_MERC_ID=EM.EST_MERC_ID) 
				WHERE 	DD.CLIENTE_ID = @CLIENTE_ID AND RL.DOC_TRANS_ID_EGR IS NULL AND RL.NRO_LINEA_TRANS_EGR IS NULL AND RL.DISPONIBLE='1' 	AND ISNULL(EM.DISP_EGRESO,'1')='1'
						AND ISNULL(EM.PICKING,'1')='1' AND RL.CAT_LOG_ID<>'TRAN_EGR' AND DD.PRODUCTO_ID = @PRODUCTO_ID
						and ((isnull(@NRO_LOTE,'')='') or (DD.nro_lote = @NRO_LOTE))
						and ((isnull(@NRO_PARTIDA,'')='') or (DD.nro_partida = @NRO_PARTIDA))
						and ((isnull(@NRO_SERIE,'')='') or (DD.nro_serie = @NRO_SERIE))

				SELECT @RESTA = ISNULL(SUM(CANTIDAD),0)
				FROM #CONSUMO
				WHERE CLIENTE_ID = @CLIENTE_ID AND PRODUCTO_ID = @PRODUCTO_ID
				and ((isnull(@NRO_LOTE,'')='') or (nro_lote = @NRO_LOTE))
				and ((isnull(@NRO_PARTIDA,'')='') or (nro_partida = @NRO_PARTIDA))
				and ((isnull(@NRO_SERIE,'')='') or (nro_serie = @NRO_SERIE))

				SET @STOCK_DISP = @STOCK_DISP - @RESTA

				--PREING
				SELECT	@PREING = ISNULL(SUM(RL.CANTIDAD),0)
				FROM	DET_DOCUMENTO DD (NOLOCK) INNER JOIN DET_DOCUMENTO_TRANSACCION DDT (NOLOCK)
						ON(DD.DOCUMENTO_ID=DDT.DOCUMENTO_ID AND DD.NRO_LINEA=DDT.NRO_LINEA_DOC)
						INNER JOIN RL_DET_DOC_TRANS_POSICION RL (NOLOCK)
						ON(DDT.DOC_TRANS_ID=RL.DOC_TRANS_ID AND DDT.NRO_LINEA_TRANS=RL.NRO_LINEA_TRANS)
						INNER JOIN NAVE N(NOLOCK)
						ON(RL.NAVE_ACTUAL=N.NAVE_ID)
				WHERE	N.PRE_INGRESO='1' AND DD.CLIENTE_ID = @CLIENTE_ID AND DD.PRODUCTO_ID = @PRODUCTO_ID
						and ((isnull(@NRO_LOTE,'')='') or (DD.nro_lote = @NRO_LOTE))
						and ((isnull(@NRO_PARTIDA,'')='') or (DD.nro_partida = @NRO_PARTIDA))
						and ((isnull(@NRO_SERIE,'')='') or (DD.nro_serie = @NRO_SERIE))


				-- TRANSITO
				SELECT 	@TRANSITO = ISNULL(SUM(B.QTY),0)
				FROM	(
						SELECT	DD.NRO_LOTE, DD.NRO_PARTIDA, DD.NRO_SERIE, DD.CLIENTE_ID, DD.PRODUCTO_ID, SUM(RL.CANTIDAD) AS QTY
						FROM	DET_DOCUMENTO DD (NOLOCK) INNER JOIN DET_DOCUMENTO_TRANSACCION DDT (NOLOCK)
								ON(DD.DOCUMENTO_ID=DDT.DOCUMENTO_ID AND DD.NRO_LINEA=DDT.NRO_LINEA_DOC)
								INNER JOIN RL_DET_DOC_TRANS_POSICION RL (NOLOCK)
								ON(DDT.DOC_TRANS_ID=RL.DOC_TRANS_ID AND DDT.NRO_LINEA_TRANS=RL.NRO_LINEA_TRANS)
								INNER JOIN CATEGORIA_LOGICA CL(NOLOCK) 
								ON(RL.CLIENTE_ID=CL.CLIENTE_ID  AND RL.CAT_LOG_ID=CL.CAT_LOG_ID AND CL.CAT_LOG_ID NOT IN('TRAN_ING', 'TRAN_EGR') AND CL.PICKING='0' AND CL.DISP_EGRESO='0')
						GROUP BY 
								DD.NRO_LOTE, DD.NRO_PARTIDA, DD.NRO_SERIE, DD.CLIENTE_ID, DD.PRODUCTO_ID
						UNION 	ALL
						SELECT	DD.NRO_LOTE, DD.NRO_PARTIDA, DD.NRO_SERIE, DD.CLIENTE_ID, DD.PRODUCTO_ID, SUM(RL.CANTIDAD) AS QTY
						FROM	DET_DOCUMENTO DD (NOLOCK) INNER JOIN DET_DOCUMENTO_TRANSACCION DDT (NOLOCK)
								ON(DD.DOCUMENTO_ID=DDT.DOCUMENTO_ID AND DD.NRO_LINEA=DDT.NRO_LINEA_DOC)
								INNER JOIN RL_DET_DOC_TRANS_POSICION RL (NOLOCK)
								ON(DDT.DOC_TRANS_ID=RL.DOC_TRANS_ID AND DDT.NRO_LINEA_TRANS=RL.NRO_LINEA_TRANS)
								INNER JOIN ESTADO_MERCADERIA_RL EM(NOLOCK) 
								ON(RL.CLIENTE_ID=EM.CLIENTE_ID AND RL.EST_MERC_ID=EM.EST_MERC_ID  AND EM.PICKING='0' AND EM.DISP_EGRESO='0')
						GROUP BY 
								DD.NRO_LOTE, DD.NRO_PARTIDA, DD.NRO_SERIE, DD.CLIENTE_ID, DD.PRODUCTO_ID
				
					)B
				WHERE B.CLIENTE_ID = @CLIENTE_ID AND B.PRODUCTO_ID = @PRODUCTO_ID
				and ((isnull(@NRO_LOTE,'')='') or (B.nro_lote = @NRO_LOTE))
				and ((isnull(@NRO_PARTIDA,'')='') or (B.nro_partida = @NRO_PARTIDA))
				and ((isnull(@NRO_SERIE,'')='') or (B.nro_serie = @NRO_SERIE))

				--TOTAL_DEP
				SELECT 	@TOTAL_DEP = ISNULL(SUM(RL.CANTIDAD),0)
				FROM	DET_DOCUMENTO DD (NOLOCK) INNER JOIN DET_DOCUMENTO_TRANSACCION DDT
						ON(DD.DOCUMENTO_ID= DDT.DOCUMENTO_ID AND DD.NRO_LINEA=DDT.NRO_LINEA_DOC)
						INNER JOIN RL_DET_DOC_TRANS_POSICION RL
						ON(DDT.DOC_TRANS_ID=RL.DOC_TRANS_ID AND DDT.NRO_LINEA_TRANS=RL.NRO_LINEA_TRANS)
				WHERE DD.CLIENTE_ID = @CLIENTE_ID AND DD.PRODUCTO_ID = @PRODUCTO_ID
				and ((isnull(@NRO_LOTE,'')='') or (DD.nro_lote = @NRO_LOTE))
				and ((isnull(@NRO_PARTIDA,'')='') or (DD.nro_partida = @NRO_PARTIDA))
				and ((isnull(@NRO_SERIE,'')='') or (DD.nro_serie = @NRO_SERIE))

				--NOPICK
				SELECT 	@NOPICK = ISNULL(SUM(A.QTY_UBIC),0)
				FROM	(
						SELECT	DD.CLIENTE_ID, DD.PRODUCTO_ID, DD.NRO_LOTE, DD.NRO_PARTIDA, DD.NRO_SERIE, SUM(RL.CANTIDAD)AS QTY_UBIC
						FROM	DET_DOCUMENTO DD (NOLOCK) INNER JOIN DET_DOCUMENTO_TRANSACCION DDT (NOLOCK)
								ON(DD.DOCUMENTO_ID=DDT.DOCUMENTO_ID AND DD.NRO_LINEA=DDT.NRO_LINEA_DOC)
								INNER JOIN RL_DET_DOC_TRANS_POSICION RL (NOLOCK)
								ON(DDT.DOC_TRANS_ID=RL.DOC_TRANS_ID AND DDT.NRO_LINEA_TRANS=RL.NRO_LINEA_TRANS)
								INNER JOIN POSICION P (NOLOCK)
								ON(RL.POSICION_ACTUAL=P.POSICION_ID AND ISNULL(P.PICKING,'0')='0')
						GROUP BY 
								DD.CLIENTE_ID, DD.PRODUCTO_ID, DD.NRO_LOTE, DD.NRO_PARTIDA, DD.NRO_SERIE
						UNION ALL
						SELECT	DD.CLIENTE_ID, DD.PRODUCTO_ID, DD.NRO_LOTE, DD.NRO_PARTIDA, DD.NRO_SERIE, SUM(RL.CANTIDAD)AS QTY_UBIC
						FROM	DET_DOCUMENTO DD (NOLOCK) INNER JOIN DET_DOCUMENTO_TRANSACCION DDT (NOLOCK)
								ON(DD.DOCUMENTO_ID=DDT.DOCUMENTO_ID AND DD.NRO_LINEA=DDT.NRO_LINEA_DOC)
								INNER JOIN RL_DET_DOC_TRANS_POSICION RL (NOLOCK)
								ON(DDT.DOC_TRANS_ID=RL.DOC_TRANS_ID AND DDT.NRO_LINEA_TRANS=RL.NRO_LINEA_TRANS)
								INNER JOIN NAVE N (NOLOCK)
								ON(RL.NAVE_ACTUAL=N.NAVE_ID AND ISNULL(N.PICKING,'0')='0' AND N.PRE_INGRESO='0')
						GROUP BY 
								DD.CLIENTE_ID, DD.PRODUCTO_ID, DD.NRO_LOTE, DD.NRO_PARTIDA, DD.NRO_SERIE
						)A
				WHERE A.CLIENTE_ID = @CLIENTE_ID AND A.PRODUCTO_ID = @PRODUCTO_ID
				and ((isnull(@NRO_LOTE,'')='') or (A.nro_lote = @NRO_LOTE))
				and ((isnull(@NRO_PARTIDA,'')='') or (A.nro_partida = @NRO_PARTIDA))
				and ((isnull(@NRO_SERIE,'')='') or (A.nro_serie = @NRO_SERIE))

				INSERT INTO #AUX
				SELECT
						 D.CODIGO_VIAJE
						,D.DOC_EXT
						,DD.CLIENTE_ID
						,DD.PRODUCTO_ID
						,PX.DESCRIPCION
						,sum(DD.CANTIDAD_SOLICITADA)												QTY_SOL
						,@STOCK_DISP																STOCK_DISP
						,DBO.RPT_PREPICK_COMP(SUM(DD.CANTIDAD_SOLICITADA),ISNULL(@STOCK_DISP,0))	DIF
						,@PREING																	PREING
						,@TRANSITO																	TRANSITO
						,@NOPICK																	UBIC_NOPICK
						,@TOTAL_DEP																	TOTAL_DEP
						,@USUARIO																	USUARIO
						,@TERMINAL																	TERMINAL
						,@FECHA																		FECHA
						,DD.NRO_LOTE
						,DD.NRO_PARTIDA
						,DD.PROP3 AS NRO_SERIE
				FROM	SYS_INT_DOCUMENTO D (NOLOCK) 
						INNER JOIN SYS_INT_DET_DOCUMENTO DD (NOLOCK) ON(D.CLIENTE_ID=DD.CLIENTE_ID AND D.DOC_EXT=DD.DOC_EXT)
						LEFT JOIN PRODUCTO PX (NOLOCK) ON(DD.CLIENTE_ID=PX.CLIENTE_ID AND DD.PRODUCTO_ID=PX.PRODUCTO_ID)				
				WHERE
						D.CLIENTE_ID = @CLIENTE_ID AND D.CODIGO_VIAJE=@CODIGO_VIAJE AND D.DOC_EXT = @DOC_EXT AND DD.NRO_LINEA = @NRO_LINEA
				GROUP BY
						D.CODIGO_VIAJE,D.DOC_EXT, DD.CLIENTE_ID, DD.PRODUCTO_ID, px.descripcion,DD.NRO_LOTE, DD.NRO_PARTIDA, DD.PROP3
				ORDER BY dd.producto_id

				INSERT INTO #CONSUMO
				SELECT CLIENTE_ID , PRODUCTO_ID, NRO_LOTE, NRO_PARTIDA, PROP3 AS NRO_SERIE, CASE WHEN (@STOCK_DISP >=CANTIDAD_SOLICITADA) THEN (CANTIDAD_SOLICITADA) ELSE @STOCK_DISP END
				FROM SYS_INT_DET_DOCUMENTO WHERE CLIENTE_ID = @CLIENTE_ID AND DOC_EXT = @DOC_EXT AND NRO_LINEA = @NRO_LINEA
			
				FETCH NEXT FROM @CURDETALLE INTO @DOC_EXT, @NRO_LINEA

			END
			CLOSE @CURDETALLE
			DEALLOCATE @CURDETALLE

			INSERT INTO #RPT_FINAL
			SELECT
			CODIGO_VIAJE
			,PEDIDO
			,CLIENTE_ID
			,(CASE
				WHEN ISNULL(NRO_LOTE,'')<>'' THEN '(*) ' + PRODUCTO_ID
				WHEN ISNULL(NRO_PARTIDA,'')<>'' THEN '(*) ' + PRODUCTO_ID
				WHEN ISNULL(NRO_SERIE,'')<>'' THEN '(*) ' + PRODUCTO_ID
				ELSE PRODUCTO_ID
			END)
			,DESCRIPCION
			,QTY_SOL
			,STOCK_DISP
			,DIF
			,PREING
			,TRANSITO
			,UBIC_NOPICK
			,TOTAL_DEP
			,USUARIO
			,TERMINAL
			,FECHA
			,NRO_LOTE
			,NRO_PARTIDA
			,NRO_SERIE
			FROM #AUX ORDER BY CLIENTE_ID, CODIGO_VIAJE, PEDIDO, PRODUCTO_ID
			

			FETCH NEXT FROM @CUR_VIAJES INTO @CLIENTE_ID, @CODIGO_VIAJE
		END --WHILE
		
		CLOSE @CUR_VIAJES
		DEALLOCATE @CUR_VIAJES
		
		
		
		IF @TIPO_Q='1' 
				SELECT T.*, C.RAZON_SOCIAL FROM #RPT_FINAL T
				inner join CLIENTE c on (c.CLIENTE_ID = T.CLIENTE_ID)
		ELSE IF @TIPO_Q='0' 
				SELECT T.*, C.RAZON_SOCIAL FROM #RPT_FINAL T
				inner join CLIENTE c on (c.CLIENTE_ID = T.CLIENTE_ID)

				WHERE DIF <0
		ELSE
			RAISERROR('TIPO DE LISTADO NO DEFINIDO',15,1)
				
		
			
		
	END TRY
	BEGIN CATCH
		EXEC usp_RethrowError
	END CATCH	
END --FIN PROCEDURE
GO

IF @@ERROR <> 0
BEGIN
   IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION
   INSERT INTO #tmpErrors (Error) SELECT 1
   BEGIN TRANSACTION
END
GO

SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[RPT_SERIES_EGRESADAS]
	@CLIENTE_ID		VARCHAR(15)		OUTPUT,
	@PRODUCTO_ID	VARCHAR(30)		OUTPUT,
	@SUCURSAL_ID	VARCHAR(20) 	OUTPUT,
	@CODVIAJE		VARCHAR(100)	OUTPUT,
	@CODPEDIDO		VARCHAR(30)		OUTPUT,
	@NRO_SERIE		VARCHAR(50)		OUTPUT,
	@NRO_LOTE		VARCHAR(50)		OUTPUT,
	@NRO_PARTIDA	VARCHAR(50)		OUTPUT,
	@NRO_BULTO		VARCHAR(50)		OUTPUT
		
AS
BEGIN
	
	SELECT	D.FECHA_FIN_GTW			AS [FECHA_EGRESO]
			,C.RAZON_SOCIAL			AS [CLIENTE]
			,P.VIAJE_ID				AS [OLA_PEDIDO]
			,D.NRO_REMITO			AS [PEDIDO_EGRESO]
			,S.NOMBRE				AS [DESTINO]
			,P.PRODUCTO_ID			AS [PRODUCTO]
			,P.DESCRIPCION			AS [DESCRIPCION_PRODUCTO]
			,P.NRO_SERIE
			,P.NRO_LOTE
			,P.NRO_PARTIDA
			,DD.NRO_BULTO
			,GETDATE()				AS [FECHA_RPT]
			,HOST_NAME()			AS [TERMINAL_RPT]

	FROM VPICKING P 
		INNER JOIN VDOCUMENTO D (NOLOCK)		ON (D.DOCUMENTO_ID = P.DOCUMENTO_ID AND D.CLIENTE_ID = P.CLIENTE_ID)
		INNER JOIN DET_DOCUMENTO DD (NOLOCK)	ON (D.DOCUMENTO_ID = DD.DOCUMENTO_ID AND D.CLIENTE_ID = DD.CLIENTE_ID
												AND P.PRODUCTO_ID = DD.PRODUCTO_ID AND P.NRO_LINEA = DD.NRO_LINEA)
		INNER JOIN SUCURSAL S (NOLOCK)			ON (D.SUCURSAL_DESTINO = S.SUCURSAL_ID AND D.CLIENTE_ID = S.CLIENTE_ID)
		INNER JOIN CLIENTE C (NOLOCK)			ON (D.CLIENTE_ID = C.CLIENTE_ID)
	
	WHERE 1=1
		AND P.NRO_SERIE <>''
		AND ((@CLIENTE_ID IS NULL) OR (P.CLIENTE_ID = @CLIENTE_ID))
		AND ((@PRODUCTO_ID IS NULL) OR (P.PRODUCTO_ID = @PRODUCTO_ID))
		AND ((@SUCURSAL_ID IS NULL) OR (D.SUCURSAL_DESTINO = @SUCURSAL_ID))
		AND ((@CODVIAJE IS NULL) OR (P.VIAJE_ID LIKE  '%'+ @CODPEDIDO +  '%'))
		AND ((@CODPEDIDO IS NULL) OR (D.NRO_REMITO LIKE  '%'+ @CODPEDIDO +  '%'))
		AND ((@NRO_SERIE IS NULL) OR (P.NRO_SERIE = @NRO_SERIE))
		AND ((@NRO_LOTE IS NULL) OR (P.NRO_LOTE = @NRO_LOTE))
		AND ((@NRO_PARTIDA IS NULL) OR (P.NRO_PARTIDA = @NRO_PARTIDA))
		AND ((@NRO_BULTO IS NULL) OR (DD.NRO_BULTO = @NRO_BULTO))

	ORDER BY 
		1,2,3,4,5,6
END
GO

IF @@ERROR <> 0
BEGIN
   IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION
   INSERT INTO #tmpErrors (Error) SELECT 1
   BEGIN TRANSACTION
END
GO

SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[RPT_STOCK_SNAP]
	@FDESDE			DATETIME OUTPUT,
	@FHASTA			DATETIME OUTPUT,
	@CLIENTE_ID		VARCHAR(15)OUTPUT,
	@NRO_LOTE		VARCHAR(50)OUTPUT,
	@PRODUCTO_ID	VARCHAR(30)OUTPUT,
	@NRO_PARTIDA	VARCHAR(50)OUTPUT,
	@CAT_LOG_ID		VARCHAR(50)OUTPUT,
	@EST_MERC_ID	VARCHAR(15)OUTPUT
AS
BEGIN
	SELECT	CONVERT(VARCHAR,X.FECHA,103)	AS FECHA,
			X.CLIENTE						AS CLIENTE,
			X.PRODUCTO_ID					AS PRODUCTO_ID,
			X.PRODUCTO						AS PRODUCTO,
			X.NRO_LOTE						AS NRO_LOTE,
			X.NRO_PARTIDA					AS NRO_PARTIDA,
			X.CAT_LOG						AS CAT_LOG,
			X.EST_MERC						AS EST_MERC,
			SUM(X.QTY)						AS QTY,
			X.UN							AS UN,
			X.CAT_LOG_ID					AS CAT_LOG_ID,
			X.EST_MERC_ID					AS EST_MERC_ID,
			X.CLIENTE_ID					AS CLIENTE_ID,
			GETDATE()						AS F_IMP,
			HOST_NAME()						AS TERMINAL
	FROM	(	SELECT  DISTINCT  
						SE.F_SNAP								AS FECHA,
						SE.CLIENTE_ID							AS CLIENTE_ID,
						C.RAZON_SOCIAL							AS CLIENTE,
						PR.PRODUCTO_ID							AS PRODUCTO_ID,
						PR.PRODUCTO_ID + ' - '+ PR.DESCRIPCION	AS PRODUCTO,
						DD.NRO_LOTE								AS NRO_LOTE,
						DD.NRO_PARTIDA							AS NRO_PARTIDA,
						CL.DESCRIPCION							AS CAT_LOG,
						CL.CAT_LOG_ID							AS CAT_LOG_ID,
						EM.DESCRIPCION							AS EST_MERC,
						EM.EST_MERC_ID							AS EST_MERC_ID,
						SE.CANTIDAD								AS QTY,
						UPPER(UM.DESCRIPCION)					AS UN
				FROM    SNAP_EXISTENCIAS SE INNER JOIN POSICION P	ON(SE.POSICION_ACTUAL=P.POSICION_ID)
						INNER JOIN NAVE N							ON(P.NAVE_ID = N.NAVE_ID)
						INNER JOIN CLIENTE C						ON(SE.CLIENTE_ID=C.CLIENTE_ID)
						INNER JOIN DET_DOCUMENTO_TRANSACCION DDT	ON(SE.DOC_TRANS_ID=DDT.DOC_TRANS_ID AND SE.NRO_LINEA_TRANS=DDT.NRO_LINEA_TRANS)
						INNER JOIN DET_DOCUMENTO DD					ON(DDT.DOCUMENTO_ID=DD.DOCUMENTO_ID AND DDT.NRO_LINEA_DOC=DD.NRO_LINEA)
						INNER JOIN PRODUCTO PR						ON(DD.CLIENTE_ID=PR.CLIENTE_ID AND DD.PRODUCTO_ID=PR.PRODUCTO_ID)
						INNER JOIN UNIDAD_MEDIDA UM					ON(PR.UNIDAD_ID=UM.UNIDAD_ID)
						INNER JOIN CATEGORIA_LOGICA CL				ON(SE.CLIENTE_ID=CL.CLIENTE_ID AND SE.CAT_LOG_ID=CL.CAT_LOG_ID)
						LEFT JOIN ESTADO_MERCADERIA_RL EM			ON(SE.CLIENTE_ID=EM.CLIENTE_ID AND SE.EST_MERC_ID=EM.EST_MERC_ID)
				WHERE   SE.DISPONIBLE='1'
				UNION ALL
				SELECT  DISTINCT  
						SE.F_SNAP								AS FECHA,
						SE.CLIENTE_ID							AS CLIENTE_ID,
						C.RAZON_SOCIAL							AS CLIENTE,
						PR.PRODUCTO_ID							AS PRODUCTO_ID,						
						PR.PRODUCTO_ID + ' - '+ PR.DESCRIPCION	AS PRODUCTO,
						DD.NRO_LOTE								AS NRO_LOTE,
						DD.NRO_PARTIDA							AS NRO_PARTIDA,
						CL.DESCRIPCION							AS CAT_LOG,
						CL.CAT_LOG_ID							AS CAT_LOG_ID,
						EM.DESCRIPCION							AS EST_MERC,
						EM.EST_MERC_ID							AS EST_MERC_ID,
						SE.CANTIDAD								AS QTY,
						UPPER(UM.DESCRIPCION)					AS UN
				FROM    SNAP_EXISTENCIAS SE INNER JOIN NAVE N		ON(SE.NAVE_ACTUAL = N.NAVE_ID)
						INNER JOIN CLIENTE C						ON(SE.CLIENTE_ID=C.CLIENTE_ID)
						INNER JOIN DET_DOCUMENTO_TRANSACCION DDT	ON(SE.DOC_TRANS_ID=DDT.DOC_TRANS_ID AND SE.NRO_LINEA_TRANS=DDT.NRO_LINEA_TRANS)
						INNER JOIN DET_DOCUMENTO DD					ON(DDT.DOCUMENTO_ID=DD.DOCUMENTO_ID AND DDT.NRO_LINEA_DOC=DD.NRO_LINEA)
						INNER JOIN PRODUCTO PR						ON(DD.CLIENTE_ID=PR.CLIENTE_ID AND DD.PRODUCTO_ID=PR.PRODUCTO_ID)
						INNER JOIN UNIDAD_MEDIDA UM					ON(PR.UNIDAD_ID=UM.UNIDAD_ID)
						INNER JOIN CATEGORIA_LOGICA CL				ON(SE.CLIENTE_ID=CL.CLIENTE_ID AND SE.CAT_LOG_ID=CL.CAT_LOG_ID)
						LEFT JOIN ESTADO_MERCADERIA_RL EM			ON(SE.CLIENTE_ID=EM.CLIENTE_ID AND SE.EST_MERC_ID=EM.EST_MERC_ID)
				WHERE   SE.DISPONIBLE='1')X	
	WHERE	((@FDESDE IS NULL)OR(DBO.TRUNC(X.FECHA) BETWEEN @FDESDE AND @FHASTA))
			AND ((@CLIENTE_ID IS NULL)OR(X.CLIENTE_ID=@CLIENTE_ID))
			AND ((@NRO_LOTE IS NULL)OR(X.NRO_LOTE=@NRO_LOTE))
			AND ((@PRODUCTO_ID IS NULL)OR(X.PRODUCTO_ID=@PRODUCTO_ID))
			AND ((@NRO_PARTIDA IS NULL)OR(X.NRO_PARTIDA=@NRO_PARTIDA))
			AND ((@CAT_LOG_ID IS NULL)OR(X.CAT_LOG_ID=@CAT_LOG_ID))
			AND ((@EST_MERC_ID IS NULL)OR(X.EST_MERC_ID=@EST_MERC_ID))
	GROUP BY
			X.FECHA,X.CLIENTE,X.PRODUCTO_ID,X.PRODUCTO,X.NRO_LOTE,X.NRO_PARTIDA,X.CAT_LOG,X.EST_MERC,X.UN,X.CAT_LOG_ID,X.EST_MERC_ID,X.CLIENTE_ID
	ORDER BY
			1,2,3,4,5,6;				
END
GO

IF @@ERROR <> 0
BEGIN
   IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION
   INSERT INTO #tmpErrors (Error) SELECT 1
   BEGIN TRANSACTION
END
GO

SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[RPT_STOCK_VOLUMEN]
	@FDESDE			DATETIME OUTPUT,
	@FHASTA			DATETIME OUTPUT,
	@CLIENTE_ID		VARCHAR(15)OUTPUT,
	@NAVE_ID		NUMERIC(20,0)OUTPUT
AS
BEGIN
	SELECT  DISTINCT  
			 CONVERT(VARCHAR,SE.F_SNAP,103)		AS FECHA
			,C.RAZON_SOCIAL						AS CLIENTE
			,N.NAVE_COD							AS NAVE_COD
			,QPOS.CTN							AS Q_POS_OCUPADAS
			,QVOL.VOL_POS						AS Q_VOL_POSICIONES
			,PVOL.PVOL							AS Q_VOL_PROD
			,(QVOL.VOL_POS - PVOL.PVOL)			AS Q_VOL_DISP
			,GETDATE()							AS F_IMP
			,HOST_NAME()						AS TERMINAL
	FROM    SNAP_EXISTENCIAS SE INNER JOIN POSICION P 
			ON(SE.POSICION_ACTUAL=P.POSICION_ID)
			INNER JOIN NAVE N                         
			ON(P.NAVE_ID = N.NAVE_ID)
			INNER JOIN CLIENTE C                      
			ON(SE.CLIENTE_ID=C.CLIENTE_ID)
			-------------------------------------------------------------------------------------------------------------------
			LEFT JOIN ( SELECT  COUNT(DISTINCT S.POSICION_ACTUAL) CTN, S.CLIENTE_ID, S.F_SNAP, P.NAVE_ID
						FROM    SNAP_EXISTENCIAS S INNER JOIN POSICION P ON(S.POSICION_ACTUAL=P.POSICION_ID)
						WHERE   S.DISPONIBLE='1'
						GROUP BY S.CLIENTE_ID, S.F_SNAP,P.NAVE_ID)QPOS    
			ON(SE.CLIENTE_ID=QPOS.CLIENTE_ID AND SE.F_SNAP=QPOS.F_SNAP AND P.NAVE_ID=QPOS.NAVE_ID)
			-------------------------------------------------------------------------------------------------------------------
			LEFT JOIN ( SELECT  Y.CLIENTE_ID,Y.F_SNAP,Y.NAVE_ID,SUM(Y.VOL) AS VOL_POS
						FROM    (	SELECT  DISTINCT P.POSICION_ID,P.NAVE_ID, S.CLIENTE_ID, S.F_SNAP, (ISNULL(P.ALTO,0)*ISNULL(P.ANCHO,0)*ISNULL(P.LARGO,0))/1000000 AS VOL
								  FROM    SNAP_EXISTENCIAS S INNER JOIN POSICION P ON(S.POSICION_ACTUAL=P.POSICION_ID)
								  WHERE   S.DISPONIBLE='1'
								)Y
						GROUP BY Y.CLIENTE_ID,Y.F_SNAP,Y.NAVE_ID
					   )QVOL
	                    
			ON(SE.CLIENTE_ID=QVOL.CLIENTE_ID AND SE.F_SNAP=QVOL.F_SNAP AND P.NAVE_ID=QVOL.NAVE_ID) 
			-------------------------------------------------------------------------------------------------------------------
			LEFT JOIN (  SELECT  F.CLIENTE_ID,F.F_SNAP,F.NAVE_ID,SUM(F.PVOL) AS PVOL
						  FROM    ( SELECT  S.CLIENTE_ID, S.F_SNAP, P.NAVE_ID
											,S.CANTIDAD * ((ISNULL(PR.ALTO,0)*ISNULL(PR.ANCHO,0)*ISNULL(PR.LARGO,0))/1000000) AS PVOL
									FROM    SNAP_EXISTENCIAS S INNER JOIN POSICION P  ON(S.POSICION_ACTUAL=P.POSICION_ID)
											INNER JOIN DET_DOCUMENTO_TRANSACCION DDT  ON(DDT.DOC_TRANS_ID=S.DOC_TRANS_ID AND DDT.NRO_LINEA_TRANS=S.NRO_LINEA_TRANS)
											INNER JOIN DET_DOCUMENTO DD               ON(DDT.DOCUMENTO_ID=DD.DOCUMENTO_ID AND DDT.NRO_LINEA_DOC=DD.NRO_LINEA)
											INNER JOIN PRODUCTO PR                    ON(DD.CLIENTE_ID=PR.CLIENTE_ID AND DD.PRODUCTO_ID=PR.PRODUCTO_ID)
								  )F
						  GROUP BY
								  F.CLIENTE_ID,F.F_SNAP,F.NAVE_ID
					  )PVOL
			ON(SE.CLIENTE_ID=PVOL.CLIENTE_ID AND SE.F_SNAP=PVOL.F_SNAP AND N.NAVE_ID=PVOL.NAVE_ID)
			-------------------------------------------------------------------------------------------------------------------
	WHERE   SE.DISPONIBLE='1'
			AND ((@FDESDE IS NULL)OR(dbo.trunc(SE.F_SNAP) BETWEEN @FDESDE AND @FHASTA))
			AND ((@CLIENTE_ID IS NULL)OR(SE.CLIENTE_ID=@CLIENTE_ID))
			AND ((@NAVE_ID IS NULL)OR(N.NAVE_ID=@NAVE_ID))
	UNION ALL
	SELECT  DISTINCT  
			 CONVERT(VARCHAR,SE.F_SNAP,103)		AS FECHA
			,C.RAZON_SOCIAL						AS CLIENTE
			,N.NAVE_COD							AS NAVE_COD
			,NULL								AS Q_POS_OCUPADAS
			,NULL								AS Q_VOL_POSICIONES
			,PVOL.PVOL							AS Q_VOL_PROD
			,NULL								AS Q_VOL_DISP
			,GETDATE()							AS F_IMP
			,HOST_NAME()						AS TERMINAL			
	FROM    SNAP_EXISTENCIAS SE INNER JOIN NAVE N                         
			ON(SE.NAVE_ACTUAL=N.NAVE_ID)
			INNER JOIN CLIENTE C                      
			ON(SE.CLIENTE_ID=C.CLIENTE_ID)
			-------------------------------------------------------------------------------------------------------------------
			LEFT JOIN ( SELECT  F.CLIENTE_ID,F.F_SNAP,F.NAVE_ID,SUM(F.PVOL) AS PVOL
						FROM    (	SELECT  S.CLIENTE_ID, S.F_SNAP, N.NAVE_ID
											,S.CANTIDAD * ((ISNULL(PR.ALTO,0)*ISNULL(PR.ANCHO,0)*ISNULL(PR.LARGO,0))/1000000) AS PVOL
									FROM    SNAP_EXISTENCIAS S INNER JOIN NAVE N	  ON(S.NAVE_ACTUAL=N.NAVE_ID AND NAVE_TIENE_LAYOUT='0')
											INNER JOIN DET_DOCUMENTO_TRANSACCION DDT  ON(DDT.DOC_TRANS_ID=S.DOC_TRANS_ID AND DDT.NRO_LINEA_TRANS=S.NRO_LINEA_TRANS)
											INNER JOIN DET_DOCUMENTO DD               ON(DDT.DOCUMENTO_ID=DD.DOCUMENTO_ID AND DDT.NRO_LINEA_DOC=DD.NRO_LINEA)
											INNER JOIN PRODUCTO PR                    ON(DD.CLIENTE_ID=PR.CLIENTE_ID AND DD.PRODUCTO_ID=PR.PRODUCTO_ID)
									WHERE	S.DISPONIBLE='1'
								)F
						GROUP BY
							  F.CLIENTE_ID,F.F_SNAP,F.NAVE_ID
					  )PVOL
			ON(SE.CLIENTE_ID=PVOL.CLIENTE_ID AND SE.F_SNAP=PVOL.F_SNAP AND N.NAVE_ID=PVOL.NAVE_ID)
			-------------------------------------------------------------------------------------------------------------------
	WHERE   SE.DISPONIBLE='1'
			AND ((@FDESDE IS NULL)OR(dbo.trunc(SE.F_SNAP) BETWEEN @FDESDE AND @FHASTA))
			AND ((@CLIENTE_ID IS NULL)OR(SE.CLIENTE_ID=@CLIENTE_ID))
			AND ((@NAVE_ID IS NULL)OR(N.NAVE_ID=@NAVE_ID))	
	ORDER BY 1,2,3
END;
GO

IF @@ERROR <> 0
BEGIN
   IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION
   INSERT INTO #tmpErrors (Error) SELECT 1
   BEGIN TRANSACTION
END
GO

SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[RPT_STOCK_VOLUMEN_BY_POS]
	@FDESDE			DATETIME OUTPUT,
	@FHASTA			DATETIME OUTPUT,
	@NAVE_ID		VARCHAR(15)OUTPUT,
	@POSICION_ID	VARCHAR(45)OUTPUT
AS
BEGIN
	SELECT  DISTINCT  
			 CONVERT(VARCHAR,SE.F_SNAP,103)   AS FECHA
			,N.NAVE_COD                       AS NAVE_COD
			,P.POSICION_COD					  AS POSICION_COD
			,QVOL.VOL_POS					  AS VOL_POS
			,PVOL.PVOL                        AS Q_VOL_PROD
			,(QVOL.VOL_POS - PVOL.PVOL)       AS Q_VOL_DISP
			,GETDATE()						  AS F_IMP
			,HOST_NAME()					  AS TERMINAL
	FROM    SNAP_EXISTENCIAS SE INNER JOIN POSICION P 
			ON(SE.POSICION_ACTUAL=P.POSICION_ID)
			INNER JOIN NAVE N                         
			ON(P.NAVE_ID = N.NAVE_ID)
			INNER JOIN CLIENTE C                      
			ON(SE.CLIENTE_ID=C.CLIENTE_ID)
			LEFT JOIN ( SELECT  Y.CLIENTE_ID,Y.F_SNAP,Y.POSICION_ID,SUM(Y.VOL) AS VOL_POS
						FROM    ( SELECT  DISTINCT P.POSICION_ID,P.NAVE_ID, S.CLIENTE_ID, S.F_SNAP, (ISNULL(P.ALTO,0)*ISNULL(P.ANCHO,0)*ISNULL(P.LARGO,0))/1000000 AS VOL
								  FROM    SNAP_EXISTENCIAS S INNER JOIN POSICION P ON(S.POSICION_ACTUAL=P.POSICION_ID)
								  WHERE   S.DISPONIBLE='1'
								)Y
						GROUP BY Y.CLIENTE_ID,Y.F_SNAP,Y.POSICION_ID
					   )QVOL
	                    
			ON(SE.CLIENTE_ID=QVOL.CLIENTE_ID AND SE.F_SNAP=QVOL.F_SNAP AND P.POSICION_ID=QVOL.POSICION_ID) 
			-------------------------------------------------------------------------------------------------------------------
			LEFT JOIN (  SELECT  F.CLIENTE_ID,F.F_SNAP,F.NAVE_ID,SUM(F.PVOL) AS PVOL
						  FROM    ( SELECT  S.CLIENTE_ID, S.F_SNAP, P.NAVE_ID
											,S.CANTIDAD * ((ISNULL(PR.ALTO,0)*ISNULL(PR.ANCHO,0)*ISNULL(PR.LARGO,0))/1000000) AS PVOL
									FROM    SNAP_EXISTENCIAS S INNER JOIN POSICION P  ON(S.POSICION_ACTUAL=P.POSICION_ID)
											INNER JOIN DET_DOCUMENTO_TRANSACCION DDT  ON(DDT.DOC_TRANS_ID=S.DOC_TRANS_ID AND DDT.NRO_LINEA_TRANS=S.NRO_LINEA_TRANS)
											INNER JOIN DET_DOCUMENTO DD               ON(DDT.DOCUMENTO_ID=DD.DOCUMENTO_ID AND DDT.NRO_LINEA_DOC=DD.NRO_LINEA)
											INNER JOIN PRODUCTO PR                    ON(DD.CLIENTE_ID=PR.CLIENTE_ID AND DD.PRODUCTO_ID=PR.PRODUCTO_ID)
								  )F
						  GROUP BY
								  F.CLIENTE_ID,F.F_SNAP,F.NAVE_ID
					  )PVOL
			ON(SE.CLIENTE_ID=PVOL.CLIENTE_ID AND SE.F_SNAP=PVOL.F_SNAP AND N.NAVE_ID=PVOL.NAVE_ID)
			-------------------------------------------------------------------------------------------------------------------
	WHERE   SE.DISPONIBLE='1'
			AND ((@FDESDE IS NULL)OR(dbo.trunc(SE.F_SNAP) BETWEEN @FDESDE AND @FHASTA))
			AND ((@NAVE_ID IS NULL)OR(N.NAVE_ID=@NAVE_ID))
			AND ((@POSICION_ID IS NULL)OR(P.POSICION_ID=@POSICION_ID))
	UNION ALL
	SELECT  DISTINCT  
			 CONVERT(VARCHAR,SE.F_SNAP,103)   AS FECHA
			,N.NAVE_COD                       AS NAVE_COD
			,NULL							  AS POSICION_COD
			,NULL							  AS VOL_POS
			,PVOL.PVOL                        AS Q_VOL_PROD
			,NULL							  AS Q_VOL_DISP
			,GETDATE()						  AS F_IMP
			,HOST_NAME()					  AS TERMINAL			
	FROM    SNAP_EXISTENCIAS SE INNER JOIN NAVE N                         
			ON(N.NAVE_ID = N.NAVE_ID AND NAVE_TIENE_LAYOUT='0' AND PRE_INGRESO='0' AND PRE_EGRESO='0')
			INNER JOIN CLIENTE C                      
			ON(SE.CLIENTE_ID=C.CLIENTE_ID)
			INNER JOIN (  SELECT  F.CLIENTE_ID,F.F_SNAP,F.NAVE_ID,SUM(F.PVOL) AS PVOL
						  FROM    ( SELECT  S.CLIENTE_ID, S.F_SNAP, N.NAVE_ID
											,S.CANTIDAD * ((ISNULL(PR.ALTO,0)*ISNULL(PR.ANCHO,0)*ISNULL(PR.LARGO,0))/1000000) AS PVOL
									FROM    SNAP_EXISTENCIAS S INNER JOIN NAVE N	  ON(S.NAVE_ACTUAL=N.NAVE_ID)
											INNER JOIN DET_DOCUMENTO_TRANSACCION DDT  ON(DDT.DOC_TRANS_ID=S.DOC_TRANS_ID AND DDT.NRO_LINEA_TRANS=S.NRO_LINEA_TRANS)
											INNER JOIN DET_DOCUMENTO DD               ON(DDT.DOCUMENTO_ID=DD.DOCUMENTO_ID AND DDT.NRO_LINEA_DOC=DD.NRO_LINEA)
											INNER JOIN PRODUCTO PR                    ON(DD.CLIENTE_ID=PR.CLIENTE_ID AND DD.PRODUCTO_ID=PR.PRODUCTO_ID)
								  )F
						  GROUP BY
								  F.CLIENTE_ID,F.F_SNAP,F.NAVE_ID
					  )PVOL
			ON(SE.CLIENTE_ID=PVOL.CLIENTE_ID AND SE.F_SNAP=PVOL.F_SNAP AND N.NAVE_ID=PVOL.NAVE_ID)
			-------------------------------------------------------------------------------------------------------------------
	WHERE   SE.DISPONIBLE='1'
			AND ((@FDESDE IS NULL)OR(dbo.trunc(SE.F_SNAP) BETWEEN @FDESDE AND @FHASTA))
			AND ((@NAVE_ID IS NULL)OR(N.NAVE_ID=@NAVE_ID))
			AND ((@POSICION_ID IS NULL)OR(N.NAVE_ID=-1))				
END;
GO

IF @@ERROR <> 0
BEGIN
   IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION
   INSERT INTO #tmpErrors (Error) SELECT 1
   BEGIN TRANSACTION
END
GO

SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE dbo.sp_upgraddiagrams
	AS
	BEGIN
		IF OBJECT_ID(N'dbo.sysdiagrams') IS NOT NULL
			return 0;
	
		CREATE TABLE dbo.sysdiagrams
		(
			name sysname NOT NULL,
			principal_id int NOT NULL,	-- we may change it to varbinary(85)
			diagram_id int PRIMARY KEY IDENTITY,
			version int,
	
			definition varbinary(max)
			CONSTRAINT UK_principal_name UNIQUE
			(
				principal_id,
				name
			)
		);


		/* Add this if we need to have some form of extended properties for diagrams */
		/*
		IF OBJECT_ID(N'dbo.sysdiagram_properties') IS NULL
		BEGIN
			CREATE TABLE dbo.sysdiagram_properties
			(
				diagram_id int,
				name sysname,
				value varbinary(max) NOT NULL
			)
		END
		*/

		IF OBJECT_ID(N'dbo.dtproperties') IS NOT NULL
		begin
			insert into dbo.sysdiagrams
			(
				[name],
				[principal_id],
				[version],
				[definition]
			)
			select	 
				convert(sysname, dgnm.[uvalue]),
				DATABASE_PRINCIPAL_ID(N'dbo'),			-- will change to the sid of sa
				0,							-- zero for old format, dgdef.[version],
				dgdef.[lvalue]
			from dbo.[dtproperties] dgnm
				inner join dbo.[dtproperties] dggd on dggd.[property] = 'DtgSchemaGUID' and dggd.[objectid] = dgnm.[objectid]	
				inner join dbo.[dtproperties] dgdef on dgdef.[property] = 'DtgSchemaDATA' and dgdef.[objectid] = dgnm.[objectid]
				
			where dgnm.[property] = 'DtgSchemaNAME' and dggd.[uvalue] like N'_EA3E6268-D998-11CE-9454-00AA00A3F36E_' 
			return 2;
		end
		return 1;
	END
GO

IF @@ERROR <> 0
BEGIN
   IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION
   INSERT INTO #tmpErrors (Error) SELECT 1
   BEGIN TRANSACTION
END
GO

SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
GO

-- =========================================================
-- Author:      LRojas
-- Create date: 09/02/2012
-- Description: Retorna el valor de sys_parametro_proceso
-- =========================================================
CREATE PROCEDURE [dbo].[sp_valor_sys_parametro_proceso](
	@num_key    Integer Output
)
AS
BEGIN
	SET NOCOUNT ON

	IF @num_key = 1
		SELECT *
		  FROM SYS_PARAMETRO_PROCESO
		 WHERE PROCESO_ID = 'WARP'
		   AND SUBPROCESO_ID = 'PROTECCION'
		   AND PARAMETRO_ID = 'KEY1'

	IF @num_key = 2
		SELECT *
		  FROM SYS_PARAMETRO_PROCESO
		 WHERE PROCESO_ID = 'WARP'
		   AND SUBPROCESO_ID = 'PROTECCION'
		   AND PARAMETRO_ID = 'KEY2'

	IF @num_key = 3
		SELECT *
		  FROM SYS_PARAMETRO_PROCESO
		 WHERE PROCESO_ID = 'WARP'
		   AND SUBPROCESO_ID = 'PROTECCION'
		   AND PARAMETRO_ID = 'PORT'

END
Return
GO

IF @@ERROR <> 0
BEGIN
   IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION
   INSERT INTO #tmpErrors (Error) SELECT 1
   BEGIN TRANSACTION
END
GO

SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[SPLIT_PICKING_CONTENEDORA]
	@PICKING_ID		NUMERIC(20,0),
	@CANTIDAD		NUMERIC(20,5),
	@OUT			CHAR(1) OUTPUT
AS
BEGIN
	DECLARE @NEW_PICK		NUMERIC(20,0)
	DECLARE @NEW_LINEA		NUMERIC(10,0)
	DECLARE @DOCUMENTO_ID	NUMERIC(20,0)
	DECLARE @NRO_LINEA		NUMERIC(10,0)
	DECLARE @NEW_RL			NUMERIC(20,0)

	SELECT	DISTINCT @DOCUMENTO_ID=DOCUMENTO_ID, @NRO_LINEA=NRO_LINEA
	FROM	PICKING
	WHERE	PICKING_ID=@PICKING_ID

	--SACO LA NUEVA LINEA.
	SELECT	@NEW_LINEA=MAX(DD.NRO_LINEA)+1
	FROM	DET_DOCUMENTO DD
	WHERE	EXISTS (SELECT	1
					FROM	PICKING PIK
					WHERE	DD.DOCUMENTO_ID=PIK.DOCUMENTO_ID
							AND PIK.PICKING_ID=@PICKING_ID)
	BEGIN TRY
		-------------------------------------------------------------------------------
		--1 SPLIT DETALLES DOCUMENTOS.
		-------------------------------------------------------------------------------
		INSERT INTO DET_DOCUMENTO
		SELECT	DOCUMENTO_ID,		@NEW_LINEA,			CLIENTE_ID,			PRODUCTO_ID,	ABS(@CANTIDAD),
				NRO_SERIE,			NRO_SERIE_PADRE,	EST_MERC_ID,		CAT_LOG_ID,		NRO_BULTO,
				DESCRIPCION,		NRO_LOTE,			FECHA_VENCIMIENTO,	NRO_DESPACHO,	NRO_PARTIDA,
				UNIDAD_ID,			PESO,				UNIDAD_PESO,		VOLUMEN,		UNIDAD_VOLUMEN,
				BUSC_INDIVIDUAL,	ISNULL(TIE_IN,'0'),	NRO_TIE_IN_PADRE,	NRO_TIE_IN,		ITEM_OK,
				CAT_LOG_ID_FINAL,	MONEDA_ID,			COSTO,				PROP1,			PROP2,
				PROP3,				LARGO,				ALTO,				ANCHO,			VOLUMEN_UNITARIO,
				PESO_UNITARIO,		CANT_SOLICITADA,	TRACE_BACK_ORDER
		FROM	DET_DOCUMENTO DD
		WHERE	EXISTS (SELECT	1
						FROM	PICKING PIK
						WHERE	DD.DOCUMENTO_ID=PIK.DOCUMENTO_ID
								AND DD.NRO_LINEA=PIK.NRO_LINEA
								AND PIK.PICKING_ID=@PICKING_ID)

		UPDATE	DET_DOCUMENTO SET CANTIDAD=CANTIDAD-@CANTIDAD
		WHERE	EXISTS (SELECT	1
						FROM	PICKING PIK
						WHERE	DET_DOCUMENTO.DOCUMENTO_ID=PIK.DOCUMENTO_ID
								AND DET_DOCUMENTO.NRO_LINEA=PIK.NRO_LINEA
								AND PIK.PICKING_ID=@PICKING_ID)

		-------------------------------------------------------------------------------	
		--2 SPLIT DET. DOCUMENTO TRANSACCION.
		-------------------------------------------------------------------------------
		INSERT INTO DET_DOCUMENTO_TRANSACCION
		SELECT	DOC_TRANS_ID,	@NEW_LINEA,				DOCUMENTO_ID,		@NEW_LINEA,
				MOTIVO_ID,		EST_MERC_ID,			CLIENTE_ID,			CAT_LOG_ID,
				ITEM_OK,		MOVIMIENTO_PENDIENTE,	DOC_TRANS_ID_REF,	NRO_LINEA_TRANS_REF
		FROM	DET_DOCUMENTO_TRANSACCION
		WHERE	DOCUMENTO_ID=@DOCUMENTO_ID AND NRO_LINEA_DOC=@NRO_LINEA;

		-------------------------------------------------------------------------------		
		--3 SPLIT RL.
		-------------------------------------------------------------------------------	
		INSERT INTO RL_DET_DOC_TRANS_POSICION(	DOC_TRANS_ID,		NRO_LINEA_TRANS,	POSICION_ANTERIOR,	POSICION_ACTUAL,
												CANTIDAD,			TIPO_MOVIMIENTO_ID,	ULTIMA_ESTACION,	ULTIMA_SECUENCIA,
												NAVE_ANTERIOR,		NAVE_ACTUAL,		DOCUMENTO_ID,		NRO_LINEA,
												DISPONIBLE,			DOC_TRANS_ID_EGR,	NRO_LINEA_TRANS_EGR,DOC_TRANS_ID_TR,
												NRO_LINEA_TRANS_TR,	CLIENTE_ID,			CAT_LOG_ID,			CAT_LOG_ID_FINAL,
												EST_MERC_ID)
		SELECT	DOC_TRANS_ID,		NRO_LINEA_TRANS,		POSICION_ANTERIOR,
				POSICION_ACTUAL,	ABS(@CANTIDAD),			TIPO_MOVIMIENTO_ID,
				ULTIMA_ESTACION,	ULTIMA_SECUENCIA,		NAVE_ANTERIOR,
				NAVE_ACTUAL,		DOCUMENTO_ID,			NRO_LINEA,
				DISPONIBLE,			DOC_TRANS_ID_EGR,		@NEW_LINEA,
				DOC_TRANS_ID_TR,	NRO_LINEA_TRANS_TR,		CLIENTE_ID,
				CAT_LOG_ID,			CAT_LOG_ID_FINAL,		EST_MERC_ID
		FROM	RL_DET_DOC_TRANS_POSICION RL
		WHERE	EXISTS(	SELECT	1
						FROM	DET_DOCUMENTO_TRANSACCION DDT
						WHERE	RL.DOC_TRANS_ID_EGR=DDT.DOC_TRANS_ID
								AND RL.NRO_LINEA_TRANS_EGR=DDT.NRO_LINEA_TRANS
								AND DDT.DOCUMENTO_ID=@DOCUMENTO_ID
								AND DDT.NRO_LINEA_DOC=@NRO_LINEA)

		SET @NEW_RL=SCOPE_IDENTITY()

		UPDATE	RL_DET_DOC_TRANS_POSICION
		SET		CANTIDAD=CANTIDAD-ABS(@CANTIDAD)
		WHERE	EXISTS(	SELECT	1
						FROM	DET_DOCUMENTO_TRANSACCION DDT
						WHERE	RL_DET_DOC_TRANS_POSICION.DOC_TRANS_ID_EGR=DDT.DOC_TRANS_ID
								AND RL_DET_DOC_TRANS_POSICION.NRO_LINEA_TRANS_EGR=DDT.NRO_LINEA_TRANS
								AND DDT.DOCUMENTO_ID=@DOCUMENTO_ID
								AND DDT.NRO_LINEA_DOC=@NRO_LINEA)
		-------------------------------------------------------------------------------	
		--4 SPLIT PICKING.
		-------------------------------------------------------------------------------		
		IF (@CANTIDAD>0)
		BEGIN
			INSERT INTO PICKING(
					DOCUMENTO_ID,		NRO_LINEA,				CLIENTE_ID,				PRODUCTO_ID,			VIAJE_ID,			TIPO_CAJA,
					DESCRIPCION,		CANTIDAD,				NAVE_COD,				POSICION_COD,			RUTA,				PROP1,
					FECHA_INICIO,		FECHA_FIN,				USUARIO,				CANT_CONFIRMADA,		PALLET_PICKING,		SALTO_PICKING,
					PALLET_CONTROLADO,	USUARIO_CONTROL_PICK,	ST_ETIQUETAS,			ST_CAMION,				FACTURADO,			FIN_PICKING,
					ST_CONTROL_EXP,		FECHA_CONTROL_PALLET,	TERMINAL_CONTROL_PALLET,FECHA_CONTROL_EXP,		USUARIO_CONTROL_EXP,TERMINAL_CONTROL_EXP,
					FECHA_CONTROL_FAC,	USUARIO_CONTROL_FAC,	TERMINAL_CONTROL_FAC,	VEHICULO_ID,			PALLET_COMPLETO,	HIJO,
					QTY_CONTROLADO,		PALLET_FINAL,			PALLET_CERRADO,			USUARIO_PF,				TERMINAL_PF,		REMITO_IMPRESO,
					NRO_REMITO_PF,		PICKING_ID_REF,			BULTOS_CONTROLADOS,		BULTOS_NO_CONTROLADOS,	FLG_PALLET_HOMBRE,	TRANSF_TERMINADA,
					NRO_LOTE,			NRO_PARTIDA,			NRO_SERIE)
			SELECT	DOCUMENTO_ID,	@NEW_LINEA,	CLIENTE_ID,	PRODUCTO_ID,	VIAJE_ID,	TIPO_CAJA,	DESCRIPCION,	ABS(@CANTIDAD),
					NAVE_COD,		POSICION_COD,	RUTA,	PROP1,	FECHA_INICIO,	FECHA_FIN,	USUARIO,	CANT_CONFIRMADA,
					PALLET_PICKING,	SALTO_PICKING,	PALLET_CONTROLADO,	USUARIO_CONTROL_PICK,	ST_ETIQUETAS,	ST_CAMION,
					FACTURADO,	FIN_PICKING,	ST_CONTROL_EXP,	FECHA_CONTROL_PALLET,	TERMINAL_CONTROL_PALLET,
					FECHA_CONTROL_EXP,	USUARIO_CONTROL_EXP,	TERMINAL_CONTROL_EXP,	FECHA_CONTROL_FAC,
					USUARIO_CONTROL_FAC,	TERMINAL_CONTROL_FAC,	VEHICULO_ID,	PALLET_COMPLETO,	HIJO,
					QTY_CONTROLADO,	PALLET_FINAL,	PALLET_CERRADO,	USUARIO_PF,	TERMINAL_PF,	REMITO_IMPRESO,
					NRO_REMITO_PF,	PICKING_ID_REF,	BULTOS_CONTROLADOS,	BULTOS_NO_CONTROLADOS,	FLG_PALLET_HOMBRE,
					TRANSF_TERMINADA,	NRO_LOTE,	NRO_PARTIDA,	NRO_SERIE
			FROM	PICKING
			WHERE	PICKING_ID=@PICKING_ID
		END
		ELSE
		BEGIN
			INSERT INTO PICKING(
					DOCUMENTO_ID,		NRO_LINEA,				CLIENTE_ID,				PRODUCTO_ID,			VIAJE_ID,			TIPO_CAJA,
					DESCRIPCION,		CANTIDAD,				NAVE_COD,				POSICION_COD,			RUTA,				PROP1,
					FECHA_INICIO,		FECHA_FIN,				USUARIO,				CANT_CONFIRMADA,		PALLET_PICKING,		SALTO_PICKING,
					PALLET_CONTROLADO,	USUARIO_CONTROL_PICK,	ST_ETIQUETAS,			ST_CAMION,				FACTURADO,			FIN_PICKING,
					ST_CONTROL_EXP,		FECHA_CONTROL_PALLET,	TERMINAL_CONTROL_PALLET,FECHA_CONTROL_EXP,		USUARIO_CONTROL_EXP,TERMINAL_CONTROL_EXP,
					FECHA_CONTROL_FAC,	USUARIO_CONTROL_FAC,	TERMINAL_CONTROL_FAC,	VEHICULO_ID,			PALLET_COMPLETO,	HIJO,
					QTY_CONTROLADO,		PALLET_FINAL,			PALLET_CERRADO,			USUARIO_PF,				TERMINAL_PF,		REMITO_IMPRESO,
					NRO_REMITO_PF,		PICKING_ID_REF,			BULTOS_CONTROLADOS,		BULTOS_NO_CONTROLADOS,	FLG_PALLET_HOMBRE,	TRANSF_TERMINADA,
					NRO_LOTE,			NRO_PARTIDA,			NRO_SERIE)
			SELECT	DOCUMENTO_ID,	@NEW_LINEA,	CLIENTE_ID,	PRODUCTO_ID,	VIAJE_ID,	TIPO_CAJA,	DESCRIPCION,	ABS(@CANTIDAD),
					NAVE_COD,		POSICION_COD,	RUTA,	PROP1,	NULL FECHA_INICIO,	NULL FECHA_FIN,	NULL USUARIO,	CANT_CONFIRMADA,
					NULL PALLET_PICKING,	SALTO_PICKING,	PALLET_CONTROLADO,	USUARIO_CONTROL_PICK,	ST_ETIQUETAS,	ST_CAMION,
					FACTURADO,	FIN_PICKING,	ST_CONTROL_EXP,	FECHA_CONTROL_PALLET,	TERMINAL_CONTROL_PALLET,
					FECHA_CONTROL_EXP,	USUARIO_CONTROL_EXP,	TERMINAL_CONTROL_EXP,	FECHA_CONTROL_FAC,
					USUARIO_CONTROL_FAC,	TERMINAL_CONTROL_FAC,	VEHICULO_ID,	PALLET_COMPLETO,	HIJO,
					QTY_CONTROLADO,	PALLET_FINAL,	PALLET_CERRADO,	USUARIO_PF,	TERMINAL_PF,	REMITO_IMPRESO,
					NRO_REMITO_PF,	PICKING_ID_REF,	BULTOS_CONTROLADOS,	BULTOS_NO_CONTROLADOS,	FLG_PALLET_HOMBRE,
					TRANSF_TERMINADA,	NRO_LOTE,	NRO_PARTIDA,	NRO_SERIE
			FROM	PICKING
			WHERE	PICKING_ID=@PICKING_ID		
		END
		UPDATE	PICKING 
		SET		CANTIDAD=CANTIDAD-ABS(@CANTIDAD)
		WHERE	PICKING_ID=@PICKING_ID

		SET @NEW_PICK=SCOPE_IDENTITY()

		SET @OUT='0'
	END TRY
	BEGIN CATCH
		SET @OUT='1'
	END CATCH
END--FIN PROCEDURE.
GO

IF @@ERROR <> 0
BEGIN
   IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION
   INSERT INTO #tmpErrors (Error) SELECT 1
   BEGIN TRANSACTION
END
GO

SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE SPLIT_RL_CONSUMO_EGRESO
(@RL_ID	NUMERIC(20,0)
,@QTY NUMERIC(20,5))
AS
BEGIN

	DECLARE @CANTIDADORIGINAL	NUMERIC(20,5)
	DECLARE @NEWRLID			NUMERIC(20,0)

	SELECT @CANTIDADORIGINAL = CANTIDAD FROM RL_DET_DOC_TRANS_POSICION WHERE RL_ID = @RL_ID

	IF @CANTIDADORIGINAL = @QTY
		RETURN

	INSERT INTO [RL_DET_DOC_TRANS_POSICION]
           ([DOC_TRANS_ID]
           ,[NRO_LINEA_TRANS]
           ,[POSICION_ANTERIOR]
           ,[POSICION_ACTUAL]
           ,[CANTIDAD]
           ,[TIPO_MOVIMIENTO_ID]
           ,[ULTIMA_ESTACION]
           ,[ULTIMA_SECUENCIA]
           ,[NAVE_ANTERIOR]
           ,[NAVE_ACTUAL]
           ,[DOCUMENTO_ID]
           ,[NRO_LINEA]
           ,[DISPONIBLE]
           ,[DOC_TRANS_ID_EGR]
           ,[NRO_LINEA_TRANS_EGR]
           ,[DOC_TRANS_ID_TR]
           ,[NRO_LINEA_TRANS_TR]
           ,[CLIENTE_ID]
           ,[CAT_LOG_ID]
           ,[CAT_LOG_ID_FINAL]
           ,[EST_MERC_ID])
	SELECT [DOC_TRANS_ID]
           ,[NRO_LINEA_TRANS]
           ,[POSICION_ANTERIOR]
           ,[POSICION_ACTUAL]
           ,[CANTIDAD]
           ,[TIPO_MOVIMIENTO_ID]
           ,[ULTIMA_ESTACION]
           ,[ULTIMA_SECUENCIA]
           ,[NAVE_ANTERIOR]
           ,[NAVE_ACTUAL]
           ,[DOCUMENTO_ID]
           ,[NRO_LINEA]
           ,[DISPONIBLE]
           ,[DOC_TRANS_ID_EGR]
           ,[NRO_LINEA_TRANS_EGR]
           ,[DOC_TRANS_ID_TR]
           ,[NRO_LINEA_TRANS_TR]
           ,[CLIENTE_ID]
           ,[CAT_LOG_ID]
           ,[CAT_LOG_ID_FINAL]
           ,[EST_MERC_ID]
	FROM RL_DET_DOC_TRANS_POSICION WHERE RL_ID = @RL_ID

	SET @NEWRLID = SCOPE_IDENTITY()

	UPDATE RL_DET_DOC_TRANS_POSICION SET CANTIDAD = @QTY WHERE RL_ID = @RL_ID
	UPDATE RL_DET_DOC_TRANS_POSICION SET CANTIDAD = CANTIDAD-@QTY WHERE RL_ID = @NEWRLID
	
END
GO

IF @@ERROR <> 0
BEGIN
   IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION
   INSERT INTO #tmpErrors (Error) SELECT 1
   BEGIN TRANSACTION
END
GO

SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[SYS_DEV_EGRESO_EMPAQUE]
 @pviaje AS varchar(100) output
AS
	declare @Qty as numeric(10,0)
	declare @ErrorSave int
	declare @AuxNroLinea bigint
	declare @ControlExpedicion char(1)
	declare @TipoComp	as varchar(5)
	declare @Usuario 	as varchar(20)
	declare @count		as smallint
	declare @controla	as char(1)
BEGIN
	begin try

		IF EXISTS (SELECT 1 FROM SYS_DEV_DOCUMENTO WHERE CODIGO_VIAJE = @pviaje)
			RETURN
		--Controlo que el viaje no este cerrado
		select @Qty=count(picking_id) from picking where viaje_id=@pViaje and facturado='1'
		if (@Qty>0) begin
			RAISERROR('El Picking/Viaje ya fue Cerrado!!!!',16,1)
			RETURN 
		end --if

		--Controlo que el viaje tenga todos los picking's cerrados
		set @Qty=0
		select @Qty=count(picking_id) from picking where (fin_picking in ('0','1') or fin_picking is null) and viaje_id=@pViaje
		if (@Qty>0) begin
			RAISERROR('Aun quedan Productos Pendientes por Pickear!!!!',16,1)
			RETURN 	
		end --if

		--Controlo que no queden en sys_int_det_documento productos pendientes 
		set @Qty=0
		select @Qty=count(dd.doc_ext) 
		from sys_int_det_documento dd 
			inner join sys_int_documento d on (dd.cliente_id=d.cliente_id and dd.doc_ext=d.doc_ext)		
			inner join producto prod on (dd.cliente_id=prod.cliente_id and dd.producto_id=prod.producto_id)
		where dd.estado_gt is null and d.codigo_viaje=@pViaje
		if (@Qty>0) begin
			RAISERROR('El Picking/Viaje aun Tiene Productos Pendientes por Procesar!!!!',16,1)
			RETURN 	
		end --if

		If Dbo.GetTipoDocumento(@pViaje)='E10'
		Begin
			Exec Dbo.Sys_Dev_EgresoE10 @pViaje
			Return
		End
		   insert into sys_dev_documento
			select
			distinct 
			sid.CLIENTE_ID, 
			CASE WHEN sid.tipo_documento_id='E04' THEN 'E05' WHEN sid.tipo_documento_id='E08' THEN 'E09' ELSE sid.tipo_documento_id END, 
			sid.CPTE_PREFIJO, 
			sid.CPTE_NUMERO, 
			getdate(), --FECHA_CPTE, 
			sid.FECHA_SOLICITUD_CPTE, 
			sid.AGENTE_ID, 
			sid.PESO_TOTAL, 
			sid.UNIDAD_PESO, 
			sid.VOLUMEN_TOTAL, 
			sid.UNIDAD_VOLUMEN, 
			sid.TOTAL_BULTOS, 
			sid.ORDEN_DE_COMPRA, 
			sid.OBSERVACIONES, 
			cast(d.cpte_prefijo as varchar(20)) + cast(d.cpte_numero  as varchar(20)), 
			sid.NRO_DESPACHO_IMPORTACION, 
			sid.DOC_EXT, 
			sid.CODIGO_VIAJE, 
			sid.INFO_ADICIONAL_1, 
			sid.INFO_ADICIONAL_2, 
			sid.INFO_ADICIONAL_3, 
   			d.TIPO_COMPROBANTE_id, 	
			NULL, 
			NULL, 
			'P', 
			GETDATE(),
			Null --Flg_Movimiento 
			from	sys_int_documento sid
					left join documento d on (sid.cliente_id=d.cliente_id and sid.doc_ext=d.nro_remito)
			where	sid.codigo_viaje=@pViaje
					and not exists (select	1 
									from	sys_dev_documento sd 
									where	sd.cliente_id=sid.cliente_id
											and sd.doc_ext=sid.doc_ext)
			IF @@ERROR <> 0 BEGIN
				SET @ErrorSave = @@ERROR
				RAISERROR('Error al Insertar en Sys_Dev_Documento, Codigo_Error: %s',16,1,@ErrorSave)
				RETURN
			END

			insert into sys_dev_det_documento
			select	 d.nro_remito as doc_ext
					,(p.picking_id) as nro_linea
					,dd.cliente_id
					,dd.producto_id
					,dd.cant_solicitada
					,p.cant_confirmada
					,dd.est_merc_id
					,dd.cat_log_id_final
					,null as nro_bulto
					,dd.descripcion
					,dd.nro_lote
					,dd.prop1 as nro_pallet
					,dd.fecha_vencimiento
					,null as nro_despacho
					,dd.nro_partida
					,unidad_id
					,null as unidad_contenedora_id
					,null as peso
					,null as unidad_peso
					,null as volumen
					,null as unidad_volumen
					,dbo.get_property(dd.cliente_id,d.nro_remito,dd.producto_id,1) as prop1
					,dbo.get_property(dd.cliente_id,d.nro_remito,dd.producto_id,2) as prop2
					,dbo.get_property(dd.cliente_id,d.nro_remito,dd.producto_id,3) as prop3
					,null as largo
					,null as alto
					,dd.nro_linea as ancho --nro de linea
					,null as doc_back_order
					,null as estado
					,null as fecha_estado
					,'P' as estado_gt
					,getdate() as fecha_estado_gt
					,p.documento_id
					,dbo.Aj_NaveCod_to_Nave_id(p.nave_cod) as nave_id
					,p.nave_cod	
					,Null		--Flg_Movimiento
			from 	det_documento dd
					inner join documento d on (dd.documento_id=d.documento_id)
					inner join picking p on (dd.documento_id=p.documento_id and dd.nro_linea=p.nro_linea)
					--JOIN AGREGADO PORQUE TREA MAS REGISTROS DADO QUE EXISTE OTRO DOCUMENTO EN LA TABLA DOCUMENTO
					--QUE TIENE EL MISMO 
					INNER JOIN sys_int_documento sid ON (sid.cliente_id=d.cliente_id and sid.doc_ext=d.nro_remito)
			where
					p.Viaje_id=@pViaje
					and not exists (select 1 from sys_dev_det_documento where sys_dev_det_documento.cliente_id = dd.cliente_id and sys_dev_det_documento.doc_Ext = d.nro_remito and sys_dev_det_documento.nro_linea = p.picking_id)

			IF @@ERROR <> 0 BEGIN
				SET @ErrorSave = @@ERROR
				RAISERROR('Error al Insertar en Sys_Dev_Det_Documento, Codigo_Error: %s',16,1,@ErrorSave)
				RETURN
			END
		  
		--Insert los productos que no ingresaron en el documento por falta de Stock
			insert into sys_dev_det_documento
			select dd.doc_ext
			,dd.nro_linea
			,dd.cliente_id
			,dd.producto_id
			,dd.cantidad_solicitada
			,0
			,dd.est_merc_id
			,dd.cat_log_id
			,dd.nro_bulto
			,dd.descripcion
			,dd.nro_lote
			,dd.nro_pallet
			,dd.fecha_vencimiento
			,dd.nro_despacho
			,dd.nro_partida
			,dd.unidad_id
			,dd.unidad_contenedora_id
			,dd.peso
			,dd.unidad_peso
			,dd.volumen
			,dd.unidad_volumen
			,dd.prop1
			,dd.prop2
			,dd.prop3
			,dd.largo
			,dd.alto
			,dd.ancho
			,dd.doc_back_order
			,null
			,null
			,dd.estado_gt
			,getdate()
			,dd.documento_id
			,dd.nave_id
			,dd.nave_cod
			,Null --Flg_Movimiento
			from 
			sys_int_det_documento dd
			inner join sys_int_documento d on (d.cliente_id=dd.cliente_id and d.doc_ext=dd.doc_ext)
			where cast(dd.doc_ext + dd.producto_id as varchar(400))  not in 
			(select cast(doc_ext + producto_id as varchar(400)) from sys_dev_det_documento)
			and d.codigo_viaje=@pViaje
			and not exists (select 1 from sys_dev_det_documento where sys_dev_det_documento.cliente_id = dd.cliente_id and sys_dev_det_documento.doc_Ext = dd.doc_ext and sys_dev_det_documento.nro_linea = dd.nro_linea)

			IF @@ERROR <> 0 BEGIN
				SET @ErrorSave = @@ERROR
				RAISERROR('Error al Insertar en Sys_Dev_Det_Documento de los Productos Sin Stock, Codigo_Error: %s',16,1,@ErrorSave)
				RETURN
			END
		 	
			exec DBO.PedidoMultiProducto @pViaje

			IF @@ERROR <> 0 BEGIN
				SET @ErrorSave = @@ERROR
				RAISERROR('Error Al Ejecutar la devolucion Pedido MultiProducto, Codigo_Error: %s',16,1,@ErrorSave)
				RETURN
			END


			IF @@ERROR <> 0 BEGIN
				SET @ErrorSave = @@ERROR
				RAISERROR('Error Al Realizar la Actualizacion en Cierre de Picking, Codigo_Error: %s',16,1,@ErrorSave)
				RETURN
			END
	end try
	begin catch
		exec usp_RethrowError
	end catch
END
GO

IF @@ERROR <> 0
BEGIN
   IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION
   INSERT INTO #tmpErrors (Error) SELECT 1
   BEGIN TRANSACTION
END
GO

SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[TOLERANCIA_OC] --Control de tolerancia de productos Minima y Maxima
	@CLIENTE_ID		VARCHAR(15),
	@OC				VARCHAR(100),
	@PRODUCTO_ID	VARCHAR(30),
	@NRO_LOTE		VARCHAR(100),
	@NRO_PARTIDA	VARCHAR(100),
	@TolMax			Float output,
	@TolMin			Float output	
AS
BEGIN
	SET XACT_ABORT ON
	SET NOCOUNT ON
	
	DECLARE @ToleranciaMax		Float
	DECLARE @ToleranciaMin		Float
	DECLARE @DOC_EXT			VARCHAR(100)
	DECLARE @SUCURSAL_ORIGEN	VARCHAR(20)
	DECLARE @qtyBO				Float
	
	SELECT @ToleranciaMax=isnull(TOLERANCIA_MAX,0), @ToleranciaMin=isnull(TOLERANCIA_MIN,0) from producto where cliente_id=@cliente_id and producto_id=@producto_id
	

				
	Select 	@qtyBO=sum(SS.cantidad_solicitada)
		from	sys_int_det_documento SS
		INNER JOIN SYS_INT_DOCUMENTO S ON (SS.CLIENTE_ID = S.CLIENTE_ID AND SS.DOC_EXT = S.DOC_eXT)
		where	S.ORDEN_DE_COMPRA=@OC
				AND SS.PRODUCTO_ID=@PRODUCTO_ID
				AND S.CLIENTE_ID=@CLIENTE_ID
				AND (((@NRO_LOTE = '' OR @NRO_LOTE IS NULL) AND (SS.NRO_LOTE = '' OR SS.NRO_LOTE IS NULL)) OR @NRO_LOTE = SS.NRO_LOTE)
				AND (((@NRO_PARTIDA = '' OR @NRO_PARTIDA IS NULL) AND (SS.NRO_PARTIDA = '' OR SS.NRO_PARTIDA IS NULL)) OR @NRO_PARTIDA = SS.NRO_PARTIDA)
				and SS.fecha_estado_gt is null
				and SS.estado_gt is null
				
	set @ToleranciaMax= @qtyBO + ((@qtyBO * @ToleranciaMax)/100)
	set @ToleranciaMin= @qtyBO - ((@qtyBO * @ToleranciaMin)/100)
	
	set @TolMax = isnull(@ToleranciaMax,0)
	set @TolMin	= isnull(@ToleranciaMin,0)

END
GO

IF @@ERROR <> 0
BEGIN
   IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION
   INSERT INTO #tmpErrors (Error) SELECT 1
   BEGIN TRANSACTION
END
GO

SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
GO

create procedure [dbo].[Val_Prod_TR_Bulto]      
@CODIGO  varchar(50),    
@PRODUCTO_ID varchar(30) Output,
@CLIENTE_ID VARCHAR(30) OUTPUT
As    
Begin    
	Declare @Count  SmallInt 
	DECLARE @PROD_ENC_POR_EAN	VARCHAR(30)   
	--Set @Cliente='1'    

	Select	@Count=Count(*)    
	from	Producto    
	Where	Producto_Id = @Codigo

	IF (@Count>=1)
	Begin    
		Set @Producto_ID=@Codigo
		SELECT @CLIENTE_ID = CLIENTE_ID FROM PRODUCTO WHERE PRODUCTO_ID = @CODIGO    
	End    

	---  BUSCO POR EAN/DUN  
	If @Count=0    
	BEGIN
		SELECT	@PROD_ENC_POR_EAN = PR.PRODUCTO_ID, @CLIENTE_ID = PR.CLIENTE_ID
		FROM	PRODUCTO Pr
				INNER JOIN RL_PRODUCTO_CODIGOS RPC on (Pr.CLIENTE_ID = RPC.CLIENTE_ID AND Pr.PRODUCTO_ID = RPC.PRODUCTO_ID) 
		WHERE	RPC.CODIGO = @CODIGO
		
		IF @PROD_ENC_POR_EAN IS NOT NULL
			SET @PRODUCTO_ID = @PROD_ENC_POR_EAN
	END

	IF @PRODUCTO_ID IS NULL
		BEGIN
		raiserror('No Existe el producto para el codigo %s',16,1,@codigo)
		END
End
GO

IF @@ERROR <> 0
BEGIN
   IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION
   INSERT INTO #tmpErrors (Error) SELECT 1
   BEGIN TRANSACTION
END
GO

SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[ValidaProductoIngresadoEmpaque]
(@CLIENTE_ID		VARCHAR(15) OUTPUT
,@VIAJE_ID			VARCHAR(100) OUTPUT
,@PRODUCTO_ID		VARCHAR(30) OUTPUT
,@RESULTADO			int OUTPUT
,@NRO_LOTE			VARCHAR(100) OUTPUT
,@NRO_PARTIDA		VARCHAR(100) OUTPUT
,@NRO_SERIE			VARCHAR(50) OUTPUT)
AS
BEGIN
	DECLARE @CANT NUMERIC(20,0)

	SET @CANT=0

	SELECT @CANT = COUNT(*) FROM
		(SELECT	DISTINCT P.PRODUCTO_ID, P.NRO_LOTE, P.NRO_PARTIDA, P.NRO_SERIE
		FROM	PICKING P
		INNER JOIN DET_DOCUMENTO DD ON (P.DOCUMENTO_ID = DD.DOCUMENTO_ID AND P.NRO_LINEA = DD.NRO_LINEA)
		INNER JOIN DOCUMENTO D ON (DD.DOCUMENTO_ID = D.DOCUMENTO_ID)
		WHERE	P.CLIENTE_ID = @CLIENTE_ID
				AND D.NRO_REMITO = @VIAJE_ID
				AND P.PRODUCTO_ID = @PRODUCTO_ID
				AND (P.NRO_LOTE = @NRO_LOTE or @NRO_LOTE='' or @NRO_LOTE IS NULL)
				AND (P.NRO_PARTIDA = @NRO_PARTIDA or @NRO_PARTIDA='' OR @NRO_PARTIDA IS NULL)
				AND (P.NRO_SERIE = @NRO_SERIE or @NRO_SERIE ='' OR @NRO_SERIE IS NULL)
				) X
	IF @CANT=1
		SET @RESULTADO=1
	ELSE
		SET @RESULTADO=0
END
GO

IF @@ERROR <> 0
BEGIN
   IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION
   INSERT INTO #tmpErrors (Error) SELECT 1
   BEGIN TRANSACTION
END
GO

SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[VALIDAR_POSICION_PICKING]
(@POSICION_COD VARCHAR(45),
@OUT VARCHAR(1) OUTPUT)
AS
BEGIN
DECLARE @PICKING VARCHAR(1)
DECLARE @POS_LOCKEADA VARCHAR(1)

SET @OUT = '5'

	IF NOT EXISTS (SELECT 1 FROM POSICION WHERE POSICION_COD = @POSICION_COD)
	BEGIN
		SET @OUT='2'
	END

	IF @OUT<>'2'
	BEGIN
		SELECT @PICKING = ISNULL(PICKING,'0'), @POS_LOCKEADA = ISNULL(POS_LOCKEADA,'0') FROM POSICION WHERE POSICION_COD = @POSICION_COD

		IF @PICKING='0'
		BEGIN
			SET @OUT = '3'
			RETURN
		END

		IF @POS_LOCKEADA='1'
		BEGIN
			SET @OUT = '4'
			RETURN
		END
	END
	ELSE
	BEGIN
		IF NOT EXISTS (SELECT 1 FROM NAVE WHERE NAVE_COD = @POSICION_COD)
		BEGIN
			SET @OUT='2'
			RETURN
		END

		SELECT @PICKING = ISNULL(PICKING,'0') FROM NAVE WHERE NAVE_COD = @POSICION_COD

		IF @PICKING='0'
		BEGIN
			SET @OUT = '3'
			RETURN
		END
	END
SET @OUT = '1'

END
GO

IF @@ERROR <> 0
BEGIN
   IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION
   INSERT INTO #tmpErrors (Error) SELECT 1
   BEGIN TRANSACTION
END
GO

SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[VALIDAR_SERIE_INGRESADA]
(@CLIENTE_ID VARCHAR(15), @PRODUCTO_ID VARCHAR(30),@NRO_SERIE VARCHAR(50),@VIAJE_ID VARCHAR(100), @OUT VARCHAR(1) OUTPUT)
AS
BEGIN

	IF EXISTS (SELECT 1 FROM PICKING WHERE CLIENTE_ID = @CLIENTE_ID AND NRO_SERIE = @NRO_SERIE AND PRODUCTO_ID = @PRODUCTO_ID AND FECHA_FIN IS NOT NULL AND VIAJE_ID = @VIAJE_ID)
		SET @OUT = '0'
	ELSE
		SET @OUT = '1'
END
GO

IF @@ERROR <> 0
BEGIN
   IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION
   INSERT INTO #tmpErrors (Error) SELECT 1
   BEGIN TRANSACTION
END
GO

SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[VERIF_SERIES_CARGADAS]
(@P_DocTransID AS varchar(15) OUTPUT
,@P_Return AS VARCHAR(1) OUTPUT)
AS
DECLARE @DOCUMENTO_ID INT
DECLARE @QTY INT
BEGIN
	
	SELECT TOP 1 @DOCUMENTO_ID = DOCUMENTO_ID FROM DET_DOCUMENTO_TRANSACCION WHERE DOC_TRANS_ID = @P_DocTransID
	SET @QTY = 0

	SELECT @QTY = COUNT(*) FROM DET_DOCUMENTO DD
		INNER JOIN PRODUCTO P ON (P.CLIENTE_ID = DD.CLIENTE_ID AND P.PRODUCTO_ID = DD.PRODUCTO_ID)
	WHERE P.SERIE_ING = '1' AND (DD.NRO_SERIE IS NULL OR DD.NRO_SERIE ='')
		AND DD.DOCUMENTO_ID = @DOCUMENTO_ID
	
	IF @QTY = 0		SET @P_Return ='1'  --CORRECTO
	ELSE			SET @P_Return ='0'	--FALTAN CARGAR SERIES
	
END
GO

IF @@ERROR <> 0
BEGIN
   IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION
   INSERT INTO #tmpErrors (Error) SELECT 1
   BEGIN TRANSACTION
END
GO

SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[verificar_empaque_completado]
(
	@CLIENTE_ID		VARCHAR(15)		OUTPUT
	,@VIAJE_ID		VARCHAR(100)	OUTPUT
	,@RESULTADO		INT				OUTPUT
)
AS
BEGIN

	IF EXISTS
		(SELECT 1 FROM PICKING P
		INNER JOIN DET_DOCUMENTO DD ON (P.DOCUMENTO_ID = DD.DOCUMENTO_ID AND P.NRO_LINEA = DD.NRO_LINEA)
		INNER JOIN DOCUMENTO D ON (DD.DOCUMENTO_ID = D.DOCUMENTO_ID)
		WHERE D.CLIENTE_ID = @CLIENTE_ID AND D.NRO_REMITO = @VIAJE_ID AND P.PALLET_CONTROLADO = '0'
		AND P.CANT_CONFIRMADA > 0)
		SET @RESULTADO = 0
	ELSE
		SET @RESULTADO = 1
END
GO

IF @@ERROR <> 0
BEGIN
   IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION
   INSERT INTO #tmpErrors (Error) SELECT 1
   BEGIN TRANSACTION
END
GO

SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE VERIFICAR_EMPAQUE_INFORMADO_ERP
(
	@CLIENTE_ID		VARCHAR(15)		OUTPUT
	,@VIAJE_ID		VARCHAR(100)	OUTPUT
	,@RETORNO		INT				OUTPUT
)
AS
BEGIN
	IF EXISTS
	(SELECT 1 FROM INFORME_PEDIDOS_EMPAQUE_ERP
	WHERE CLIENTE_ID = @CLIENTE_ID AND VIAJE_ID = @VIAJE_ID)
		SET @RETORNO = 1
	ELSE
		SET @RETORNO = 0
END
GO

IF @@ERROR <> 0
BEGIN
   IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION
   INSERT INTO #tmpErrors (Error) SELECT 1
   BEGIN TRANSACTION
END
GO

EXECUTE [sp_addextendedproperty]
	@name = N'microsoft_database_tools_support',
	@value = 1,
	@level0type = 'SCHEMA',
	@level0name = N'dbo',
	@level1type = 'PROCEDURE',
	@level1name = N'sp_upgraddiagrams'
GO

IF @@TRANCOUNT > 0
BEGIN
   IF EXISTS (SELECT * FROM #tmpErrors)
       ROLLBACK TRANSACTION
   ELSE
       COMMIT TRANSACTION
END
GO

DROP TABLE #tmpErrors
GO